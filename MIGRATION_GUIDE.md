# 新・シフト作成システム 移行ガイド

## 📋 概要

旧システム（GAS単独）から新システム（Python最適化 + GAS連携）への完全移行が完了しました。

## 🔄 アーキテクチャ変更

### **旧システム**
```
Webアプリ → GAS（シフト生成） → Spreadsheet → Calendar
```
- シフト計算: GAS内で完結（グリーディアルゴリズム）
- 制約: 実行時間6分、完全最適化困難

### **新システム**
```
Webアプリ → Drive(CSV) → Colab(Python最適化) → Webhook → GAS → Sheet → Calendar
```
- シフト計算: Python最適化アルゴリズム
- メリット: 実行時間制限なし、高度な最適化が可能

---

## 🚀 初回セットアップ手順

### **Step 1: Driveフォルダ作成**

Google Driveに以下のフォルダ構成を作成してください：

```
シフト管理システム/
├── input/           ← T_休み希望.csv
├── output/          ← シフト結果.csv
└── archive/         ← 過去データ保管
```

各フォルダのIDをメモしてください（URLの `folders/` 以降の文字列）。

### **Step 2: GAS側の設定**

1. スプレッドシートを開く
2. カスタムメニュー「📅 シフト管理」→「⚙️ 設定」→「📁 Drive設定」を実行
3. 各フォルダIDとWebhookトークンを入力

**Webhookトークン:** 任意の文字列（例: `shift-webhook-secret-2025`）
→ Python側と共有するので忘れずにメモしてください。

### **Step 3: GASをWebアプリとしてデプロイ**

1. GASエディタで「デプロイ」→「新しいデプロイ」
2. 種類: Webアプリ
3. アクセス: 全員（アクセス権のあるユーザー）
4. デプロイURL（Webhook URL）をコピー

**重要:** 新しいバージョンをデプロイするたびに、URLが変わる場合があります。

### **Step 4: Python（Colab）側の設定**

1. `colab_integration_sample.py` を Google Colab にアップロード
2. 以下の定数を実際の値に置き換える：

```python
GAS_WEBHOOK_URL = 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec'
WEBHOOK_TOKEN = 'shift-webhook-secret-2025'  # Step 2で設定した値
INPUT_FOLDER_ID = 'YOUR_INPUT_FOLDER_ID'
OUTPUT_FOLDER_ID = 'YOUR_OUTPUT_FOLDER_ID'
```

---

## 📘 運用フロー

### **1. 休み希望提出**

**操作:** 職員がWebアプリにログインして希望日を入力

- 既存の操作と同じ
- 優先順位設定（第1〜第9希望）
- 月間公休上限チェック

### **2. CSV出力**

**操作:** カスタムメニュー「📤 CSV連携」→「📤 休み希望CSV出力」

1. 対象年月を入力（例: `2025/01`）
2. Drive の `input/` フォルダに `T_休み希望_202501.csv` が保存される

### **3. Pythonでシフト計算**

**操作:** Google Colab でシフト計算を実行

1. Colabノートブックを開く
2. セルを実行：
   ```python
   main(2025, 1)  # 年と月を指定
   ```
3. 処理フロー：
   - ① CSV読込（Drive `input/` から）
   - ② シフト計算（Python最適化アルゴリズム）
   - ③ CSV保存（Drive `output/` へ）
   - ④ Webhook通知（GASへ）

4. 出力例：
   ```
   ✅ すべての処理が完了しました！

   次のステップ:
   1. スプレッドシートの「シフト作業用」シートを確認
   2. 必要に応じて手修正
   3. ルールチェックを実行
   4. シフト登録でカレンダーに反映
   ```

### **4. GAS側の自動処理**

Webhook受信後、GASが自動的に：
- CSV取込
- T_確定シフトに保存
- シフト作業用シートに反映（※手修正用）

### **5. 手修正・ルールチェック**

**操作:** スプレッドシートの「シフト作業用」シートで確認・修正

1. シートを開いて内容を確認
2. 必要に応じて手修正
3. カスタムメニュー「✅ ルールチェック」を実行
4. 違反箇所を確認（セルのコメントに表示）

### **6. カレンダー登録**

**操作:** カスタムメニュー「📝 シフト登録」

1. 対象年月を入力
2. 処理対象グループを選択（1,2,3,4,5,6 または ALL）
3. 各職員のGoogleカレンダーに自動反映

---

## 🔧 トラブルシューティング

### **CSV出力エラー**

**エラー:** 「出力するデータがありません」

**原因:** 指定した年月の休み希望が登録されていない

**対処:** Webアプリで休み希望を入力してから再実行

---

### **Webhook通知失敗**

**エラー:** `❌ HTTP Error 401`

**原因:** Webhookトークンの不一致

**対処:**
1. GAS側の設定を確認（M_設定シート or スクリプトプロパティ）
2. Python側の `WEBHOOK_TOKEN` を確認
3. 両者が一致しているか確認

---

### **CSV取込失敗**

**エラー:** 「CSV形式エラー」

**原因:** Python側で出力したCSVの形式が不正

**対処:**
1. `output/` フォルダのCSVを手動でダウンロード
2. ヘッダーが正しいか確認：
   ```
   氏名,グループ,日付,シフト名,開始時間,終了時間
   ```
3. Python側のCSV出力処理を修正

---

### **Drive権限エラー**

**エラー:** 「アクセスが拒否されました」

**原因:** GASまたはPythonのDrive権限が不足

**対処:**
1. GAS: スクリプトエディタで「実行」→「承認」
2. Python: `auth.authenticate_user()` を再実行

---

## 📊 新旧システム比較

| 項目 | 旧システム | 新システム |
|------|-----------|-----------|
| シフト計算 | GAS（グリーディ） | Python（最適化） |
| 実行時間制限 | 6分 | なし |
| 最適化精度 | たたき台レベル | 高精度 |
| 手修正必要性 | 必須 | 最小限 |
| 連携複雑度 | シンプル | やや複雑 |

---

## 🎓 Python最適化アルゴリズムのカスタマイズ

`colab_integration_sample.py` の `calculate_shift()` 関数を編集してください。

**サンプル実装は以下を使用可能:**
- PuLP（線形計画法）
- OR-Tools（制約充足問題）
- 遺伝的アルゴリズム
- その他の最適化ライブラリ

詳細は別途ドキュメント参照。

---

## 📞 サポート

問題が発生した場合は、以下を確認してください：

1. GAS実行ログ（Apps Script Editor → 実行）
2. Colab出力ログ
3. Drive内のCSVファイル
4. M_設定シートの設定値

---

## 📝 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|----------|
| v2.0 | 2025-11-28 | 新システムへ完全移行 |
| v1.0 | 2025-XX-XX | 初版リリース（GAS単独） |
