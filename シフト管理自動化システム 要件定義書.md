# **シフト管理自動化システム 要件定義書**

作成日: 2024/11/27
更新日: 2025/11/28 (v2.0)
作成者: GASの達人

## **1\. プロジェクト概要**

### **1.1 目的**

手書きと手計算で行われているシフト作成業務をデジタル化し、スプレッドシートとGASを用いて自動化・効率化する。従業員の休み希望収集からカレンダーへの登録までを一気通貫で行う。

### **1.2 解決する課題**

* 手書きの休み希望の集計工数の削減。  
* 複雑なシフトルール（資格者配置、連勤制限など）のチェック漏れ防止。  
* シフト作成後の転記作業（カレンダー登録）の自動化。

### **1.3 システム構成**

* **フロントエンド**: Google Apps Script Web App  
  * **SPA (Single Page Application) 方式**を採用。  
  * デザインフレームワーク: **Tailwind CSS** (CDN版)。  
  * カレンダーUI: **FullCalendar.js** 等の軽量ライブラリの使用を推奨。  
* **バックエンド/DB**: Googleスプレッドシート  
* **出力**: Googleカレンダー（6つのグループ別カレンダー）

## **2\. 業務フロー**

1. **提出期間設定**: 管理者がM\_設定にて翌月の「提出受付」を有効化する。  
2. **希望提出**: 従業員がWebアプリにログインし、翌月の「休み希望」を提出・編集する。  
3. **締め切り**: 管理者が受付を終了（ロック）し、以降のWebアプリからの編集を不可にする。  
4. **データ集約**: スプレッドシート(T\_シフト休み希望)に自動蓄積。  
5. **案作成**: 管理者がスプレッドシートのカスタムメニューから「シフト作成」を実行 → GASが素案を作成。  
6. **調整**: 管理者が作業用シート上で手修正。「ルールチェック」機能を使い、違反がないか確認。  
7. **確定・登録**: 管理者が「シフト登録」を実行 → 確定データ保存＆カレンダー反映。

## **3\. 機能要件**

### **A. Webアプリ機能 (SPA構成)**

Webアプリは以下の画面を持つSPAとして実装する。

#### **1\. 共通・認証**

* **ログイン画面**:  
  * ID/PWによる認証を行う。  
  * M\_職員テーブルの「ログインID」「パスワード」「有効フラグ」を参照して認証する。

#### **2\. 一般ユーザー機能 (従業員)**

* **休み希望提出・編集画面**:
  * 対象年月の選択（M\_設定で許可された月のみ選択可能）。
  * カレンダーUIで直感的に希望休を登録・修正できる。
  * **優先順位設定**: 各休み希望に対して優先順位（第1希望〜第9希望）を設定可能。
    * カレンダーで日付を選択後、一覧表で各日付の優先順位を編集可能。
    * 同じ日に複数人の希望が重複した場合、優先順位が高い方を優先的に割り当て。
  * **月間公休上限チェック**: 保存時に月間公休日数の上限を超えていないかチェック。
  * **ロック制御**: 管理者側で「締め切り」設定されている場合は、閲覧のみ可能とし編集・保存ボタンを非活性化する。

#### **3\. 管理者機能**

* **職員マスタ管理画面**:  
  * M\_職員データのCRUD操作。  
* **シフトマスタ管理画面**:  
  * M\_シフトデータの編集。

### **B. スプレッドシート機能 (管理者用・シフト作業)**

* **UIデザイン**: ガントチャート形式（横軸：日付、縦軸：氏名）。
* **カスタムメニュー**:
  1. **シフト案作成**: 対象年月を入力すると、月間公休日数をM\_設定シートから自動取得し、シフト案を生成。
     * 月間公休日数は `MONTHLY_HOLIDAYS_YYYYMM` 形式のキーで設定シートから取得（例: `MONTHLY_HOLIDAYS_202501 = 9`）。
     * 設定が見つからない場合はデフォルト9日を使用。
     * ※アルゴリズムは「完全最適化」ではなく、「たたき台作成」レベル（手修正前提）。
  2. **ルールチェック**: ルール違反箇所のハイライト表示。
  3. **シフト登録**: 確定データのDB保存＋カレンダー連携。

### **C. カレンダー連携機能**

* **グループ分割登録**: 所属グループに対応した6つのカレンダーへ書き込み。  
* **イベント内容**: タイトル「【略称】氏名」、日時（シフトマスタ参照）、終日フラグ制御。  
* **更新ロジック (重要)**:  
  * 新規登録時は発行されたEventIDをT\_確定シフトに保存する。  
  * 既にEventIDが存在する場合は、そのIDに対してGoogle Calendar APIのupdateを実行する。  
  * deleteが必要な場合（シフト削除時）は、該当IDのイベントを削除する。

## **4\. シフト作成・チェックルール（ロジック詳細）**

### **4.1 シフト作成アルゴリズム（3段階処理）**

シフト案作成は以下の3段階で処理を行う：

#### **STEP1: 月間公休日数の割り当て（優先順位調整付き）**

**目的**: 各スタッフの休み希望を優先順位順に割り当て、月間公休日数を確保する。

**処理内容**:
1. 各スタッフの休み希望をT\_シフト休み希望テーブルから取得
2. 優先順位でソート（数値が小さい順 = 第1希望→第2希望→...）
3. 優先順位が高い順にループ：
   - 既に月間公休日数に達していたら中断
   - 該当日が既に埋まっていたらスキップ
   - 「休み」を割り当ててカウンターをインクリメント

**制約**:
- 各スタッフの休み割り当て数 ≤ 月間公休日数（例: 9日）
- 該当日のセルが空であること

**具体例**:
- Aさんの休み希望: 1/1(第1希望), 1/2(第2希望), ..., 1/25(第25希望)
- 月間公休日数 = 9日の場合
- 結果: 第1〜第9希望まで割り当て、第10希望以降は無視

**優先順位による競合解決**:
- Aさん: 12/1(第1希望), 12/2(第2希望), 12/3(第3希望)
- Bさん: 12/1(第2希望), 12/2(第1希望), 12/3(第3希望)
- 結果:
  - 12/1 → Aさん優先（第1希望 vs 第2希望）
  - 12/2 → Bさん優先（第2希望 vs 第1希望）
  - 12/3 → 両方第3希望で同順位（処理順による）

#### **STEP2: 資格者の夜勤割り当て**

**目的**: 全日に最低1名の喀痰吸引資格者の夜勤を配置する。

**処理内容**:
1. 資格者リストを抽出（条件: 喀痰吸引資格者 = TRUE かつ 勤務配慮 ≠ TRUE）
2. 全日をループ（1日〜月末まで）：
   - 資格者リストから順番に割り当て可能かチェック
   - 最初に割り当てできた資格者に「夜勤」を割り当て
   - 1名割り当てたら次の日へ

**割り当て可能条件**（後述の制約チェック関数を使用）:
- 該当日のセルが空
- 連勤制限OK（5連勤以内）
- 月間勤務日数上限OK（21日以内、夜勤は2日分換算）
- インターバルルールOK（遅出→早出禁止）
- 夜勤明けルールOK（夜勤→休→休）

**警告**:
- どの資格者も割り当てできない日があった場合は警告ログを出力

#### **STEP3: 残りシフトの割り当て**

**目的**: グループごとに最低人数要件を満たすようシフトを割り当てる。

**処理内容**:
1. スタッフをグループ1〜6に分類
2. 全日をループ（1日〜月末まで）：
   - 日曜日判定
   - 各グループ（1〜6）ごとに以下を実行：
     - **夜勤**: 既に1名以上いたらスキップ、いなければ1名割り当て
     - **早出**: 2名割り当て
     - **日勤**: 1名割り当て（日曜は0名OK）
     - **遅出**: 1名割り当て

**グループごとの最低人数要件**:
- 夜勤: 1名以上
- 早出: 2名以上
- 日勤: 1名以上（日曜は0名OK）
- 遅出: 1名以上

**割り当て処理**:
- グループメンバーを順番に確認
- セルが空かつ制約チェックOKなら割り当て
- 必要人数に達したら次のシフト種別へ

#### **最終処理: 空白セルの処理**

**目的**: すべての空白セルを埋める。

**処理内容**:
1. 各スタッフの現在の休み数をカウント
2. 空白セルを処理：
   - **公休数に達していない場合**: 「休み」を割り当て
   - **公休数に達している場合**: 「日勤」を割り当て（デフォルトシフト）
3. 最終的な休み日数が設定と異なる場合は警告ログを出力

**重要**:
- 公休数に達した後の「日勤」割り当ては制約チェックを無視する
- ルール違反（連勤制限、月間勤務日数上限など）が発生する可能性がある
- シフト案出力後に手作業で修正する前提

### **4.2 制約チェックロジック（canAssignShift関数）**

シフト割り当て時に以下の制約を**すべて**チェック：

#### **1. セルが空であること**
- 該当日に既にシフトが割り当てられていないこと

#### **2. 勤務配慮者は夜勤不可**
- 「勤務配慮」フラグがTRUEのスタッフには夜勤を割り当てない

#### **3. 連勤制限（5連勤以内）**
- 前日から遡って連続勤務日数をカウント
- 連続5日以上の場合は割り当て不可
- **例**: 1/1〜1/5が勤務（5連勤） → 1/6は割り当て不可

#### **4. 月間勤務日数上限（21日以内）**
- 既存の勤務日数を集計：
  - 夜勤: 2日分
  - 早出/日勤/遅出: 1日分
- 今日のシフトを加算して21日以内であること
- **例**: 既に夜勤10回（20日分） → 今日早出なら21日（OK）、今日夜勤なら22日（NG）

#### **5. インターバルルール（遅出→早出禁止）**
- 前日が遅出で、今日が早出の場合は割り当て不可
- **理由**: 遅出20:00終業 → 早出07:00開始だと休息時間が短すぎる

#### **6. 夜勤明けルール（夜勤→休→休）**
- 前日が夜勤の場合、今日は休み必須
- 前々日が夜勤の場合、今日も休み必須
- 今日が夜勤の場合、前日が夜勤でないこと
- **例**: 1/10夜勤 → 1/11必ず休み → 1/12必ず休み → 1/13勤務可能

### **4.3 ルールチェック機能（違反検知）**

**特に「チェック機能」における違反検知を最優先とする。**

#### **グループ単位の最低人数ルール**
1. **早出**: 2名以上
2. **日勤**: 1名以上（日曜は0名OK）
3. **遅出**: 1名以上
4. **夜勤**: 1名以上

#### **個人単位の労働規定・禁止事項**
5. **休み希望**: 優先順位に基づいて割り当て（完全保証ではない）
6. **連勤制限**: 連続5日まで（6連勤以上でエラー）
7. **インターバル**: 遅出→翌日早出は禁止
8. **勤務日数上限**: 月21日以内（夜勤は1回2日分換算）
9. **夜勤明け**: 夜勤→休→休（翌日・翌々日は休み）
10. **属性免除**: 「勤務配慮」ありのスタッフは夜勤免除

#### **グループ横断の全体ルール**
11. **資格者配置**: 全日に「喀痰吸引資格者」が最低1名いること

## **5\. データベース設計 (シート構成)**

### **① T\_シフト休み希望**

| No | 列名 | 型 | 備考 |
| :---- | :---- | :---- | :---- |
| 1 | シフト休み希望ID | Text | Key |
| 2 | 氏名 | Ref |  |
| 3 | 提出日時 | DateTime |  |
| 4 | 日付 | Date | 希望日 |
| 5 | 優先順位 | Number | 1〜9（数値が小さいほど優先度が高い） |
| 6 | 特記事項 | LongText |  |

### **② M\_シフト**

| No | 列名 | 型 | 備考 |
| :---- | :---- | :---- | :---- |
| 6 | シフトID | Text | Key |
| 7 | シフト名 | Text | 早出,日勤,遅出,夜勤,休み |
| 8 | 開始時間 | Time |  |
| 9 | 終了時間 | Time |  |
| 10 | 備考 | LongText |  |

### **③ M\_職員**

| No | 列名 | 型 | 備考 |
| :---- | :---- | :---- | :---- |
| 11 | 職員ID | Text | Key |
| 12 | 所属 | Text |  |
| 13 | 役職 | Text | 管理者権限判定に使用 |
| 14 | グループ | Enum | 1\~6 |
| 15 | カレンダーID | Text |  |
| 16 | ユニット | Text |  |
| 17 | 氏名 | Text |  |
| 18 | 雇用形態 | Enum | 常勤,パート |
| 19 | 喀痰吸引資格者 | Bool |  |
| 20 | 勤務配慮 | Bool |  |
| 21 | 有効 | Bool | ログイン制御 |
| 22 | ログインID | Text | 一意制約 |
| 23 | パスワード | Text | Webアプリ用 |

### **④ T\_確定シフト**

| No | 列名 | 型 | 備考 |
| :---- | :---- | :---- | :---- |
| 24 | 確定シフトID | Text | Key |
| 25 | 氏名 | Ref |  |
| 26 | グループ | Enum |  |
| 27 | 日付 | Date |  |
| 28 | シフト名 | Text |  |
| 29 | 開始時間 | Time |  |
| 30 | 終了時間 | Time |  |
| 31 | 登録日時 | DateTime |  |
| 32 | **カレンダーイベントID** | Text | Googleカレンダー連携用Key (追加) |

### **⑤ M\_設定 (設定マスタ)**

| No | 列名 | 型 | 備考 |
| :---- | :---- | :---- | :---- |
| 33 | 設定ID | Text | 設定キー |
| 34 | 設定値 | Text | 設定値 |

**主要な設定キー**:
- `SUBMISSION_LOCK_YYYYMM`: 休み希望提出のロック状態（TRUE/FALSE）
- `MONTHLY_HOLIDAYS_YYYYMM`: 月間公休日数（例: 9）
  - シフト案作成時に自動的に参照される
  - 例: `MONTHLY_HOLIDAYS_202501 = 9` → 2025年1月の公休日数は9日
  - 設定が見つからない場合はデフォルト9日を使用

## **6\. 技術要件・非機能要件**

### **6.1 アーキテクチャ**

* **SPA (Single Page Application)**:  
  * 初回ロード(doGet)で単一のHTML(index.html)を返し、以降はJavaScriptによるDOM操作で画面遷移を実現する。  
  * サーバー通信は google.script.run を非同期で使用する。

### **6.2 デザイン・UI**

* **Tailwind CSS**:  
  * CDNリンクをHTMLヘッダーに埋め込み、ユーティリティクラスベースでスタイリングを行う。  
  * モバイルファーストでレスポンシブデザインとする。

### **6.3 ログ・デバッグ**

* **ログ出力**:  
  * サーバーサイド処理の開始・終了、エラー発生時には必ず console.log または console.error を出力する。  
  * これによりGCPコンソール（Apps Scriptダッシュボード）の「実行数」ログでトレース可能にする。  
  * エラー時はスタックトレースも含めて記録する。

### **6.4 設定管理**

* **スクリプトプロパティ**:  
  * スプレッドシートID、管理者メールアドレス等の環境依存値はコードに直書きせず、PropertiesService.getScriptProperties() で管理する。

### **6.5 セキュリティ**

* **Webアプリ公開設定**:  
  * Execute as: **Me (管理者)**  
  * Who has access: **Anyone (全員)**  
* **アプリケーション認証**:  
  * Webアプリ側で独自ログイン画面を設け、ID/PW認証を通過しない限り機能にアクセスさせない。