# **シフト管理自動化システム 要件定義書**

作成日: 2024/11/27  
更新日: 2025/11/27 (v1.5)  
作成者: GASの達人

## **1\. プロジェクト概要**

### **1.1 目的**

手書きと手計算で行われているシフト作成業務をデジタル化し、スプレッドシートとGASを用いて自動化・効率化する。従業員の休み希望収集からカレンダーへの登録までを一気通貫で行う。

### **1.2 解決する課題**

* 手書きの休み希望の集計工数の削減。  
* 複雑なシフトルール（資格者配置、連勤制限など）のチェック漏れ防止。  
* シフト作成後の転記作業（カレンダー登録）の自動化。

### **1.3 システム構成**

* **フロントエンド**: Google Apps Script Web App  
  * **SPA (Single Page Application) 方式**を採用。  
  * デザインフレームワーク: **Tailwind CSS** (CDN版)。  
  * カレンダーUI: **FullCalendar.js** 等の軽量ライブラリの使用を推奨。  
* **バックエンド/DB**: Googleスプレッドシート  
* **出力**: Googleカレンダー（6つのグループ別カレンダー）

## **2\. 業務フロー**

1. **提出期間設定**: 管理者がM\_設定にて翌月の「提出受付」を有効化する。  
2. **希望提出**: 従業員がWebアプリにログインし、翌月の「休み希望」を提出・編集する。  
3. **締め切り**: 管理者が受付を終了（ロック）し、以降のWebアプリからの編集を不可にする。  
4. **データ集約**: スプレッドシート(T\_シフト休み希望)に自動蓄積。  
5. **案作成**: 管理者がスプレッドシートのカスタムメニューから「シフト作成」を実行 → GASが素案を作成。  
6. **調整**: 管理者が作業用シート上で手修正。「ルールチェック」機能を使い、違反がないか確認。  
7. **確定・登録**: 管理者が「シフト登録」を実行 → 確定データ保存＆カレンダー反映。

## **3\. 機能要件**

### **A. Webアプリ機能 (SPA構成)**

Webアプリは以下の画面を持つSPAとして実装する。

#### **1\. 共通・認証**

* **ログイン画面**:  
  * ID/PWによる認証を行う。  
  * M\_職員テーブルの「ログインID」「パスワード」「有効フラグ」を参照して認証する。

#### **2\. 一般ユーザー機能 (従業員)**

* **休み希望提出・編集画面**:  
  * 対象年月の選択（M\_設定で許可された月のみ選択可能）。  
  * カレンダーUIで直感的に希望休を登録・修正できる。  
  * **ロック制御**: 管理者側で「締め切り」設定されている場合は、閲覧のみ可能とし編集・保存ボタンを非活性化する。

#### **3\. 管理者機能**

* **職員マスタ管理画面**:  
  * M\_職員データのCRUD操作。  
* **シフトマスタ管理画面**:  
  * M\_シフトデータの編集。

### **B. スプレッドシート機能 (管理者用・シフト作業)**

* **UIデザイン**: ガントチャート形式（横軸：日付、縦軸：氏名）。  
* **カスタムメニュー**:  
  1. **シフト案作成**: 希望休反映＋最低人数確保ロジック実行。  
     * ※アルゴリズムは「完全最適化」ではなく、ランダム配置による「たたき台作成」レベルでよい（手修正前提）。  
  2. **ルールチェック**: ルール違反箇所のハイライト表示。  
  3. **シフト登録**: 確定データのDB保存＋カレンダー連携。

### **C. カレンダー連携機能**

* **グループ分割登録**: 所属グループに対応した6つのカレンダーへ書き込み。  
* **イベント内容**: タイトル「【略称】氏名」、日時（シフトマスタ参照）、終日フラグ制御。  
* **更新ロジック (重要)**:  
  * 新規登録時は発行されたEventIDをT\_確定シフトに保存する。  
  * 既にEventIDが存在する場合は、そのIDに対してGoogle Calendar APIのupdateを実行する。  
  * deleteが必要な場合（シフト削除時）は、該当IDのイベントを削除する。

## **4\. シフト作成・チェックルール（ロジック詳細）**

GASは以下のルールを適用する。**特に「チェック機能」における違反検知を最優先とする。**

### **4.1 基本ルール（グループ単位）**

1. **早出**: 2名以上  
2. **日勤**: 1名以上（日曜は0名OK）  
3. **遅出**: 1名以上  
4. **夜勤**: 1名以上

### **4.2 労働規定・禁止事項（個人単位）**

5. **休み希望**: 月3～4日程度を優先。  
6. **連勤制限**: 連続5日まで（6連勤以上でエラー）。  
7. **インターバル**: 遅出→翌日早出は禁止。  
8. **勤務日数上限**: 月21日以内（夜勤は1回2日分換算）。  
9. **夜勤明け**: 夜勤→休→休（翌日・翌々日は休み）。  
10. **属性免除**: 「勤務配慮」ありのスタッフは夜勤免除。

### **4.3 全体ルール（グループ横断）**

11. **資格者配置**: 全グループの夜勤担当者の中に「喀痰吸引資格者」が最低1名いること。

## **5\. データベース設計 (シート構成)**

### **① T\_シフト休み希望**

| No | 列名 | 型 | 備考 |
| :---- | :---- | :---- | :---- |
| 1 | シフト休み希望ID | Text | Key |
| 2 | 氏名 | Ref |  |
| 3 | 提出日時 | DateTime |  |
| 4 | 日付 | Date | 希望日 |
| 5 | 特記事項 | LongText |  |

### **② M\_シフト**

| No | 列名 | 型 | 備考 |
| :---- | :---- | :---- | :---- |
| 6 | シフトID | Text | Key |
| 7 | シフト名 | Text | 早出,日勤,遅出,夜勤,休み |
| 8 | 開始時間 | Time |  |
| 9 | 終了時間 | Time |  |
| 10 | 備考 | LongText |  |

### **③ M\_職員**

| No | 列名 | 型 | 備考 |
| :---- | :---- | :---- | :---- |
| 11 | 職員ID | Text | Key |
| 12 | 所属 | Text |  |
| 13 | 役職 | Text | 管理者権限判定に使用 |
| 14 | グループ | Enum | 1\~6 |
| 15 | カレンダーID | Text |  |
| 16 | ユニット | Text |  |
| 17 | 氏名 | Text |  |
| 18 | 雇用形態 | Enum | 常勤,パート |
| 19 | 喀痰吸引資格者 | Bool |  |
| 20 | 勤務配慮 | Bool |  |
| 21 | 有効 | Bool | ログイン制御 |
| 22 | ログインID | Text | 一意制約 |
| 23 | パスワード | Text | Webアプリ用 |

### **④ T\_確定シフト**

| No | 列名 | 型 | 備考 |
| :---- | :---- | :---- | :---- |
| 24 | 確定シフトID | Text | Key |
| 25 | 氏名 | Ref |  |
| 26 | グループ | Enum |  |
| 27 | 日付 | Date |  |
| 28 | シフト名 | Text |  |
| 29 | 開始時間 | Time |  |
| 30 | 終了時間 | Time |  |
| 31 | 登録日時 | DateTime |  |
| 32 | **カレンダーイベントID** | Text | Googleカレンダー連携用Key (追加) |

### **⑤ M\_設定 (設定マスタ)**

| No | 列名 | 型 | 備考 |
| :---- | :---- | :---- | :---- |
| 33 | 設定ID | Text | SUBMISSION\_LOCK\_YYYYMM 等 |
| 34 | 設定値 | Text | TRUE/FALSE 等 |

## **6\. 技術要件・非機能要件**

### **6.1 アーキテクチャ**

* **SPA (Single Page Application)**:  
  * 初回ロード(doGet)で単一のHTML(index.html)を返し、以降はJavaScriptによるDOM操作で画面遷移を実現する。  
  * サーバー通信は google.script.run を非同期で使用する。

### **6.2 デザイン・UI**

* **Tailwind CSS**:  
  * CDNリンクをHTMLヘッダーに埋め込み、ユーティリティクラスベースでスタイリングを行う。  
  * モバイルファーストでレスポンシブデザインとする。

### **6.3 ログ・デバッグ**

* **ログ出力**:  
  * サーバーサイド処理の開始・終了、エラー発生時には必ず console.log または console.error を出力する。  
  * これによりGCPコンソール（Apps Scriptダッシュボード）の「実行数」ログでトレース可能にする。  
  * エラー時はスタックトレースも含めて記録する。

### **6.4 設定管理**

* **スクリプトプロパティ**:  
  * スプレッドシートID、管理者メールアドレス等の環境依存値はコードに直書きせず、PropertiesService.getScriptProperties() で管理する。

### **6.5 セキュリティ**

* **Webアプリ公開設定**:  
  * Execute as: **Me (管理者)**  
  * Who has access: **Anyone (全員)**  
* **アプリケーション認証**:  
  * Webアプリ側で独自ログイン画面を設け、ID/PW認証を通過しない限り機能にアクセスさせない。