# シフト管理自動化システム 導入手順書

**作成日**: 2025年11月27日
**更新日**: 2025年11月27日 (v2.0 - 修正版)
**対象者**: システム管理者、導入担当者
**所要時間**: 約1～2時間

---

## 📋 目次

1. [システム概要](#システム概要)
2. [前提条件](#前提条件)
3. [導入手順](#導入手順)
4. [初期データ登録](#初期データ登録)
5. [動作確認](#動作確認)
6. [トラブルシューティング](#トラブルシューティング)

---

## システム概要

本システムは、Google Apps Script (GAS) とGoogleスプレッドシートを使用したシフト管理自動化システムです。

### 主な機能
- 従業員による休み希望のWeb提出
- シフト案の自動生成
- 11個のシフトルールチェック
- Googleカレンダーへの自動登録

### システム構成
- **フロントエンド**: GAS Webアプリ（SPA）
- **バックエンド**: Google Apps Script（スプレッドシートバインド型）
- **データベース**: Googleスプレッドシート
- **カレンダー**: Googleカレンダー（6グループ分）

---

## 前提条件

### 必要なもの

#### 1. Googleアカウント
- **管理者用アカウント**: 1つ（システム管理者用）
- **要件**: Google Workspace アカウント推奨（無料のGmailアカウントでも可）

#### 2. 必要な権限
- Google スプレッドシートの作成権限
- Google カレンダーの作成・共有権限
- Google Apps Script の実行権限

#### 3. 準備する情報
- 職員リスト（氏名、役職、グループ、雇用形態など）
- 各職員のログインID・パスワード
- グループ構成（1～6のグループ分け）

#### 4. 推奨環境
- PC（Windows/Mac）
- Google Chrome または Microsoft Edge ブラウザ
- インターネット接続

---

## 導入手順

### ステップ1: Googleカレンダーの準備

グループごとにカレンダーを作成します。

#### 1-1. カレンダーを作成（6個）

1. [Googleカレンダー](https://calendar.google.com/) を開く
2. 左側メニューの「他のカレンダー」の「+」をクリック
3. 「新しいカレンダーを作成」を選択
4. 以下の情報を入力：
   - **名前**: `シフト - グループ1`
   - **説明**: `グループ1のシフト`
   - **タイムゾーン**: `(GMT+09:00) 日本標準時 - 東京`
5. 「カレンダーを作成」をクリック
6. グループ2～6についても同様に作成

#### 1-2. カレンダーIDを取得

各カレンダーについて以下の手順でカレンダーIDを取得します：

1. Googleカレンダーで作成したカレンダー名をクリック
2. 「設定と共有」をクリック
3. 下にスクロールして「カレンダーの統合」セクションを表示
4. **「カレンダーID」** をコピー（例: `abc123@group.calendar.google.com`）
5. メモ帳などに6つ全てのカレンダーIDを記録

```
グループ1: abc123@group.calendar.google.com
グループ2: def456@group.calendar.google.com
グループ3: ghi789@group.calendar.google.com
グループ4: jkl012@group.calendar.google.com
グループ5: mno345@group.calendar.google.com
グループ6: pqr678@group.calendar.google.com
```

---

### ステップ2: Googleスプレッドシートの作成

#### 2-1. 新規スプレッドシートを作成

1. [Google Drive](https://drive.google.com/) を開く
2. 「+ 新規」→「Googleスプレッドシート」→「空白のスプレッドシート」
3. タイトルを「**シフト管理システム**」に変更（重要！）
4. このスプレッドシートは閉じないでください

---

### ステップ3: Google Apps Scriptプロジェクトの作成

**重要**: スプレッドシートから直接GASプロジェクトを開きます。

#### 3-1. スプレッドシートからGASを開く

1. **ステップ2で作成したスプレッドシートを開いた状態で**、メニューから以下を選択：
   ```
   拡張機能 → Apps Script
   ```

2. 新しいタブでGASエディタが開きます

3. プロジェクト名を「**シフト管理システム**」に変更
   - 上部の「無題のプロジェクト」をクリックして名前を変更

#### 3-2. デフォルトの Code.gs を削除

1. 最初から存在する `Code.gs` の内容を **全て削除** してください
2. 空の状態にします

---

### ステップ4: ソースコードのコピー

GitHubリポジトリから以下のファイルを **順番通りに** コピーします。

#### 4-1. Config.gs を追加

1. GASエディタで「ファイル」の「+」をクリック
2. 「スクリプト」を選択
3. ファイル名を `Config` に変更
4. GitHubの `Config.gs` の内容を全てコピー＆ペースト
5. **Ctrl+S** (Mac: **Cmd+S**) で保存

#### 4-2. DataService.gs を追加

同様の手順で `DataService.gs` を追加

#### 4-3. AuthService.gs を追加

同様の手順で `AuthService.gs` を追加

#### 4-4. ShiftService.gs を追加

同様の手順で `ShiftService.gs` を追加

#### 4-5. CalendarService.gs を追加

同様の手順で `CalendarService.gs` を追加

#### 4-6. Code.gs を追加

1. 「ファイル」の「+」をクリック
2. 「スクリプト」を選択
3. ファイル名を `Code` に変更
4. GitHubの `Code.gs` の内容を全てコピー＆ペースト
5. 保存

#### 4-7. index.html を追加

1. 「ファイル」の「+」をクリック
2. 「HTML」を選択
3. ファイル名を `index` に変更
4. GitHubの `index.html` の内容を全てコピー＆ペースト
5. 保存

**確認**: 左側のファイル一覧に以下の7ファイルが表示されているはずです：
- Config.gs
- DataService.gs
- AuthService.gs
- ShiftService.gs
- CalendarService.gs
- Code.gs
- index.html

---

### ステップ5: 権限の承認

#### 5-1. 初回実行と権限承認

1. GASエディタで `Code.gs` を開く
2. 上部の関数選択ドロップダウンから `initializeAllSheets` を選択
3. 「実行」ボタン（▶️）をクリック
4. 「承認が必要です」というダイアログが表示されます
5. 「権限を確認」をクリック
6. Googleアカウントを選択
7. 「このアプリは確認されていません」と表示されたら：
   - **「詳細」** をクリック
   - **「シフト管理システム（安全ではないページ）に移動」** をクリック
8. 権限の一覧が表示されます：
   - Google スプレッドシートの表示、編集、作成、削除
   - Google カレンダーの表示と編集
   - 外部サービスへの接続
9. **「許可」** をクリック

#### 5-2. 初期化の実行

1. 権限承認後、再度 `initializeAllSheets` を実行
2. 実行ログに「初期設定が完了しました！」と表示されればOK
3. スプレッドシートに戻り、以下のシートが作成されていることを確認：
   - ✅ `M_職員` - 職員マスタ
   - ✅ `M_シフト` - シフトマスタ（デフォルトシフト付き）
   - ✅ `T_シフト休み希望` - 休み希望データ
   - ✅ `T_確定シフト` - 確定シフトデータ
   - ✅ `M_設定` - 設定マスタ

**確認**: `M_シフト` シートに5つのデフォルトシフトが登録されているか確認

| シフトID | シフト名 | 開始時間 | 終了時間 | 備考 |
|---------|---------|---------|---------|-----|
| SHIFT_HAYADE | 早出 | 07:00 | 16:00 | |
| SHIFT_NIKKIN | 日勤 | 09:00 | 18:00 | |
| SHIFT_OSODE | 遅出 | 11:00 | 20:00 | |
| SHIFT_YAKIN | 夜勤 | 17:00 | 09:00 | 翌朝まで |
| SHIFT_YASUMI | 休み | | | |

---

### ステップ6: Webアプリのデプロイ

#### 6-1. デプロイ設定

1. GASエディタ右上の「**デプロイ**」→「**新しいデプロイ**」をクリック
2. 「**種類の選択**」で「⚙️ **Webアプリ**」を選択
3. 以下のように設定：

```
説明: シフト管理システム v1.0
次のユーザーとして実行: 自分（あなたのメールアドレス）
アクセスできるユーザー: 全員
```

4. 「**デプロイ**」をクリック
5. 「**ウェブアプリのURL**」が表示されるのでコピー

```
例: https://script.google.com/macros/s/AKfycbyXXXXXXXXXXX/exec
```

6. このURLをメモ帳に保存（従業員に配布するURL）

#### 6-2. デプロイの確認

1. コピーしたURLをブラウザの新しいタブで開く
2. ログイン画面が表示されればOK
3. まだログインはできません（職員データ未登録のため）

**注意**: 初回アクセス時に再度権限承認を求められる場合があります。その場合は同様に「許可」してください。

---

## 初期データ登録

### ステップ7: 管理者アカウントの登録

まず、システム管理者のアカウントを登録します。

#### 7-1. スプレッドシートで直接登録

1. スプレッドシートの `M_職員` シートを開く
2. 2行目（ヘッダーの次の行）に以下のデータを入力：

| A列 | B列 | C列 | D列 | E列 | F列 | G列 | H列 | I列 | J列 | K列 | L列 | M列 |
|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
| 職員ID | 所属 | 役職 | グループ | カレンダーID | ユニット | 氏名 | 雇用形態 | 喀痰吸引資格者 | 勤務配慮 | 有効 | ログインID | パスワード |
| STAFF_001 | 本部 | **管理者** | 1 | (グループ1のカレンダーID) | A棟 | 山田太郎 | 常勤 | TRUE | FALSE | **TRUE** | admin | admin123 |

**重要な入力項目**:
- **C列（役職）**: 必ず「管理者」「施設長」「主任」「リーダー」のいずれかを含める
- **K列（有効）**: 必ず `TRUE` に設定
- **E列（カレンダーID）**: ステップ1で取得したグループ1のカレンダーIDを入力

**例**:
```
A2: STAFF_001
B2: 本部
C2: 管理者
D2: 1
E2: abc123@group.calendar.google.com
F2: A棟
G2: 山田太郎
H2: 常勤
I2: TRUE
J2: FALSE
K2: TRUE
L2: admin
M2: admin123
```

#### 7-2. 管理者アカウントでログイン

1. Webアプリを開く
2. 以下でログイン：
   - **ログインID**: `admin`
   - **パスワード**: `admin123`
3. ログインできればOK
4. 「職員マスタ管理」や「シフトマスタ管理」のメニューが表示されることを確認

---

### ステップ8: 全職員データの登録

#### 8-1. Webアプリから登録（推奨）

1. Webアプリに管理者アカウントでログイン
2. 上部メニューの「**職員マスタ管理**」をクリック
3. 「**+ 新規追加**」ボタンをクリック
4. 職員情報を入力：
   - **職員ID**: `STAFF_002`（自動生成される）
   - **氏名**: 職員名を入力
   - **役職**: 役職を入力
   - **グループ**: 1～6を選択
   - **雇用形態**: 常勤/パートを選択
   - **ログインID**: ユニークなIDを入力
   - **パスワード**: 初期パスワードを入力
   - **カレンダーID**: ステップ1で取得したグループのカレンダーIDを入力
   - **喀痰吸引資格者**: 該当する場合はチェック
   - **勤務配慮**: 該当する場合はチェック
   - **有効**: チェック
5. 「**保存**」をクリック
6. 全職員について繰り返す

#### 8-2. スプレッドシートから一括登録

多数の職員を登録する場合は、スプレッドシートに直接入力する方が効率的です：

1. Excelで職員リストを作成
2. `M_職員` シートの3行目以降にコピー＆ペースト
3. データ形式に注意：
   - **グループ**: 数値（1～6）
   - **喀痰吸引資格者**: TRUE/FALSE
   - **勤務配慮**: TRUE/FALSE
   - **有効**: TRUE/FALSE

---

### ステップ9: スプレッドシートのカスタムメニュー確認

1. スプレッドシートを一度閉じて再度開く
2. メニューバーに「**📅 シフト管理**」が表示されることを確認
3. クリックして以下のメニューが表示されることを確認：
   - 🌐 Webアプリを開く
   - ✨ シフト案作成
   - ✅ ルールチェック
   - 📝 シフト登録
   - 🔧 初期設定

**表示されない場合**:
- ブラウザを更新（F5キー）
- スプレッドシートを閉じて再度開く
- GASエディタで `onOpen` 関数を手動実行

---

### ステップ10: 提出期間設定

従業員が休み希望を提出できる月を設定します。

#### 10-1. 設定値の登録

1. スプレッドシートの `M_設定` シートを開く
2. 2行目（ヘッダーの次の行）に以下を追加：

**例: 2025年1月の休み希望を受付**

| A列（設定ID） | B列（設定値） |
|--------------|-------------|
| SUBMISSION_LOCK_202501 | FALSE |

- `SUBMISSION_LOCK_YYYYMM` の形式で設定ID を作成
- `FALSE`: 提出受付中
- `TRUE`: 締め切り（閲覧のみ）

#### 10-2. 複数月の設定例

```
A2: SUBMISSION_LOCK_202501    B2: FALSE   (2025年1月: 受付中)
A3: SUBMISSION_LOCK_202502    B3: FALSE   (2025年2月: 受付中)
A4: SUBMISSION_LOCK_202412    B4: TRUE    (2024年12月: 締め切り済み)
```

---

## 動作確認

### ステップ11: 機能テスト

#### 11-1. ログイン機能のテスト

1. Webアプリを開く
2. 一般職員のアカウントでログイン
3. ログイン成功を確認
4. ログアウト
5. 管理者アカウントでログイン
6. 管理者メニューが表示されることを確認

#### 11-2. 休み希望提出のテスト

1. 一般職員アカウントでログイン
2. 「休み希望提出」画面を開く（自動的に表示される）
3. 対象月を選択（設定で許可した月）
4. カレンダーから複数の日付をクリック
5. 特記事項を入力
6. 「保存」をクリック
7. スプレッドシートの `T_シフト休み希望` シートにデータが保存されていることを確認

#### 11-3. 職員マスタ管理のテスト

1. 管理者アカウントでログイン
2. 「職員マスタ管理」を開く
3. 登録した職員が一覧表示されることを確認
4. 「編集」ボタンで職員情報を編集
5. 変更が保存されることを確認

#### 11-4. シフト作成機能のテスト

1. スプレッドシートを開く
2. メニューから「**📅 シフト管理**」→「**✨ シフト案作成**」
3. 対象年月を入力（例: `2025/01`）
4. 「OK」をクリック
5. `シフト作業用` シートが作成され、シフト案が生成されることを確認
6. 休み希望が反映されていることを確認

#### 11-5. ルールチェック機能のテスト

1. `シフト作業用` シートで一部のシフトを手修正
2. わざと違反を作成（例: 6連勤、遅出→翌日早出など）
3. メニューから「**📅 シフト管理**」→「**✅ ルールチェック**」
4. 対象年月を入力
5. 違反箇所が赤くハイライトされることを確認
6. ダイアログに違反内容が表示されることを確認

#### 11-6. カレンダー登録のテスト

1. シフト作業用シートでシフトを調整
2. ルールチェックでエラーがない状態にする
3. メニューから「**📅 シフト管理**」→「**📝 シフト登録**」
4. 対象年月を入力
5. 「OK」をクリック
6. Googleカレンダーを開く
7. 各グループのカレンダーにシフトが登録されていることを確認
8. イベントのタイトル、日時が正しいことを確認

---

## トラブルシューティング

### 問題1: GASの実行でエラーが出る

**症状**:
- 「承認が必要です」と表示される
- 「権限がありません」と表示される

**解決方法**:
1. GASエディタで任意の関数を選択して「実行」
2. 権限承認画面で「詳細」→「安全ではないページに移動」→「許可」をクリック
3. 再度実行

### 問題2: カスタムメニューが表示されない

**症状**:
- スプレッドシートに「📅 シフト管理」メニューが表示されない

**解決方法**:
1. スプレッドシートを一度閉じて再度開く
2. GASエディタで `onOpen` 関数を選択して手動実行
3. ブラウザのキャッシュをクリア

### 問題3: Webアプリが開かない

**症状**:
- URLにアクセスしてもエラー画面が表示される

**解決方法**:
1. デプロイ設定を確認（ステップ6）
2. 「アクセスできるユーザー」が「全員」になっているか確認
3. 新しいデプロイを作成して、新しいURLを取得

### 問題4: ログインできない

**症状**:
- 「ログインIDまたはパスワードが正しくありません」と表示される

**解決方法**:
1. `M_職員` シートでログインID、パスワードを確認
2. 「有効」フラグが `TRUE` になっているか確認
3. スペースや大文字小文字に注意

### 問題5: カレンダーに登録されない

**症状**:
- シフト登録を実行してもカレンダーにイベントが作成されない

**解決方法**:
1. `M_職員` シートの「カレンダーID」が正しいか確認
2. カレンダーIDにスペースや改行が含まれていないか確認
3. GASにカレンダーへのアクセス権限があるか確認
4. GASの実行ログを確認（「表示」→「ログ」）

### 問題6: 「スプレッドシートにバインドされている必要があります」エラー

**症状**:
- 関数実行時にこのエラーが表示される

**解決方法**:
1. **重要**: GASプロジェクトは必ずスプレッドシートから「拡張機能 → Apps Script」で開く必要があります
2. 独立したGASプロジェクトでは動作しません
3. ステップ3からやり直してください

---

## 次のステップ

導入が完了したら、[運用手順書.md](./運用手順書.md) を参照して、日常的な運用を開始してください。

---

## サポート・問い合わせ

導入に関して問題が発生した場合：

1. **GASの実行ログを確認**
   - GASエディタ → 「表示」→「ログ」
   - エラーメッセージを確認

2. **スプレッドシートのデータを確認**
   - データ形式が正しいか
   - 必須項目が入力されているか

3. **ブラウザの開発者ツールを確認**
   - Webアプリで F12 キーを押す
   - Console タブでエラーを確認

4. **README.md を参照**
   - 詳細な技術情報が記載されています

---

**導入作業お疲れさまでした！**

システムの運用について詳しくは「運用手順書.md」をご覧ください。
