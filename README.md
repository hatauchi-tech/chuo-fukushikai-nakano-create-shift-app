# シフト管理自動化システム v3.0

介護施設向けのシフト作成・管理システム（Python最適化 + Google Apps Script + Spreadsheet）

## 概要

手書きと手計算で行われているシフト作成業務をデジタル化し、Python最適化アルゴリズムとGoogle Workspaceを連携させて自動化・効率化するシステムです。職員の休み希望収集からシフト自動生成、カレンダーへの登録までを一気通貫で行います。

### 対象規模

- 職員数: 61名（6グループ体制）
- 喀痰吸引資格者: 14名
- 勤務配慮あり: 10名

### v3.0 の特徴

- **統合版Python最適化**: 診断・緩和・部分出力を1ファイルに統合（1セルで実行）
- **施設横断の資格者チェック**: 喀痰吸引資格者の配置を施設全体で検証（法的要件）
- **クライアントサイドフィルタリング**: シフト修正画面で即座にフィルター反映（サーバー通信なし）
- **マルチフィルター**: グループ/ユニット/雇用形態/資格/配慮の複数条件で絞込
- **確定ボタン2種**: カレンダー登録あり/なしを選択可能
- **アプリ内マニュアル**: 職員・管理者向けの使い方ガイドを内蔵

---

## システム構成

```
┌─────────────┐
│   Webアプリ  │ ← SPA（Tailwind CSS）+ マニュアル内蔵
│  (データ入力) │
└──────┬──────┘
       │ ① 3種CSV一括出力
       ↓
┌─────────────┐
│ Google Drive│ ← T_休み希望.csv, M_職員.csv, M_設定.csv
│  (input/)   │
└──────┬──────┘
       │ ② 読込
       ↓
┌─────────────┐
│Google Colab │ ← Python OR-Tools（統合版v3.0）
│  (計算実行)  │    診断 → グループ別最適化 → 緩和リトライ → 部分出力
└──────┬──────┘
       │ ③ シフト結果.csv + 診断レポート.json + Webhook通知
       ↓
┌─────────────┐
│     GAS     │ ← データインポート・連携ハブ
│  (doPost)   │
└──────┬──────┘
       │ ④ T_確定シフトに保存
       ↓
┌─────────────┐
│   Sheet     │ ← T_確定シフト
└──────┬──────┘
       │ ⑤ カレンダー登録（任意）
       ↓
┌─────────────┐
│  Calendar   │ ← 職員ごとのGoogleカレンダー
└─────────────┘
```

### 技術スタック

| レイヤー | 技術 |
|----------|------|
| フロントエンド | Google Apps Script Web App（SPA）、Tailwind CSS CDN |
| バックエンド | Google Apps Script（スタンドアローン） |
| シフト計算 | Python OR-Tools CP-SAT Solver（Google Colab） |
| 連携 | Webhook（HTTP POST）、CSV形式 |
| データ保管 | Google Spreadsheet |
| 出力 | Google Calendar（職員ごとのカレンダーID指定） |

---

## 主要機能

### 1. Webアプリ（SPA）

| 画面 | 対象 | 機能 |
|------|------|------|
| ログイン | 全員 | ID/PWによる職員認証 |
| 休み希望提出 | 全員 | カレンダーUIで希望休を登録、優先順位設定 |
| シフト管理 | 管理者 | 3種CSV出力、締切設定、結果取込、診断レポート |
| シフト修正 | 管理者 | マルチフィルター、修正、統計、確定 |
| 職員マスタ管理 | 管理者 | 職員データのCRUD操作 |
| シフトマスタ管理 | 管理者 | シフト種別の編集 |
| 勤務指定 | 管理者 | 事前シフト固定 |
| マニュアル | 全員 | アプリ内使い方ガイド |

### 2. シフト修正画面（v3.0新機能）

- **マルチフィルター**: チェックボックスでグループ/ユニット/雇用形態/資格/配慮を複数選択
- **即時反映**: フィルター操作時にサーバー通信なし（クライアントサイドフィルタリング）
- **編集保持**: フィルター切替時も編集内容を保持
- **資格者ハイライト**: 喀痰吸引資格者の行を黄色背景で表示
- **2種確定ボタン**: 「確定」（データのみ）と「Googleカレンダー登録して確定」

### 3. CSV連携

**出力（inputフォルダへ）:**
- `T_休み希望_YYYYMM.csv`
- `M_職員_YYYYMM.csv`
- `M_設定_YYYYMM.csv`

**入力（outputフォルダから）:**
- `シフト結果_YYYYMM.csv`: Python計算結果

### 4. シフト計算（Python統合版v3.0）

| 機能 | 説明 |
|------|------|
| 事前診断 | グループ人数/夜勤可能者/資格者の事前チェック |
| グループ別最適化 | 6グループを個別に最適化 |
| 自動緩和リトライ | 失敗時に制約を緩和して再試行 |
| 部分出力 | 一部グループ失敗時も成功分を出力 |
| 施設横断検証 | 全グループ合算で資格者配置を検証 |
| 診断レポート | JSON形式で詳細な結果を保存 |

#### 制約緩和モード

| 制約 | 通常 | 緩和時 |
|------|------|--------|
| 早出人数 | 2名以上 | 1名以上 |
| 日勤人数 | 1名以上 | 0名OK |
| 所定勤務日数 | ぴったり | ±2日 |
| 喀痰吸引資格者 | 毎日必須 | 不要 |

### 5. ルールチェック

#### 必須制約（ハード）

| ルール | 内容 |
|--------|------|
| 公休数の遵守 | 暦日数 - 公休数 = 勤務日数 |
| 連勤制限 | 連続5日まで |
| 夜勤明けルール | 夜勤→休→休 |
| 勤務間インターバル | 遅出→翌日早出は禁止 |
| 勤務配慮 | 勤務配慮ありの職員は夜勤免除 |
| 資格者配置 | 施設全体で毎日1名以上の喀痰吸引資格者を配置（法的要件） |
| 第1休み希望 | 必ず休みにする |

#### ソフト制約（できるだけ遵守）

| ルール | 内容 |
|--------|------|
| グループ別最低人数 | 早出2名/日勤1名（日曜0可）/遅出1名/夜勤1名 |
| 第2希望以降の休み | できるだけ叶えるが調整あり |
| 夜勤の資格者 | 夜勤にも施設全体で1名以上の資格者を配置 |

#### 夜勤の休日カウント

夜勤は日をまたぐため、シフト表上は2日分表示（当日「夜勤」+翌日「休み」）。ただし休日カウントは夜勤明けの翌日の休みのみが実質公休1日。

### 6. 診断レポート

- Python計算時に `診断レポート_YYYYMM.json` を自動生成
- Webアプリの「シフト管理」画面で確認可能
- 職員名・グループでフィルター検索
- 施設横断の資格者チェック結果を含む

### 7. カレンダー連携

- 確定シフトをGoogleカレンダーに自動登録
- 職員ごとのカレンダーIDを指定可能
- 「確定」ボタンでカレンダー登録なしの確定も可能

---

## 導入手順

### 前提条件

- Google Workspaceアカウント（管理者権限推奨）
- Google Drive / Colab アクセス権限
- Chrome最新版推奨

### Phase 1: Google Drive準備

1. **フォルダ作成**

   ```
   シフト管理システム/
   ├── input/     ← CSV出力先（休み希望、職員、設定）
   ├── output/    ← Python計算結果（シフト結果.csv、診断レポート.json）
   └── archive/   ← 取込済みCSVの保管
   ```

2. **フォルダIDを取得**（URLの `folders/` 以降の文字列）

### Phase 2: スプレッドシート作成

1. 新規スプレッドシート作成
2. スプレッドシートIDを取得

### Phase 3: GASプロジェクト設定

1. Apps Scriptプロジェクト作成
2. コードファイル（01〜08 + index.html）を貼り付け
3. スクリプトプロパティを設定:

   | プロパティ | 説明 |
   |-----------|------|
   | `SPREADSHEET_ID` | 対象スプレッドシートID |
   | `DRIVE_FOLDER_INPUT` | inputフォルダID |
   | `DRIVE_FOLDER_OUTPUT` | outputフォルダID |
   | `DRIVE_FOLDER_ARCHIVE` | archiveフォルダID |
   | `WEBHOOK_TOKEN` | Webhook認証用トークン |

4. onOpenトリガーを設定
5. 初期設定を実行（カスタムメニュー → 初期設定）
6. Webアプリをデプロイ
7. M_設定シートに月間公休日数を設定

### Phase 4: Python環境準備

1. Google Colabでノートブック作成
2. `shift_optimizer.py` を1セルに貼り付け
3. 定数を設定（フォルダID、Webhook URL等）
4. `!pip install -q ortools pandas` を実行

### Phase 5: 動作確認

1. 管理者ユーザーでログインテスト
2. 休み希望入力テスト
3. 3種CSV出力 → Python計算テスト
4. シフト修正画面でフィルター・修正テスト
5. 確定テスト

---

## 運用フロー

1. **職員が休み希望を入力**（カレンダーUIで第1〜第N希望を設定）
2. **管理者が提出を締め切る**（シフト管理画面）
3. **管理者が勤務指定を入力**（任意・勤務指定画面）
4. **3種CSV出力 → Python実行**（自動計算、Webhook通知）
5. **シフト修正画面で確認・修正**（マルチフィルター、統計確認）
6. **確定**（カレンダー登録の有無を選択）

---

## ファイル構成

### GAS（Google Apps Script）

| ファイル | 行数 | 役割 |
|----------|------|------|
| 01_Config.gs | ~145 | スプレッドシート設定、スクリプトプロパティ管理 |
| 02_DataService.gs | ~700 | データアクセス層（全シートのCRUD操作） |
| 03_AuthService.gs | ~120 | 認証・セッション管理 |
| 04_ShiftService.gs | ~430 | ルールチェック（施設横断チェック含む） |
| 05_CalendarService.gs | ~335 | Googleカレンダー連携 |
| 06_Code.gs | ~1540 | doGet/doPost、全APIエンドポイント |
| 07_index.html | ~3000 | Webアプリ（SPA）、マニュアル |
| 08_CSVService.gs | ~615 | CSV入出力、Webhook処理 |

### Python（Google Colab）

| ファイル | 行数 | 役割 |
|----------|------|------|
| shift_optimizer.py | ~1420 | 統合版v3.0（診断+最適化+緩和+部分出力） |

---

## データベース設計

### M_職員

| 列名 | 型 | 備考 |
|------|------|------|
| 職員ID | Text | Key（STAFF_タイムスタンプ形式） |
| 氏名 | Text | |
| 役職 | Text | 「管理者」で管理者権限付与 |
| グループ | Enum | 1〜6 |
| 雇用形態 | Enum | 常勤/パート |
| ユニット | Text | |
| ログインID | Text | 一意制約 |
| パスワード | Text | |
| カレンダーID | Text | Googleカレンダー連携用 |
| 喀痰吸引資格者 | Bool | |
| 勤務配慮 | Bool | TRUE=夜勤免除 |
| 有効 | Bool | FALSE=ログイン不可 |

### M_シフト

| 列名 | 型 | 備考 |
|------|------|------|
| シフトID | Text | Key |
| シフトキー | Text | 不変キー（SHIFT_HAYADE等） |
| シフト名 | Text | 表示名（早出/日勤/遅出/夜勤/ヤ） |
| 開始時間 | Time | HH:MM形式 |
| 終了時間 | Time | HH:MM形式 |

### T_確定シフト

| 列名 | 型 | 備考 |
|------|------|------|
| 確定シフトID | Text | Key |
| 職員ID | Text | |
| 氏名 | Text | |
| グループ | Enum | |
| シフト名 | Text | |
| 勤務開始日 | Date | |
| 開始時間 | Time | |
| 勤務終了日 | Date | 夜勤等で翌日になる場合 |
| 終了時間 | Time | |

### M_設定

主要な設定キー:
- `SUBMISSION_LOCK_YYYYMM`: 休み希望提出のロック状態
- `MONTHLY_HOLIDAYS_YYYYMM`: 月間公休日数
- `SHIFT_HAYADE_NAME` / `SHIFT_NIKKIN_NAME` / etc.: シフト表示名

---

## トラブルシューティング

| 問題 | 対処法 |
|------|--------|
| カスタムメニューが出ない | onOpenトリガーを設定 |
| スプレッドシートID未設定 | スクリプトプロパティで `SPREADSHEET_ID` を設定 |
| CSV出力エラー | `DRIVE_FOLDER_INPUT` 等のフォルダIDを確認 |
| Webhook 401エラー | GASとPythonで同じ `WEBHOOK_TOKEN` を設定 |
| Python INFEASIBLE | 診断レポートで原因確認。よくある原因: 人数不足、休み希望集中 |
| ログインできない | M_職員の「有効」がTRUEか確認 |

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|----------|
| v3.0 | 2026-02-23 | マルチフィルター、施設横断資格者チェック、クライアントサイドフィルタリング、マニュアル内蔵、確定ボタン2種、診断レポートフィルター |
| v2.1 | 2025-01-05 | 診断機能付きPythonスクリプト追加 |
| v2.0 | 2025-11-28 | Python最適化システムへ完全移行 |
| v1.0 | - | 初版リリース（GAS単独） |

---

## ライセンス

このプロジェクトは内部利用を目的としています。
