# シフト管理自動化システム

介護施設向けのシフト作成・管理システム（Google Apps Script + Spreadsheet）

## 📋 概要

手書きと手計算で行われているシフト作成業務をデジタル化し、スプレッドシートとGASを用いて自動化・効率化するシステムです。従業員の休み希望収集からカレンダーへの登録までを一気通貫で行います。

## ✨ 主要機能

### 1. Webアプリ（SPA）
- **ログイン認証**: ID/PWによる職員認証
- **休み希望提出**: カレンダーUIで直感的に希望休を登録・編集
  - 優先順位設定（第1希望〜第9希望）
  - 月間公休上限チェック
  - 締め切り後の閲覧モード
- **職員マスタ管理**: 管理者による職員データのCRUD操作
- **シフトマスタ管理**: シフト種別の編集

### 2. スプレッドシート機能
- **シフト案作成**: 休み希望反映＋最低人数確保ロジック
  - 対象年月を入力するだけで自動生成
  - 月間公休日数はM_設定シートから自動取得
- **ルールチェック**: ルール違反箇所のハイライト表示
- **シフト登録**: 確定データの保存＋6つのグループカレンダーに自動反映

## 🏗️ システム構成

- **フロントエンド**: Google Apps Script Web App（SPA方式）
- **スタイル**: Tailwind CSS（CDN版）
- **バックエンド/DB**: Google Spreadsheet
- **出力**: Google Calendar（6グループ別）

## 📊 データベース設計

### 主要テーブル

#### T_シフト休み希望
- シフト休み希望ID
- 氏名
- 提出日時
- 日付
- **優先順位**（1〜9、数値が小さいほど優先度が高い）
- 特記事項

#### M_職員
- 職員ID
- 所属、役職、グループ（1〜6）
- カレンダーID
- 氏名、雇用形態
- 喀痰吸引資格者（Bool）
- 勤務配慮（Bool）
- 有効フラグ
- ログインID、パスワード

#### M_設定
- 設定ID
- 設定値

**主要な設定キー**:
- `SUBMISSION_LOCK_YYYYMM`: 休み希望提出のロック状態（TRUE/FALSE）
- `MONTHLY_HOLIDAYS_YYYYMM`: 月間公休日数（例: 9）

## 🔄 シフト作成アルゴリズム（3段階処理）

### STEP1: 月間公休日数の割り当て（優先順位調整付き）
1. 各スタッフの休み希望を取得
2. 優先順位でソート（第1希望→第2希望→...）
3. 優先順位が高い順に割り当て（月間公休日数まで）

**優先順位による競合解決**:
```
Aさん: 12/1(第1希望), 12/2(第2希望), 12/3(第3希望)
Bさん: 12/1(第2希望), 12/2(第1希望), 12/3(第3希望)

結果:
- 12/1 → Aさん優先（第1希望 vs 第2希望）
- 12/2 → Bさん優先（第2希望 vs 第1希望）
- 12/3 → 両方第3希望で同順位
```

### STEP2: 資格者の夜勤割り当て
- 全日に最低1名の喀痰吸引資格者の夜勤を配置
- 制約チェック（連勤制限、月間勤務日数上限など）を適用

### STEP3: 残りシフトの割り当て
- グループごとに最低人数要件を満たすよう割り当て
  - 夜勤: 1名以上
  - 早出: 2名以上
  - 日勤: 1名以上（日曜は0名OK）
  - 遅出: 1名以上

### 最終処理: 空白セルの処理
- 公休数に達していない場合: 「休み」を割り当て
- 公休数に達している場合: 「日勤」を割り当て（制約無視）

## 📏 シフトルール

### 個人単位の制約
1. **連勤制限**: 連続5日まで（6連勤以上は不可）
2. **月間勤務日数上限**: 21日以内（夜勤は1回2日分換算）
3. **インターバル**: 遅出→翌日早出は禁止
4. **夜勤明けルール**: 夜勤→休→休（翌日・翌々日は休み必須）
5. **属性免除**: 「勤務配慮」ありのスタッフは夜勤免除

### グループ単位の最低人数
- 早出: 2名以上
- 日勤: 1名以上（日曜は0名OK）
- 遅出: 1名以上
- 夜勤: 1名以上

### 全体ルール
- **資格者配置**: 全日に喀痰吸引資格者が最低1名いること

## 🚀 使い方

### 1. 初期設定
1. スプレッドシートを作成
2. GASプロジェクトをバインド
3. 初期設定スクリプトを実行してテーブル作成
4. M_設定シートに月間公休日数を設定
   ```
   設定ID: MONTHLY_HOLIDAYS_202501
   設定値: 9
   ```

### 2. 職員登録
- Webアプリから職員マスタ管理画面で職員を登録
- または、M_職員シートに直接入力

### 3. 休み希望提出
1. 職員がWebアプリにログイン
2. 対象年月を選択
3. カレンダーで希望日をクリック
4. 一覧表で各日付の優先順位を設定
5. 保存

### 4. シフト案作成
1. スプレッドシートを開く
2. カスタムメニュー「シフト管理」→「シフト案作成」
3. 対象年月を入力（例: 2025/01）
4. 自動的にシフト案が生成される

### 5. 手修正とルールチェック
1. 作業用シートでシフトを手修正
2. カスタムメニュー「ルールチェック」を実行
3. 違反箇所がハイライト表示される

### 6. シフト登録
1. カスタムメニュー「シフト登録」を実行
2. 確定データがT_確定シフトに保存
3. 6つのグループカレンダーに自動反映

## ⚠️ 注意事項

### シフト案は「たたき台」
- アルゴリズムは完全最適化ではなく、たたき台作成レベル
- 制約を満たせない場合、デフォルトシフト（日勤）で埋める
- **必ず手作業で調整してください**

### ルール違反の可能性
- 最終処理で公休数に達した後の割り当ては制約チェックを無視
- 連勤制限や月間勤務日数上限のルール違反が発生する可能性
- ルールチェック機能で確認し、手作業で修正

## 📝 開発情報

### ファイル構成
```
01_Config.gs          設定管理
02_DataService.gs     データアクセス層
03_CalendarService.gs カレンダー連携
04_ShiftService.gs    シフト生成ロジック
05_AuthService.gs     認証機能
06_Code.gs            カスタムメニュー
07_index.html         Webアプリ（SPA）
```

### 技術スタック
- Google Apps Script
- Google Spreadsheet
- Google Calendar API
- Tailwind CSS
- Vanilla JavaScript

## 📄 ライセンス

このプロジェクトは内部利用を目的としています。

## 📞 問い合わせ

詳細な仕様については「シフト管理自動化システム 要件定義書.md」を参照してください。
