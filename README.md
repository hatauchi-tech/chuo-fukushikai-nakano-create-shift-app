# シフト管理自動化システム v2.0

介護施設向けのシフト作成・管理システム（Python最適化 + Google Apps Script + Spreadsheet）

## 📋 概要

手書きと手計算で行われているシフト作成業務をデジタル化し、Python最適化アルゴリズムとGoogle Workspaceを連携させて自動化・効率化するシステムです。従業員の休み希望収集からカレンダーへの登録までを一気通貫で行います。

**v2.0 新機能:**
- Python最適化アルゴリズムによる高精度なシフト生成
- CSV連携による柔軟なデータ流通
- Webhook経由の自動連携

## ✨ 主要機能

### 1. Webアプリ（SPA）
- **ログイン認証**: ID/PWによる職員認証
- **休み希望提出**: カレンダーUIで直感的に希望休を登録・編集
  - 優先順位設定（第1希望〜第9希望）
  - 月間公休上限チェック
  - 締め切り後の閲覧モード
- **職員マスタ管理**: 管理者による職員データのCRUD操作
- **シフトマスタ管理**: シフト種別の編集

### 2. CSV連携機能
- **休み希望CSV出力**: T_休み希望データをCSV形式でDriveへ出力
- **シフト結果CSV取込**: Python計算結果をインポート・自動反映
- **Webhook連携**: ColabからGASへ自動通知

### 3. シフト計算（Python）
- **最適化アルゴリズム**: 線形計画法などの高度なアルゴリズムでシフトを最適化
- **制約条件の厳格な適用**: 連勤制限、月間勤務日数、資格者配置などを完全遵守
- **実行時間制限なし**: GASの6分制限から解放

### 4. スプレッドシート機能
- **ルールチェック**: ルール違反箇所のハイライト表示（手修正後の検証用）
- **シフト登録**: 確定データの保存＋6つのグループカレンダーに自動反映

## 🏗️ システム構成

```
┌─────────────┐
│   アプリ    │ ← Webアプリ（SPA）
│ (データ入力)│
└──────┬──────┘
       │ ① CSV出力
       ↓
┌─────────────┐
│ Google Drive│ ← T_休み希望.csv
└──────┬──────┘
       │ ② 読込
       ↓
┌─────────────┐
│Google Colab │ ← Python最適化アルゴリズム
│  (計算実行) │
└──────┬──────┘
       │ ③ CSV保存 + Webhook
       ↓
┌─────────────┐
│     GAS     │ ← データインポート・連携ハブ
└──────┬──────┘
       │ ④ Sheet反映
       ↓
┌─────────────┐
│   Sheet     │ ← T_確定シフト・作業用シート
└──────┬──────┘
       │ ⑤ カレンダー登録
       ↓
┌─────────────┐
│  Calendar   │ ← 6グループ別カレンダー
└─────────────┘
```

**技術スタック:**
- **フロントエンド**: Google Apps Script Web App（SPA）、Tailwind CSS
- **シフト計算**: Python（Google Colab）
- **連携**: Webhook（HTTP POST）、CSV形式
- **データ保管**: Google Spreadsheet
- **出力**: Google Calendar（6グループ別）

## 📊 データベース設計

### 主要テーブル

#### T_シフト休み希望
- シフト休み希望ID
- 氏名
- 提出日時
- 日付
- **優先順位**（1〜9、数値が小さいほど優先度が高い）
- 特記事項

#### M_職員
- 職員ID
- 所属、役職、グループ（1〜6）
- カレンダーID
- 氏名、雇用形態
- 喀痰吸引資格者（Bool）
- 勤務配慮（Bool）
- 有効フラグ
- ログインID、パスワード

#### M_設定
- 設定ID
- 設定値

**主要な設定キー**:
- `SUBMISSION_LOCK_YYYYMM`: 休み希望提出のロック状態（TRUE/FALSE）
- `MONTHLY_HOLIDAYS_YYYYMM`: 月間公休日数（例: 9）

## 🔄 シフト作成アルゴリズム

**v2.0では、シフト計算をPython（Google Colab）で実行します。**

Python側で実装する最適化アルゴリズムは以下の制約を厳格に守ります：

### 入力データ
- T_休み希望.csv（氏名、グループ、日付、優先順位）
- M_職員マスタ（資格、勤務配慮、グループ情報）
- M_設定（月間公休日数、その他ルール）

### 制約条件
1. **休み希望の優先順位**: 第1希望から順に優先的に割り当て
2. **月間公休日数**: 設定された日数を厳守
3. **連勤制限**: 連続5日まで（6連勤以上は不可）
4. **月間勤務日数上限**: 21日以内（夜勤は2日分換算）
5. **インターバル**: 遅出→翌日早出は禁止
6. **夜勤明けルール**: 夜勤→休→休
7. **資格者配置**: 全日に喀痰吸引資格者を最低1名配置
8. **グループ別最低人数**: 早出2名、日勤1名、遅出1名、夜勤1名

### 最適化手法（例）
- 線形計画法（PuLP）
- 制約充足問題（OR-Tools）
- 遺伝的アルゴリズム
- その他の最適化ライブラリ

**詳細は `colab_integration_sample.py` を参照してください。**

## 📏 シフトルール

### 個人単位の制約
1. **連勤制限**: 連続5日まで（6連勤以上は不可）
2. **月間勤務日数上限**: 21日以内（夜勤は1回2日分換算）
3. **インターバル**: 遅出→翌日早出は禁止
4. **夜勤明けルール**: 夜勤→休→休（翌日・翌々日は休み必須）
5. **属性免除**: 「勤務配慮」ありのスタッフは夜勤免除

### グループ単位の最低人数
- 早出: 2名以上
- 日勤: 1名以上（日曜は0名OK）
- 遅出: 1名以上
- 夜勤: 1名以上

### 全体ルール
- **資格者配置**: 全日に喀痰吸引資格者が最低1名いること

## 🚀 使い方

**詳細な手順は `MIGRATION_GUIDE.md` を参照してください。**

### 1. 初期設定
1. スプレッドシートを作成
2. GASプロジェクトをバインド
3. 初期設定スクリプトを実行してテーブル作成
4. Driveフォルダ作成（input/output/archive）
5. カスタムメニュー「Drive設定」でフォルダIDを登録
6. M_設定シートに月間公休日数を設定
   ```
   設定ID: MONTHLY_HOLIDAYS_202501
   設定値: 9
   ```

### 2. 職員登録
- Webアプリから職員マスタ管理画面で職員を登録
- または、M_職員シートに直接入力

### 3. 休み希望提出
1. 職員がWebアプリにログイン
2. 対象年月を選択
3. カレンダーで希望日をクリック
4. 一覧表で各日付の優先順位を設定
5. 保存

### 4. CSV出力
1. カスタムメニュー「CSV連携」→「休み希望CSV出力」
2. 対象年月を入力（例: 2025/01）
3. Drive の `input/` フォルダに CSV が保存される

### 5. シフト計算（Python）
1. Google Colab で `colab_integration_sample.py` を実行
2. 設定値（Webhook URL、トークン、フォルダID）を編集
3. `main(year, month)` を実行
4. 自動的に計算→CSV保存→Webhook通知

### 6. 手修正とルールチェック
1. シフト作業用シートで内容を確認・手修正
2. カスタムメニュー「ルールチェック」を実行
3. 違反箇所がセルコメントで表示される

### 7. シフト登録
1. カスタムメニュー「シフト登録」を実行
2. 対象グループを選択（1,2,3,4,5,6 または ALL）
3. 確定データがT_確定シフトに保存
4. 6つのグループカレンダーに自動反映

## ⚠️ 注意事項

### Python最適化アルゴリズムについて
- v2.0では、Python側で高精度な最適化を実行
- 制約条件を厳格に適用（v1.0より大幅改善）
- ただし、完全に最適解が見つからない場合もあるため、手修正が必要な場合あり

### 手修正の推奨
- 最適化アルゴリズムの結果は「高精度なたたき台」
- 現場の細かい事情（個別の配慮、イベント対応など）は手修正で対応
- **ルールチェック機能で確認してからカレンダー登録**

### Webhook連携
- Colabからの通知が失敗した場合、手動でCSV取込を実行
- Webhookトークンは定期的に変更を推奨

## 📝 開発情報

### ファイル構成
```
【GAS（Google Apps Script）】
01_Config.gs               設定管理・Drive設定
02_DataService.gs          データアクセス層
03_AuthService.gs          認証機能
04_ShiftService.gs         ルールチェック（※シフト生成機能は削除）
05_CalendarService.gs      カレンダー連携
06_Code.gs                 カスタムメニュー・Webhook・API
07_index.html              Webアプリ（SPA）
08_CSVService.gs           CSV入出力・Webhook処理

【Python（Google Colab）】
colab_integration_sample.py  シフト計算・Webhook通知サンプル

【ドキュメント】
README.md                 システム概要
MIGRATION_GUIDE.md        移行ガイド
```

### 技術スタック
- **GAS**: Google Apps Script
- **Python**: Google Colab（最適化アルゴリズム）
- **データ保管**: Google Spreadsheet
- **データ連携**: CSV形式、Webhook（HTTP POST）
- **カレンダー**: Google Calendar API
- **フロントエンド**: Tailwind CSS、Vanilla JavaScript

## 📄 ライセンス

このプロジェクトは内部利用を目的としています。

## 📞 問い合わせ

詳細な仕様については「シフト管理自動化システム 要件定義書.md」を参照してください。
