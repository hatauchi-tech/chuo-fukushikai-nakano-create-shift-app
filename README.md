# シフト管理自動化システム v2.0

介護施設向けのシフト作成・管理システム（Python最適化 + Google Apps Script + Spreadsheet）

## 概要

手書きと手計算で行われているシフト作成業務をデジタル化し、Python最適化アルゴリズムとGoogle Workspaceを連携させて自動化・効率化するシステムです。従業員の休み希望収集からカレンダーへの登録までを一気通貫で行います。

### 解決する課題

- 手書きの休み希望の集計工数の削減
- 複雑なシフトルール（資格者配置、連勤制限など）のチェック漏れ防止
- シフト作成後の転記作業（カレンダー登録）の自動化

### v2.0 の特徴

- **Python最適化アルゴリズム**: 高精度なシフト生成（GAS 6分制限から解放）
- **CSV連携**: 柔軟なデータ流通
- **Webhook経由の自動連携**: ColabからGASへ自動通知

---

## システム構成

```
┌─────────────┐
│   アプリ    │ ← Webアプリ（SPA）
│ (データ入力)│
└──────┬──────┘
       │ ① CSV出力
       ↓
┌─────────────┐
│ Google Drive│ ← T_休み希望.csv
└──────┬──────┘
       │ ② 読込
       ↓
┌─────────────┐
│Google Colab │ ← Python最適化アルゴリズム
│  (計算実行) │
└──────┬──────┘
       │ ③ CSV保存 + Webhook
       ↓
┌─────────────┐
│     GAS     │ ← データインポート・連携ハブ
└──────┬──────┘
       │ ④ Sheet反映
       ↓
┌─────────────┐
│   Sheet     │ ← T_確定シフト・作業用シート
└──────┬──────┘
       │ ⑤ カレンダー登録
       ↓
┌─────────────┐
│  Calendar   │ ← 6グループ別カレンダー
└─────────────┘
```

### 技術スタック

| レイヤー | 技術 |
|----------|------|
| フロントエンド | Google Apps Script Web App（SPA）、Tailwind CSS |
| シフト計算 | Python（Google Colab） |
| 連携 | Webhook（HTTP POST）、CSV形式 |
| データ保管 | Google Spreadsheet |
| 出力 | Google Calendar（6グループ別） |

---

## 主要機能

### 1. Webアプリ（SPA）

| 画面 | 対象 | 機能 |
|------|------|------|
| ログイン | 全員 | ID/PWによる職員認証 |
| 休み希望提出 | 全員 | カレンダーUIで希望休を登録・編集、優先順位設定（第1〜第9希望）、月間公休上限チェック |
| 職員マスタ管理 | 管理者 | 職員データのCRUD操作 |
| シフトマスタ管理 | 管理者 | シフト種別の編集 |
| シフト管理 | 管理者 | CSV出力、締切設定、進捗管理 |
| シフト修正 | 管理者 | グループ別シフト確認・修正、統計表示、カレンダー登録 |

### 2. CSV連携機能

- **休み希望CSV出力**: T_休み希望データをCSV形式でDriveへ出力
- **職員CSV出力**: 職員マスタのPython用データ出力
- **設定CSV出力**: 月間ルール設定の出力
- **シフト結果CSV取込**: Python計算結果をインポート・自動反映

### 3. シフト計算（Python）

- **最適化アルゴリズム**: 線形計画法（PuLP）、制約充足問題（OR-Tools）等
- **制約条件の厳格な適用**: 連勤制限、月間勤務日数、資格者配置などを完全遵守
- **実行時間制限なし**: GASの6分制限から解放

### 4. スプレッドシート機能

- **ルールチェック**: ルール違反箇所のハイライト表示・セルコメント
- **シフト登録**: 確定データの保存＋6つのグループカレンダーに自動反映

---

## 導入手順

### 前提条件

- Google Workspaceアカウント（管理者権限）
- Google Drive / Colab アクセス権限
- Chrome最新版推奨

### Phase 1: Google Drive準備

1. **フォルダ作成**

   Google Driveに以下の構造で作成：
   ```
   シフト管理システム/
   ├── input/     ← T_休み希望.csv
   ├── output/    ← シフト結果.csv
   └── archive/   ← 過去データ保管
   ```

2. **フォルダIDを取得**

   各フォルダを開いてURLからID取得（`folders/` 以降の文字列）

3. **アクセス権限設定**

   必要なユーザー（管理者、GASスクリプト実行アカウント）を「編集者」として追加

### Phase 2: GASプロジェクト設定

1. **スプレッドシート作成**

   Google Driveで新規スプレッドシート作成（例: 「シフト管理システム v2.0」）

2. **Apps Scriptエディタでコードをデプロイ**

   `拡張機能 → Apps Script` を開き、以下のファイルを作成してコードを貼り付け：
   ```
   01_Config.gs
   02_DataService.gs
   03_AuthService.gs
   04_ShiftService.gs
   05_CalendarService.gs
   06_Code.gs
   07_index.html
   08_CSVService.gs
   ```

3. **初期設定の実行**

   スプレッドシートをリロード後、カスタムメニューが表示されることを確認：
   ```
   📅 シフト管理 → ⚙️ 設定 → 🔧 初期設定
   ```

   自動作成されるシート：
   - M_職員
   - M_シフト
   - T_シフト休み希望
   - T_確定シフト
   - M_設定

4. **Drive設定**

   ```
   📅 シフト管理 → ⚙️ 設定 → 📁 Drive設定
   ```

   入力項目：
   - inputフォルダID
   - outputフォルダID
   - archiveフォルダID
   - Webhookトークン（任意の文字列、Python側と共有）

5. **Webアプリのデプロイ**

   ```
   デプロイ → 新しいデプロイ → ウェブアプリ
   - 次のユーザーとして実行: 自分
   - アクセスできるユーザー: 全員（または組織内のユーザー）
   ```

   表示されるURLを記録（Webhook URL）

6. **月間公休日数の設定**

   M_設定シートに追加：
   | 設定ID | 設定値 |
   |--------|--------|
   | MONTHLY_HOLIDAYS_202501 | 9 |
   | MONTHLY_HOLIDAYS_202502 | 9 |

### Phase 3: Python環境準備

1. **Google Colabでノートブック作成**

   https://colab.research.google.com/ でノートブックを新規作成

2. **サンプルコードの設定**

   `colab_integration_sample.py` をコピーし、以下の定数を編集：
   ```python
   GAS_WEBHOOK_URL = 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec'
   WEBHOOK_TOKEN = 'your-webhook-token'
   INPUT_FOLDER_ID = 'your-input-folder-id'
   OUTPUT_FOLDER_ID = 'your-output-folder-id'
   ```

3. **Drive認証**

   ```python
   from google.colab import auth
   auth.authenticate_user()
   ```

### Phase 4: 動作確認

1. M_職員シートに管理者ユーザーを登録
2. Webアプリでログインテスト
3. 休み希望入力 → CSV出力テスト
4. Python計算テスト: `main(2025, 1)`
5. CSV取込テスト
6. ルールチェックテスト
7. カレンダー登録テスト

---

## 運用フロー

### 1. 休み希望提出

職員がWebアプリにログインして希望日を入力（優先順位設定可能）

### 2. CSV出力

```
📅 シフト管理 → 📤 CSV連携 → 📤 休み希望CSV出力
```

対象年月入力後、Drive `input/` フォルダに保存

### 3. Pythonでシフト計算

```python
main(2025, 1)  # 年と月を指定
```

処理フロー：CSV読込 → シフト計算 → CSV保存 → Webhook通知

### 4. GAS側の自動処理

Webhook受信後、自動的に：
- CSV取込
- T_確定シフトに保存
- シフト作業用シートに反映

### 5. 手修正・ルールチェック

```
📅 シフト管理 → ✅ ルールチェック
```

違反箇所はセルコメントで表示

### 6. カレンダー登録

```
📅 シフト管理 → 📝 シフト登録
```

対象年月・グループを選択し、各職員のGoogleカレンダーに自動反映

---

## シフトルール

### 個人単位の制約

| ルール | 内容 |
|--------|------|
| 連勤制限 | 連続5日まで（6連勤以上は不可） |
| 月間勤務日数上限 | 21日以内（夜勤は1回2日分換算） |
| インターバル | 遅出→翌日早出は禁止 |
| 夜勤明けルール | 夜勤→休→休（翌日・翌々日は休み必須） |
| 属性免除 | 「勤務配慮」ありのスタッフは夜勤免除 |

### グループ単位の最低人数

| シフト | 最低人数 | 備考 |
|--------|----------|------|
| 早出 | 2名以上 | |
| 日勤 | 1名以上 | 日曜は0名OK |
| 遅出 | 1名以上 | |
| 夜勤 | 1名以上 | |

### 全体ルール

- **資格者配置**: 全日に喀痰吸引資格者が最低1名いること

### 休み希望の優先順位

- 第1希望〜第9希望まで設定可能
- 同じ日に複数人の希望が重複した場合、優先順位が高い方を優先的に割り当て
- 月間公休日数を超える希望は無視

---

## データベース設計

### T_シフト休み希望

| 列名 | 型 | 備考 |
|------|------|------|
| シフト休み希望ID | Text | Key |
| 氏名 | Ref | |
| 提出日時 | DateTime | |
| 日付 | Date | 希望日 |
| 優先順位 | Number | 1〜9 |
| 特記事項 | LongText | |

### M_職員

| 列名 | 型 | 備考 |
|------|------|------|
| 職員ID | Text | Key |
| 所属 | Text | |
| 役職 | Text | 管理者権限判定 |
| グループ | Enum | 1〜6 |
| カレンダーID | Text | |
| 氏名 | Text | |
| 雇用形態 | Enum | 常勤/パート |
| 喀痰吸引資格者 | Bool | |
| 勤務配慮 | Bool | |
| 有効 | Bool | ログイン制御 |
| ログインID | Text | 一意制約 |
| パスワード | Text | |

### M_シフト

| 列名 | 型 | 備考 |
|------|------|------|
| シフトID | Text | Key |
| シフト名 | Text | 早出/日勤/遅出/夜勤/休み |
| 開始時間 | Time | |
| 終了時間 | Time | |
| 備考 | LongText | |

### T_確定シフト

| 列名 | 型 | 備考 |
|------|------|------|
| 確定シフトID | Text | Key |
| 氏名 | Ref | |
| グループ | Enum | |
| 日付 | Date | |
| シフト名 | Text | |
| 開始時間 | Time | |
| 終了時間 | Time | |
| 登録日時 | DateTime | |
| カレンダーイベントID | Text | Googleカレンダー連携用 |

### M_設定

| 列名 | 型 | 備考 |
|------|------|------|
| 設定ID | Text | 設定キー |
| 設定値 | Text | |

**主要な設定キー:**
- `SUBMISSION_LOCK_YYYYMM`: 休み希望提出のロック状態（TRUE/FALSE）
- `MONTHLY_HOLIDAYS_YYYYMM`: 月間公休日数（例: 9）

---

## ファイル構成

### GAS（Google Apps Script）

| ファイル | 役割 |
|----------|------|
| 01_Config.gs | 設定管理・Drive設定 |
| 02_DataService.gs | データアクセス層（CRUD操作） |
| 03_AuthService.gs | 認証・セッション管理 |
| 04_ShiftService.gs | ルールチェック（シフト検証） |
| 05_CalendarService.gs | カレンダー連携 |
| 06_Code.gs | カスタムメニュー・Webhook・API |
| 07_index.html | Webアプリ（SPA） |
| 08_CSVService.gs | CSV入出力・Webhook処理 |

### Python（Google Colab）

| ファイル | 役割 |
|----------|------|
| colab_integration_sample.py | シフト計算・Webhook通知サンプル |

---

## トラブルシューティング

### カスタムメニューが表示されない

**対処法:**
1. ページをリロード（F5）
2. Apps Scriptエディタで保存を確認
3. スクリプトの実行権限を確認

### CSV出力で「設定キーが見つかりません」エラー

**対処法:**
1. M_設定シートで `DRIVE_FOLDER_INPUT` などが登録されているか確認
2. Drive設定を再実行

### Webhook通知失敗（401エラー）

**対処法:**
1. GAS側: M_設定シートまたはスクリプトプロパティでトークン確認
2. Python側: `WEBHOOK_TOKEN` の値を確認
3. 両者を一致させる

### CSV取込で「形式エラー」

**対処法:**
1. CSVをダウンロードしてヘッダー確認
2. 正しい形式: `氏名,グループ,日付,シフト名,開始時間,終了時間`

### Drive認証が失敗する

**対処法:**
1. GAS: Apps Scriptエディタで「実行」→「承認」
2. Python: `auth.authenticate_user()` を再実行
3. 組織のポリシー制限を確認

---

## 技術要件・非機能要件

### アーキテクチャ

- **SPA (Single Page Application)**: 初回ロード(doGet)で単一HTMLを返し、以降はJavaScriptによるDOM操作で画面遷移
- **サーバー通信**: `google.script.run` を非同期で使用

### デザイン・UI

- **Tailwind CSS**: CDNリンク使用、モバイルファーストでレスポンシブ対応

### ログ・デバッグ

- サーバーサイド処理の開始・終了、エラー発生時に `console.log` / `console.error` 出力
- GCPコンソール（Apps Scriptダッシュボード）の「実行数」ログでトレース可能

### 設定管理

- スプレッドシートID、管理者メールアドレス等はコードに直書きせず `PropertiesService.getScriptProperties()` で管理

### セキュリティ

- **Webアプリ公開設定**: Execute as: Me（管理者）、Who has access: Anyone（全員）
- **アプリケーション認証**: 独自ログイン画面でID/PW認証を通過しない限り機能にアクセス不可
- **Webhook認証**: トークンベース認証

---

## 注意事項

### Python最適化アルゴリズムについて

- Python側で高精度な最適化を実行
- 制約条件を厳格に適用（v1.0より大幅改善）
- 完全に最適解が見つからない場合もあるため、手修正が必要な場合あり

### 手修正の推奨

- 最適化アルゴリズムの結果は「高精度なたたき台」
- 現場の細かい事情（個別の配慮、イベント対応など）は手修正で対応
- **ルールチェック機能で確認してからカレンダー登録**

### Webhook連携

- Colabからの通知が失敗した場合、手動でCSV取込を実行
- Webhookトークンは定期的に変更を推奨

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|----------|
| v2.0 | 2025-11-28 | Python最適化システムへ完全移行 |
| v1.0 | - | 初版リリース（GAS単独） |

---

## ライセンス

このプロジェクトは内部利用を目的としています。

---

## サポート

問題が発生した場合は、以下を確認してください：

1. GAS実行ログ（Apps Script Editor → 実行）
2. Colab出力ログ
3. Drive内のCSVファイル
4. M_設定シートの設定値

**最終更新:** 2025-11-28
