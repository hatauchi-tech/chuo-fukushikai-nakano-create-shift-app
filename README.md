# シフト管理自動化システム

Google Apps Script (GAS) を使用したシフト管理自動化システムです。従業員の休み希望収集からシフト作成、Googleカレンダーへの登録までを一気通貫で行います。

## 🎯 主な機能

### 1. **Webアプリ機能（従業員向け）**
- ログイン認証（ID/パスワード）
- 休み希望の提出・編集（カレンダーUI）
- 提出締め切り後の閲覧モード

### 2. **Webアプリ機能（管理者向け）**
- 職員マスタ管理（CRUD操作）
- シフトマスタ管理
- 休み希望の確認

### 3. **スプレッドシート機能（シフト作業）**
- **シフト案作成**: 休み希望を反映した素案の自動生成
- **ルールチェック**: 11個のシフトルールに基づく違反検知とハイライト表示
- **シフト登録**: 確定シフトのDB保存とGoogleカレンダー連携

### 4. **Googleカレンダー連携**
- 6つのグループ別カレンダーへの自動登録
- イベントIDによる更新管理（重複登録防止）

## 📋 シフトルール

システムは以下の11個のルールをチェックします：

### グループ単位ルール
1. **早出**: 2名以上
2. **日勤**: 1名以上（日曜は0名OK）
3. **遅出**: 1名以上
4. **夜勤**: 1名以上

### 個人単位ルール
5. **休み希望**: 月3～4日程度を優先
6. **連勤制限**: 連続5日まで（6連勤以上でエラー）
7. **インターバル**: 遅出→翌日早出は禁止
8. **勤務日数上限**: 月21日以内（夜勤は1回2日分換算）
9. **夜勤明け**: 夜勤→休→休（翌日・翌々日は休み）
10. **属性免除**: 「勤務配慮」ありのスタッフは夜勤免除

### 全体ルール
11. **資格者配置**: 全グループの夜勤担当者の中に「喀痰吸引資格者」が最低1名いること

## 🗂️ ファイル構成

```
chuo-fukushikai-nakano-create-shift-app/
├── 01_Config.gs         # 設定管理（基盤層）
├── 02_DataService.gs    # データアクセス層（CRUD操作）
├── 03_AuthService.gs    # 認証サービス
├── 04_ShiftService.gs   # シフト作成・ルールチェックサービス
├── 05_CalendarService.gs # Googleカレンダー連携サービス
├── 06_Code.gs           # メインエントリーポイント（Webアプリ・カスタムメニュー）
├── 07_index.html        # Webアプリ（SPA、Tailwind CSS使用）
├── シフト管理自動化システム 要件定義書.md
├── 導入手順書.md
├── 運用手順書.md
└── README.md
```

**ファイル名の番号について**:
- 番号は読み込み順序を保証するためのものです
- GASは通常アルファベット順にファイルを読み込むため、依存関係を考慮して番号を付けています
- この順序を守ることで、定数や関数の未定義エラーを防ぎます

## 🚀 セットアップ手順

### 1. Google Apps Scriptプロジェクトを作成

1. [Google Apps Script](https://script.google.com/) を開く
2. 「新しいプロジェクト」を作成
3. プロジェクト名を「シフト管理システム」に変更

### 2. コードをコピー

以下のファイルを **必ず順番通りに** GASプロジェクトに追加します：

1. `01_Config.gs`
2. `02_DataService.gs`
3. `03_AuthService.gs`
4. `04_ShiftService.gs`
5. `05_CalendarService.gs`
6. `06_Code.gs`
7. `07_index.html`（HTMLファイルとして追加）

**重要**: ファイル名の先頭の番号を含めてください。番号は読み込み順序を保証します。

### 3. Googleスプレッドシートを作成

1. 新しいGoogleスプレッドシートを作成
2. スプレッドシートIDをコピー（URLの`/d/`と`/edit`の間の文字列）
3. GASのスクリプトプロパティに設定（任意、自動設定されます）

### 4. 初期設定を実行

1. GASエディタでスプレッドシートを開く
2. メニューから「📅 シフト管理」→「🔧 初期設定」を実行
3. 以下のシートが自動作成されます：
   - `M_職員` - 職員マスタ
   - `M_シフト` - シフトマスタ（デフォルトシフト付き）
   - `T_シフト休み希望` - 休み希望データ
   - `T_確定シフト` - 確定シフトデータ
   - `M_設定` - 設定マスタ

### 5. Webアプリをデプロイ

1. GASエディタで「デプロイ」→「新しいデプロイ」
2. 種類: **Webアプリ**
3. 設定:
   - **次のユーザーとして実行**: 自分
   - **アクセスできるユーザー**: 全員
4. デプロイ

### 6. 職員データを登録

1. Webアプリにアクセス
2. 初回は管理者アカウントを直接スプレッドシートに登録
3. 以降はWebアプリから職員マスタ管理で登録可能

**必須項目**:
- 職員ID
- 氏名
- グループ（1～6）
- ログインID
- パスワード
- カレンダーID（Googleカレンダーの共有設定から取得）
- 有効フラグ（TRUE）

### 7. Googleカレンダーの準備

各グループ用に6つのGoogleカレンダーを作成し、カレンダーIDを職員マスタの「カレンダーID」列に設定します。

**カレンダーIDの取得方法**:
1. Googleカレンダーを開く
2. 対象カレンダーの設定を開く
3. 「カレンダーの統合」セクションにあるカレンダーIDをコピー

## 📖 使い方

### 従業員：休み希望を提出

1. WebアプリのURLにアクセス
2. ログインID・パスワードでログイン
3. 対象月を選択
4. カレンダーから休みたい日をクリック（複数選択可）
5. 「保存」ボタンをクリック

### 管理者：シフト作成の流れ

#### ステップ1: 提出期間設定
1. `M_設定`シートに設定を追加
   - 設定ID: `SUBMISSION_LOCK_202501`（例: 2025年1月）
   - 設定値: `FALSE`（提出受付中）/ `TRUE`（締め切り）

#### ステップ2: 従業員が休み希望を提出
- Webアプリから各自が提出

#### ステップ3: 提出締め切り
- 設定値を`TRUE`に変更

#### ステップ4: シフト案作成
1. スプレッドシートを開く
2. メニュー「📅 シフト管理」→「✨ シフト案作成」
3. 対象年月を入力（例: `2025/01`）
4. `シフト作業用`シートに素案が生成される

#### ステップ5: 手動調整
- ガントチャート形式のシートで手修正

#### ステップ6: ルールチェック
1. メニュー「📅 シフト管理」→「✅ ルールチェック」
2. 違反箇所が赤くハイライト表示される
3. 違反内容がダイアログに表示される

#### ステップ7: シフト登録
1. メニュー「📅 シフト管理」→「📝 シフト登録」
2. 確定シフトがDBに保存される
3. Googleカレンダーに自動登録される

## 🎨 技術スタック

- **バックエンド**: Google Apps Script (JavaScript)
- **フロントエンド**: HTML, JavaScript, Tailwind CSS (CDN)
- **データベース**: Google スプレッドシート
- **カレンダー**: Google Calendar API
- **認証**: カスタム認証（ID/パスワード）

## 🔒 セキュリティ

- Webアプリ側で独自ログイン認証を実装
- パスワードは平文保存（本番環境では暗号化を推奨）
- 管理者権限は役職（M_職員.役職）で制御
- 提出締め切り後は編集不可

## 📝 注意事項

### シフト案作成アルゴリズムについて
- **完全最適化ではありません**
- ランダム配置による「たたき台作成」レベル
- 必ず管理者による手修正が必要です

### ルールチェック機能
- 違反箇所を検知してハイライト表示
- 警告が出ても登録は可能（確認ダイアログ表示）

### カレンダー連携
- イベントIDで管理（重複登録防止）
- 更新時は既存イベントを上書き
- 削除は手動または一括削除機能を使用

## 🐛 トラブルシューティング

### ログインできない
- `M_職員`シートで「有効」フラグが`TRUE`になっているか確認
- ログインIDとパスワードが正しいか確認

### カレンダーに登録されない
- カレンダーIDが正しいか確認
- GASにカレンダーへのアクセス権限があるか確認
- 初回実行時は承認が必要

### ルールチェックで誤検知
- データの形式（日付、時刻）が正しいか確認
- シフト名が`M_シフト`のシフト名と完全一致しているか確認

## 📄 ライセンス

このプロジェクトは中央福祉会中野様向けに開発されたものです。

## 👨‍💻 開発者

GASの達人

---

## 📞 サポート

問題が発生した場合は、以下を確認してください：

1. GASの実行ログ（「表示」→「ログ」）
2. スプレッドシートのデータ形式
3. カレンダーの共有設定

詳細は「シフト管理自動化システム 要件定義書.md」を参照してください。
