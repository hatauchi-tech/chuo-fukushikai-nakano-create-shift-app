# シフト管理自動化システム v2.0

介護施設向けのシフト作成・管理システム（Python最適化 + Google Apps Script + Spreadsheet）

## 概要

手書きと手計算で行われているシフト作成業務をデジタル化し、Python最適化アルゴリズムとGoogle Workspaceを連携させて自動化・効率化するシステムです。従業員の休み希望収集からカレンダーへの登録までを一気通貫で行います。

### 解決する課題

- 手書きの休み希望の集計工数の削減
- 複雑なシフトルール（資格者配置、連勤制限など）のチェック漏れ防止
- シフト作成後の転記作業（カレンダー登録）の自動化

### v2.0 の特徴

- **Python最適化アルゴリズム**: 高精度なシフト生成（GAS 6分制限から解放）
- **CSV連携**: 柔軟なデータ流通（3種CSV一括出力対応）
- **Webhook経由の自動連携**: ColabからGASへ自動通知
- **グループ別カレンダー登録**: 6グループに対応

---

## システム構成

```
┌─────────────┐
│   Webアプリ  │ ← SPA（Tailwind CSS）
│  (データ入力) │
└──────┬──────┘
       │ ① 3種CSV一括出力
       ↓
┌─────────────┐
│ Google Drive│ ← T_休み希望.csv, M_職員.csv, M_設定.csv
│  (input/)   │
└──────┬──────┘
       │ ② 読込
       ↓
┌─────────────┐
│Google Colab │ ← Python最適化アルゴリズム
│  (計算実行)  │
└──────┬──────┘
       │ ③ シフト結果.csv保存 + Webhook通知
       ↓
┌─────────────┐
│     GAS     │ ← データインポート・連携ハブ
│  (doPost)   │
└──────┬──────┘
       │ ④ T_確定シフトに保存
       ↓
┌─────────────┐
│   Sheet     │ ← T_確定シフト
└──────┬──────┘
       │ ⑤ グループ別カレンダー登録
       ↓
┌─────────────┐
│  Calendar   │ ← 6グループ別カレンダー
└─────────────┘
```

### 技術スタック

| レイヤー | 技術 |
|----------|------|
| フロントエンド | Google Apps Script Web App（SPA）、Tailwind CSS CDN |
| バックエンド | Google Apps Script（スタンドアローン） |
| シフト計算 | Python（Google Colab） |
| 連携 | Webhook（HTTP POST）、CSV形式 |
| データ保管 | Google Spreadsheet |
| 出力 | Google Calendar（職員ごとのカレンダーID指定） |

---

## 主要機能

### 1. Webアプリ（SPA）

| 画面 | 対象 | 機能 |
|------|------|------|
| ログイン | 全員 | ID/PWによる職員認証 |
| 休み希望提出 | 全員 | カレンダーUIで希望休を登録・編集、優先順位設定（第1〜第N希望）、月間公休上限チェック |
| 職員マスタ管理 | 管理者 | 職員データのCRUD操作（グループ、カレンダーID、資格者フラグ等） |
| シフトマスタ管理 | 管理者 | シフト種別（早出/日勤/遅出/夜勤/休み）の編集 |
| シフト管理 | 管理者 | 3種CSV一括出力、締切設定、シフト結果取込 |
| シフト修正 | 管理者 | グループ別シフト確認・修正、統計表示、カレンダー登録 |

### 2. CSV連携機能

**出力（inputフォルダへ）:**
- `T_休み希望_YYYYMM.csv`: 休み希望データ（氏名、グループ、日付、優先順位、特記事項）
- `M_職員_YYYYMM.csv`: 職員マスタ（職員ID、氏名、グループ、雇用形態、資格者フラグ等）
- `M_設定_YYYYMM.csv`: 月間設定（公休日数、対象年月、月の日数）

**入力（outputフォルダから）:**
- `シフト結果_YYYYMM.csv`: Python計算結果（確定シフトID、氏名、グループ、シフト名、勤務開始日、開始時間、勤務終了日、終了時間）

### 3. シフト計算（Python）

- **最適化アルゴリズム**: 線形計画法（PuLP）、制約充足問題（OR-Tools）等
- **制約条件の厳格な適用**: 連勤制限、月間勤務日数、資格者配置などを完全遵守
- **実行時間制限なし**: GASの6分制限から解放

### 4. ルールチェック機能（6種類）

| # | ルール | 内容 |
|---|--------|------|
| 1 | 最低人数チェック | グループ別の各シフトに必要人数が割り当てられているか |
| 2 | 連勤制限チェック | 6連勤以上がないか |
| 3 | インターバルチェック | 遅出→翌日早出の禁止パターンがないか |
| 4 | 勤務日数上限チェック | 月21日以内（夜勤は2日分換算） |
| 5 | 夜勤明けルール | 夜勤→休→休のパターンが守られているか |
| 6 | 資格者配置チェック | 夜勤に喀痰吸引資格者が最低1名いるか |

### 5. カレンダー連携

- 確定シフトをGoogleカレンダーに自動登録
- 職員ごとのカレンダーIDを指定可能
- グループ単位での一括登録に対応
- 登録後はカレンダーイベントIDを保存（更新・削除対応）

---

## 導入手順

### 前提条件

- Google Workspaceアカウント（管理者権限推奨）
- Google Drive / Colab アクセス権限
- Chrome最新版推奨

### Phase 1: Google Drive準備

1. **フォルダ作成**

   Google Driveに以下の構造で作成：
   ```
   シフト管理システム/
   ├── input/     ← CSV出力先（休み希望、職員、設定）
   ├── output/    ← Python計算結果（シフト結果.csv）
   └── archive/   ← 取込済みCSVの保管
   ```

2. **フォルダIDを取得**

   各フォルダを開いてURLからID取得（`folders/` 以降の文字列）
   ```
   例: https://drive.google.com/drive/folders/XXXXXXXXXXXXXXXXX
   → フォルダID: XXXXXXXXXXXXXXXXX
   ```

### Phase 2: スプレッドシート作成

1. Google Driveで新規スプレッドシート作成（例: 「シフト管理システム v2.0」）
2. スプレッドシートIDを取得（URLの `/d/` と `/edit` の間の文字列）

### Phase 3: GASプロジェクト設定

1. **Apps Scriptプロジェクト作成**

   - [script.google.com](https://script.google.com/) で新規プロジェクト作成
   - または `拡張機能 → Apps Script` からコンテナバウンドで作成

2. **コードファイルを作成**

   以下のファイルを作成してコードを貼り付け：
   ```
   01_Config.gs
   02_DataService.gs
   03_AuthService.gs
   04_ShiftService.gs
   05_CalendarService.gs
   06_Code.gs
   07_index.html
   08_CSVService.gs
   ```

3. **スクリプトプロパティを設定**

   `プロジェクトの設定 → スクリプト プロパティ` で以下を追加：

   | プロパティ | 値 | 説明 |
   |-----------|-----|------|
   | `SPREADSHEET_ID` | スプレッドシートID | 対象スプレッドシート |
   | `DRIVE_FOLDER_INPUT` | inputフォルダID | CSV出力先 |
   | `DRIVE_FOLDER_OUTPUT` | outputフォルダID | Python結果取込元 |
   | `DRIVE_FOLDER_ARCHIVE` | archiveフォルダID | アーカイブ保管先 |
   | `WEBHOOK_TOKEN` | 任意の文字列 | Webhook認証用（Python側と共有） |

4. **onOpenトリガーを設定**（スタンドアローンスクリプトの場合）

   GASエディタで `トリガー → トリガーを追加`:
   - 実行する関数: `onOpen`
   - イベントのソース: スプレッドシートから
   - イベントの種類: 起動時

5. **初期設定を実行**

   スプレッドシートをリロード後、カスタムメニューが表示されることを確認：
   ```
   📅 シフト管理 → 🔧 初期設定
   ```

   自動作成されるシート：
   - M_職員（職員マスタ）
   - M_シフト（シフトマスタ）
   - T_シフト休み希望（休み希望データ）
   - T_確定シフト（確定シフトデータ）
   - M_設定（設定値）

6. **Webアプリをデプロイ**

   ```
   デプロイ → 新しいデプロイ → ウェブアプリ
   - 次のユーザーとして実行: 自分
   - アクセスできるユーザー: 全員（または組織内のユーザー）
   ```

   表示されるURLを記録（Webhook URLとしても使用）

7. **月間公休日数の設定**

   M_設定シートに追加：
   | 設定ID | 設定値 |
   |--------|--------|
   | MONTHLY_HOLIDAYS_202501 | 9 |
   | MONTHLY_HOLIDAYS_202502 | 9 |

### Phase 4: Python環境準備

1. **Google Colabでノートブック作成**

   https://colab.research.google.com/ でノートブックを新規作成

2. **サンプルコードの設定**

   以下の定数を編集：
   ```python
   GAS_WEBHOOK_URL = 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec'
   WEBHOOK_TOKEN = 'your-webhook-token'  # GAS側と同じ値
   INPUT_FOLDER_ID = 'your-input-folder-id'
   OUTPUT_FOLDER_ID = 'your-output-folder-id'
   ```

3. **Drive認証**

   ```python
   from google.colab import auth
   auth.authenticate_user()
   ```

### Phase 5: 動作確認

1. M_職員シートに管理者ユーザーを登録（役職を「管理者」に設定）
2. Webアプリでログインテスト
3. 休み希望入力 → 3種CSV一括出力テスト
4. Python計算テスト
5. CSV取込テスト（シフト管理画面から）
6. シフト修正画面でルールチェック
7. カレンダー登録テスト

---

## 運用フロー

### 1. 休み希望提出（職員）

職員がWebアプリにログインして希望日を入力
- 優先順位（第1希望〜）を設定可能
- 月間公休上限を超える選択は不可

### 2. 提出締切設定（管理者）

```
シフト管理画面 → 提出締切設定 → 締切（ロック）
```

### 3. 3種CSV一括出力（管理者）

```
シフト管理画面 → 3種CSV一括出力
```

出力ファイル:
- `T_休み希望_YYYYMM.csv`
- `M_職員_YYYYMM.csv`
- `M_設定_YYYYMM.csv`

→ Drive `input/` フォルダに保存

### 4. Pythonでシフト計算

```python
main(2025, 1)  # 年と月を指定
```

処理フロー：CSV読込 → シフト計算 → `シフト結果_YYYYMM.csv` 保存 → Webhook通知

### 5. シフト結果取込

**自動（Webhook経由）:**
- Python実行後、自動的にGASが取込処理を実行

**手動:**
```
シフト管理画面 → シフト結果取込
```

### 6. シフト修正・確認

```
シフト修正画面 → グループ選択 → 表示
```

- プルダウンでシフトを変更
- 統計テーブルで勤務日数を確認
- ルールチェックは自動実行

### 7. カレンダー登録

```
シフト修正画面 → 確定してカレンダー登録
```

- グループ単位で登録
- 職員ごとのGoogleカレンダーに自動反映

---

## シフトルール詳細

### 個人単位の制約

| ルール | 内容 |
|--------|------|
| 連勤制限 | 連続5日まで（6連勤以上は不可） |
| 月間勤務日数上限 | 21日以内（夜勤は1回2日分換算） |
| インターバル | 遅出→翌日早出は禁止 |
| 夜勤明けルール | 夜勤→休→休（翌日・翌々日は休み必須） |
| 属性免除 | 「勤務配慮」ありのスタッフは夜勤免除 |

### グループ単位の最低人数

| シフト | 最低人数 | 備考 |
|--------|----------|------|
| 早出 | 2名以上 | |
| 日勤 | 1名以上 | 日曜は0名OK |
| 遅出 | 1名以上 | |
| 夜勤 | 1名以上 | |

### 全体ルール

- **資格者配置**: 夜勤に喀痰吸引資格者が最低1名いること

### 休み希望の優先順位

- 第1希望〜第N希望まで設定可能（公休日数が上限）
- 同じ日に複数人の希望が重複した場合、優先順位が高い方を優先的に割り当て

---

## データベース設計

### M_職員

| 列名 | 型 | 備考 |
|------|------|------|
| 職員ID | Text | Key（STAFF_タイムスタンプ形式） |
| 氏名 | Text | |
| 役職 | Text | 「管理者」で管理者権限付与 |
| グループ | Enum | 1〜6 |
| 雇用形態 | Enum | 常勤/パート |
| ログインID | Text | 一意制約 |
| パスワード | Text | |
| カレンダーID | Text | Googleカレンダー連携用 |
| 喀痰吸引資格者 | Bool | |
| 勤務配慮 | Bool | TRUE=夜勤免除 |
| 有効 | Bool | FALSE=ログイン不可 |

### M_シフト

| 列名 | 型 | 備考 |
|------|------|------|
| シフトID | Text | Key |
| シフト名 | Text | 早出/日勤/遅出/夜勤/休み |
| 開始時間 | Time | HH:MM形式 |
| 終了時間 | Time | HH:MM形式 |
| 備考 | LongText | |

### T_シフト休み希望

| 列名 | 型 | 備考 |
|------|------|------|
| シフト休み希望ID | Text | Key |
| 氏名 | Text | |
| 提出日時 | DateTime | |
| 日付 | Date | 希望日 |
| 優先順位 | Number | 1〜N |
| 特記事項 | LongText | |

### T_確定シフト

| 列名 | 型 | 備考 |
|------|------|------|
| 確定シフトID | Text | Key |
| 氏名 | Text | |
| グループ | Enum | |
| シフト名 | Text | |
| 勤務開始日 | Date | |
| 開始時間 | Time | |
| 勤務終了日 | Date | 夜勤等で翌日になる場合 |
| 終了時間 | Time | |
| 登録日時 | DateTime | カレンダー登録日時 |
| カレンダーイベントID | Text | Googleカレンダー連携用 |

### M_設定

| 列名 | 型 | 備考 |
|------|------|------|
| 設定ID | Text | 設定キー |
| 設定値 | Text | |

**主要な設定キー:**
- `SUBMISSION_LOCK_YYYYMM`: 休み希望提出のロック状態（TRUE/FALSE）
- `MONTHLY_HOLIDAYS_YYYYMM`: 月間公休日数（例: 9）

---

## ファイル構成

### GAS（Google Apps Script）

| ファイル | 行数 | 役割 |
|----------|------|------|
| 01_Config.gs | ~145 | スプレッドシート設定、スクリプトプロパティ管理 |
| 02_DataService.gs | ~700 | データアクセス層（全シートのCRUD操作） |
| 03_AuthService.gs | ~120 | 認証・セッション管理（UserProperties使用） |
| 04_ShiftService.gs | ~430 | 6種類のルールチェック |
| 05_CalendarService.gs | ~335 | Googleカレンダー連携（イベント作成・更新・削除） |
| 06_Code.gs | ~1005 | doGet/doPost、カスタムメニュー、全APIエンドポイント |
| 07_index.html | ~1800 | Webアプリ（SPA）、Tailwind CSS |
| 08_CSVService.gs | ~615 | CSV入出力、Webhook処理、Driveアクセス |

---

## トラブルシューティング

### カスタムメニューが表示されない

**原因:** onOpenトリガーが設定されていない

**対処法:**
1. GASエディタで `トリガー → トリガーを追加`
2. 関数: `onOpen`、イベント: スプレッドシートから起動時
3. ページをリロード（F5）

### 「スプレッドシートIDが設定されていません」エラー

**対処法:**
1. GASエディタで `プロジェクトの設定 → スクリプト プロパティ`
2. `SPREADSHEET_ID` を追加

### CSV出力で「フォルダIDが設定されていません」エラー

**対処法:**
1. スクリプトプロパティで以下を確認：
   - `DRIVE_FOLDER_INPUT`
   - `DRIVE_FOLDER_OUTPUT`
   - `DRIVE_FOLDER_ARCHIVE`

### Webhook通知失敗（401エラー）

**対処法:**
1. GAS側: スクリプトプロパティの `WEBHOOK_TOKEN` を確認
2. Python側: 同じトークン値を設定
3. Webアプリを再デプロイ

### CSV取込で「形式エラー」

**正しいヘッダー形式:**
```
確定シフトID,氏名,グループ,シフト名,勤務開始日,開始時間,勤務終了日,終了時間,登録日時,カレンダーイベントID
```

### Drive認証が失敗する

**対処法:**
1. GAS: Apps Scriptエディタで任意の関数を「実行」→ 権限承認
2. Python: `auth.authenticate_user()` を再実行
3. 組織のポリシー制限を確認

### ログインできない

**対処法:**
1. M_職員シートで該当ユーザーの「有効」がTRUEか確認
2. ログインID/パスワードが正しいか確認
3. Webアプリを再デプロイ

---

## 技術要件

### アーキテクチャ

- **SPA (Single Page Application)**: doGetで単一HTMLを返し、以降はJavaScriptによるDOM操作
- **サーバー通信**: `google.script.run` を非同期で使用
- **セッション管理**: `PropertiesService.getUserProperties()` で管理

### デザイン・UI

- **Tailwind CSS**: CDNリンク使用
- **レスポンシブ対応**: モバイルファースト設計

### セキュリティ

- **Webアプリ公開設定**: Execute as: Me（管理者）、Who has access: Anyone
- **アプリケーション認証**: 独自ログイン画面でID/PW認証
- **Webhook認証**: トークンベース認証（スクリプトプロパティで管理）
- **注意**: パスワードは平文でシートに保存（本番環境では暗号化推奨）

### ログ・デバッグ

- `console.log` / `console.error` でログ出力
- Apps Scriptダッシュボードの「実行数」でトレース可能

---

## 注意事項

### Python最適化アルゴリズムについて

- Python側で高精度な最適化を実行
- 制約条件を厳格に適用
- 完全に最適解が見つからない場合もあるため、手修正が必要な場合あり

### 手修正の推奨

- 最適化アルゴリズムの結果は「高精度なたたき台」
- 現場の細かい事情（個別の配慮、イベント対応など）は手修正で対応
- **シフト修正画面で確認してからカレンダー登録**

### Webhook連携

- Colabからの通知が失敗した場合、シフト管理画面から手動でCSV取込を実行
- Webhookトークンは定期的に変更を推奨

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|----------|
| v2.0 | 2025-01-05 | README.md統合・最新化 |
| v2.0 | 2025-11-28 | Python最適化システムへ完全移行 |
| v1.0 | - | 初版リリース（GAS単独） |

---

## ライセンス

このプロジェクトは内部利用を目的としています。

---

## サポート

問題が発生した場合は、以下を確認してください：

1. GAS実行ログ（Apps Script Editor → 実行数）
2. Colab出力ログ
3. Drive内のCSVファイル
4. スクリプトプロパティの設定値
5. M_設定シートの設定値
