<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚·ãƒ•ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .calendar-day {
      min-height: 40px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .calendar-day:hover {
      transform: scale(1.05);
    }

    .calendar-day.selected {
      background-color: #3b82f6;
      color: white;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
  <div id="loading" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-lg shadow-xl">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
      <p class="mt-4 text-gray-700">èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
  <div id="app" class="hidden">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-blue-600 text-white shadow-lg">
      <div class="container mx-auto px-4 py-4">
        <div class="flex justify-between items-center">
          <h1 class="text-2xl font-bold">ğŸ“… ã‚·ãƒ•ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
          <div id="userInfo" class="hidden">
            <span id="userName" class="mr-4"></span>
            <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded transition">
              ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç®¡ç†è€…ã®ã¿è¡¨ç¤ºï¼‰ -->
    <nav id="adminNav" class="bg-white shadow-md hidden">
      <div class="container mx-auto px-4">
        <ul class="flex space-x-4 py-3">
          <li>
            <button onclick="showView('holiday-request')" class="nav-btn px-4 py-2 rounded hover:bg-blue-100 transition">
              ä¼‘ã¿å¸Œæœ›æå‡º
            </button>
          </li>
          <li>
            <button onclick="showView('shift-management')" class="nav-btn px-4 py-2 rounded hover:bg-blue-100 transition bg-green-50 border border-green-200">
              ã‚·ãƒ•ãƒˆç®¡ç†
            </button>
          </li>
          <li>
            <button onclick="showView('shift-edit')" class="nav-btn px-4 py-2 rounded hover:bg-blue-100 transition bg-orange-50 border border-orange-200">
              ã‚·ãƒ•ãƒˆä¿®æ­£
            </button>
          </li>
          <li>
            <button onclick="showView('staff-master')" class="nav-btn px-4 py-2 rounded hover:bg-blue-100 transition">
              è·å“¡ãƒã‚¹ã‚¿ç®¡ç†
            </button>
          </li>
          <li>
            <button onclick="showView('shift-master')" class="nav-btn px-4 py-2 rounded hover:bg-blue-100 transition">
              ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ç®¡ç†
            </button>
          </li>
          <li>
            <button onclick="showView('shift-assignment')"
              class="nav-btn px-4 py-2 rounded hover:bg-blue-100 transition bg-purple-50 border border-purple-200">
              å‹¤å‹™æŒ‡å®š
            </button>
          </li>
        </ul>
      </div>
    </nav>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="container mx-auto px-4 py-8">

      <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
      <div id="loginView" class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-8">
        <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">ãƒ­ã‚°ã‚¤ãƒ³</h2>
        <form onsubmit="handleLogin(event)" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ­ã‚°ã‚¤ãƒ³ID</label>
            <input type="text" id="loginId" required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input type="password" id="loginPassword" required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <button type="submit"
            class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-semibold">
            ãƒ­ã‚°ã‚¤ãƒ³
          </button>
        </form>
        <div id="loginError" class="mt-4 text-red-600 text-sm hidden"></div>
      </div>

      <!-- ä¼‘ã¿å¸Œæœ›æå‡ºç”»é¢ -->
      <div id="holidayRequestView" class="hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold mb-6 text-gray-800">ä¼‘ã¿å¸Œæœ›æå‡º</h2>

          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">å¯¾è±¡æœˆ</label>
            <input type="month" id="targetMonth"
              class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              onchange="loadHolidayRequest()">
          </div>

          <div id="lockMessage" class="hidden mb-4 p-4 bg-yellow-100 border border-yellow-400 rounded-lg">
            <p class="text-yellow-800">âš ï¸ ã“ã®æœˆã®æå‡ºã¯ç· ã‚åˆ‡ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚é–²è¦§ã®ã¿å¯èƒ½ã§ã™ã€‚</p>
          </div>

          <!-- ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç®¡ç†è€…ã®ã¿è¡¨ç¤ºï¼‰ -->
          <div id="eventManagementSection" class="mb-6 hidden">
            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
              <div class="flex justify-between items-center mb-3">
                <h3 class="text-md font-semibold text-orange-800">ã‚¤ãƒ™ãƒ³ãƒˆãƒ»äºˆå®šç®¡ç†ï¼ˆç®¡ç†è€…ï¼‰</h3>
                <button onclick="toggleEventForm()"
                  class="text-orange-700 hover:text-orange-900 text-sm underline">
                  + ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
                </button>
              </div>
              <div id="eventAddForm" class="hidden mb-3 p-3 bg-white border border-orange-200 rounded">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" id="eventTitle"
                      class="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                      placeholder="å…¨ä½“ä¼šè­° ãªã©">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">æ—¥ä»˜</label>
                    <input type="date" id="eventDate"
                      class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">å‚™è€ƒ</label>
                    <input type="text" id="eventNotes"
                      class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                  </div>
                </div>
                <button onclick="addEvent()"
                  class="bg-orange-600 text-white px-4 py-1 rounded hover:bg-orange-700 transition text-sm">
                  è¿½åŠ 
                </button>
                <span id="eventAddMsg" class="ml-2 text-sm"></span>
              </div>
              <div id="eventList" class="text-sm text-gray-700">
                ã‚¤ãƒ™ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...
              </div>
            </div>
          </div>

          <div id="calendar" class="mb-6"></div>

          <!-- é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã¨å„ªå…ˆé †ä½ã®ä¸€è¦§ -->
          <div id="selectedDatesContainer" class="mb-6 hidden">
            <h3 class="text-lg font-semibold text-gray-800 mb-3">é¸æŠã•ã‚ŒãŸä¼‘ã¿å¸Œæœ›</h3>
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
              <table class="w-full">
                <thead>
                  <tr class="border-b">
                    <th class="text-left py-2 px-2 text-sm font-medium text-gray-700">æ—¥ä»˜</th>
                    <th class="text-left py-2 px-2 text-sm font-medium text-gray-700">å„ªå…ˆé †ä½</th>
                    <th class="text-center py-2 px-2 text-sm font-medium text-gray-700">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="selectedDatesList">
                </tbody>
              </table>
            </div>
          </div>

          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">ç‰¹è¨˜äº‹é …</label>
            <textarea id="requestNotes" rows="3"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              placeholder="ç‰¹è¨˜äº‹é …ãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
          </div>

          <div class="flex space-x-4">
            <button onclick="saveHolidayRequest()" id="saveButton"
              class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-semibold">
              ä¿å­˜
            </button>
            <button onclick="clearHolidayRequest()"
              class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition font-semibold">
              ã‚¯ãƒªã‚¢
            </button>
          </div>

          <div id="holidayMessage" class="mt-4 hidden"></div>
        </div>
      </div>

      <!-- è·å“¡ãƒã‚¹ã‚¿ç®¡ç†ç”»é¢ -->
      <div id="staffMasterView" class="hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold mb-6 text-gray-800">è·å“¡ãƒã‚¹ã‚¿ç®¡ç†</h2>

          <div class="mb-4">
            <button onclick="showStaffForm()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">
              + æ–°è¦è¿½åŠ 
            </button>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ°å</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">å½¹è·</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ã‚°ãƒ«ãƒ¼ãƒ—</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">é›‡ç”¨å½¢æ…‹</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æœ‰åŠ¹</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="staffTableBody" class="bg-white divide-y divide-gray-200">
                <!-- ã“ã“ã«è·å“¡ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- è·å“¡ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ -->
        <div id="staffFormModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full max-h-screen overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">è·å“¡æƒ…å ±ç·¨é›†</h3>
            <form onsubmit="saveStaffData(event)" class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">è·å“¡ID</label>
                  <input type="text" id="staff_id" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">æ°å</label>
                  <input type="text" id="staff_name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">å½¹è·</label>
                  <input type="text" id="staff_role" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ã‚°ãƒ«ãƒ¼ãƒ—</label>
                  <select id="staff_group" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">é›‡ç”¨å½¢æ…‹</label>
                  <select id="staff_employment" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="å¸¸å‹¤">å¸¸å‹¤</option>
                    <option value="ãƒ‘ãƒ¼ãƒˆ">ãƒ‘ãƒ¼ãƒˆ</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ãƒ­ã‚°ã‚¤ãƒ³ID</label>
                  <input type="text" id="staff_login_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                  <input type="password" id="staff_password" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID</label>
                  <input type="text" id="staff_calendar_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div class="flex items-center">
                  <input type="checkbox" id="staff_qualified" class="mr-2">
                  <label class="text-sm font-medium text-gray-700">å–€ç—°å¸å¼•è³‡æ ¼è€…</label>
                </div>
                <div class="flex items-center">
                  <input type="checkbox" id="staff_care_required" class="mr-2">
                  <label class="text-sm font-medium text-gray-700">å‹¤å‹™é…æ…®</label>
                </div>
                <div class="flex items-center">
                  <input type="checkbox" id="staff_active" class="mr-2" checked>
                  <label class="text-sm font-medium text-gray-700">æœ‰åŠ¹</label>
                </div>
              </div>

              <div class="flex space-x-4 mt-6">
                <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">
                  ä¿å­˜
                </button>
                <button type="button" onclick="closeStaffForm()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition">
                  ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ç®¡ç†ç”»é¢ -->
      <div id="shiftMasterView" class="hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold mb-6 text-gray-800">ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ç®¡ç†</h2>

          <div class="mb-4">
            <button onclick="showShiftMasterForm()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">
              + æ–°è¦è¿½åŠ 
            </button>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ã‚·ãƒ•ãƒˆå</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">é–‹å§‹æ™‚é–“</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">çµ‚äº†æ™‚é–“</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">å‚™è€ƒ</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="shiftMasterTableBody" class="bg-white divide-y divide-gray-200">
                <!-- ã“ã“ã«ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ -->
        <div id="shiftMasterFormModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full max-h-screen overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ç·¨é›†</h3>
            <form onsubmit="saveShiftMasterData(event)" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ã‚·ãƒ•ãƒˆID</label>
                <input type="text" id="shift_id" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" readonly>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ã‚·ãƒ•ãƒˆå <span class="text-red-500">*</span></label>
                <input type="text" id="shift_name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">é–‹å§‹æ™‚é–“ (HH:MM)</label>
                  <input type="time" id="shift_start_time" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">çµ‚äº†æ™‚é–“ (HH:MM)</label>
                  <input type="time" id="shift_end_time" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">å‚™è€ƒ</label>
                <textarea id="shift_notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
              </div>

              <div class="flex space-x-4 mt-6">
                <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">
                  ä¿å­˜
                </button>
                <button type="button" onclick="closeShiftMasterForm()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition">
                  ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- ã‚·ãƒ•ãƒˆç®¡ç†ç”»é¢ï¼ˆç®¡ç†è€…å°‚ç”¨ï¼‰ -->
      <div id="shiftManagementView" class="hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold mb-6 text-gray-800">ã‚·ãƒ•ãƒˆç®¡ç†</h2>
          <p class="text-gray-600 mb-6">ã‚·ãƒ•ãƒˆä½œæˆã«å¿…è¦ãªCSVå‡ºåŠ›ã‚„ã€æå‡ºç· åˆ‡ã®ç®¡ç†ã‚’è¡Œã„ã¾ã™ã€‚</p>

          <!-- å¯¾è±¡æœˆé¸æŠ -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">å¯¾è±¡æœˆ</label>
            <input type="month" id="shiftMgmtTargetMonth"
              class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              onchange="loadShiftManagementStatus()">
          </div>

          <!-- æœˆæ¬¡è¨­å®šã‚«ãƒ¼ãƒ‰ -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- å…¬ä¼‘æ—¥æ•°è¨­å®š -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <h3 class="text-lg font-semibold text-blue-800 mb-3">å…¬ä¼‘æ—¥æ•°è¨­å®š</h3>
              <div class="flex items-center space-x-4">
                <input type="number" id="monthlyHolidaysInput" min="1" max="31"
                  class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-center text-lg font-bold">
                <span class="text-gray-700">æ—¥</span>
                <button onclick="saveMonthlyHolidays()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                  ä¿å­˜
                </button>
              </div>
              <p class="text-sm text-blue-600 mt-2">è·å“¡ãŒé¸æŠã§ãã‚‹ä¼‘ã¿å¸Œæœ›ã®ä¸Šé™æ•°ã§ã™</p>
            </div>

            <!-- æå‡ºç· åˆ‡è¨­å®š -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
              <h3 class="text-lg font-semibold text-yellow-800 mb-3">æå‡ºç· åˆ‡è¨­å®š</h3>
              <div id="submissionLockStatus" class="mb-3">
                <!-- çŠ¶æ…‹ãŒå‹•çš„ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
              </div>
              <div class="flex space-x-2">
                <button onclick="toggleSubmissionLock(true)" id="lockButton" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">
                  ç· åˆ‡ï¼ˆãƒ­ãƒƒã‚¯ï¼‰
                </button>
                <button onclick="toggleSubmissionLock(false)" id="unlockButton" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                  å—ä»˜ä¸­ï¼ˆè§£é™¤ï¼‰
                </button>
              </div>
            </div>
          </div>

          <!-- ã‚·ãƒ•ãƒˆä½œæˆãƒ•ãƒ­ãƒ¼ -->
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">ã‚·ãƒ•ãƒˆä½œæˆãƒ•ãƒ­ãƒ¼</h3>

            <div class="space-y-4">
              <!-- ã‚¹ãƒ†ãƒƒãƒ—1: CSVå‡ºåŠ› -->
              <div class="flex items-start space-x-4 p-4 bg-white rounded-lg border border-gray-200">
                <div class="flex-shrink-0 w-10 h-10 bg-green-500 text-white rounded-full flex items-center justify-center font-bold">1</div>
                <div class="flex-grow">
                  <h4 class="font-semibold text-gray-800">ã‚·ãƒ•ãƒˆä½œæˆç”¨CSVä¸€æ‹¬å‡ºåŠ›</h4>
                  <p class="text-sm text-gray-600 mb-3">ã‚·ãƒ•ãƒˆæœ€é©åŒ–ã«å¿…è¦ãª3ç¨®é¡ã®CSVã‚’Googleãƒ‰ãƒ©ã‚¤ãƒ–ã«å‡ºåŠ›ã—ã¾ã™ã€‚</p>
                  <ul class="text-xs text-gray-500 mb-3 list-disc list-inside">
                    <li>T_ä¼‘ã¿å¸Œæœ›_YYYYMM.csv - ä¼‘ã¿å¸Œæœ›ãƒ‡ãƒ¼ã‚¿</li>
                    <li>M_è·å“¡_YYYYMM.csv - è·å“¡ãƒã‚¹ã‚¿</li>
                    <li>M_è¨­å®š_YYYYMM.csv - æœˆé–“è¨­å®š</li>
                  </ul>
                  <button onclick="exportAllCSVForShiftCreation()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">
                    3ç¨®CSVä¸€æ‹¬å‡ºåŠ›
                  </button>
                  <div id="csvExportResult" class="mt-2 text-sm"></div>
                </div>
              </div>

              <!-- ã‚¹ãƒ†ãƒƒãƒ—2: Pythonå®Ÿè¡Œï¼ˆèª¬æ˜ã®ã¿ï¼‰ -->
              <div class="flex items-start space-x-4 p-4 bg-white rounded-lg border border-gray-200">
                <div class="flex-shrink-0 w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold">2</div>
                <div class="flex-grow">
                  <h4 class="font-semibold text-gray-800">ã‚·ãƒ•ãƒˆæœ€é©åŒ–å®Ÿè¡Œï¼ˆGoogle Colabï¼‰</h4>
                  <p class="text-sm text-gray-600">Google Colabã§ã‚·ãƒ•ãƒˆæœ€é©åŒ–Pythonã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
                  <p class="text-sm text-gray-500 mt-1">â†’ çµæœCSVãŒGoogleãƒ‰ãƒ©ã‚¤ãƒ–ã®outputãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
                </div>
              </div>

              <!-- ã‚¹ãƒ†ãƒƒãƒ—3: CSVå–è¾¼ -->
              <div class="flex items-start space-x-4 p-4 bg-white rounded-lg border border-gray-200">
                <div class="flex-shrink-0 w-10 h-10 bg-purple-500 text-white rounded-full flex items-center justify-center font-bold">3</div>
                <div class="flex-grow">
                  <h4 class="font-semibold text-gray-800">ã‚·ãƒ•ãƒˆçµæœCSVå–è¾¼</h4>
                  <p class="text-sm text-gray-600 mb-3">å¯¾è±¡æœˆã®ã‚·ãƒ•ãƒˆçµæœCSVã‚’è‡ªå‹•ã§æ¤œç´¢ã—ã¦å–ã‚Šè¾¼ã¿ã¾ã™ã€‚</p>
                  <p class="text-xs text-gray-500 mb-3">å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«: ã‚·ãƒ•ãƒˆçµæœ_YYYYMM.csv</p>
                  <button onclick="importShiftCSVByMonth()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition">
                    ã‚·ãƒ•ãƒˆçµæœå–è¾¼
                  </button>
                  <div id="csvImportResult" class="mt-2 text-sm"></div>
                </div>
              </div>

              <!-- ã‚¹ãƒ†ãƒƒãƒ—4: ç¢ºèªãƒ»ä¿®æ­£ãƒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç™»éŒ² -->
              <div class="flex items-start space-x-4 p-4 bg-white rounded-lg border border-orange-300 bg-orange-50">
                <div class="flex-shrink-0 w-10 h-10 bg-orange-500 text-white rounded-full flex items-center justify-center font-bold">4</div>
                <div class="flex-grow">
                  <h4 class="font-semibold text-gray-800">ã‚·ãƒ•ãƒˆç¢ºèªãƒ»ä¿®æ­£ãƒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç™»éŒ²</h4>
                  <p class="text-sm text-gray-600 mb-3">ã€Œã‚·ãƒ•ãƒˆä¿®æ­£ã€ç”»é¢ã§ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«ã‚·ãƒ•ãƒˆã‚’ç¢ºèªãƒ»ä¿®æ­£ã—ã€ç¢ºå®šã—ã¦ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ç™»éŒ²ã—ã¾ã™ã€‚</p>
                  <button onclick="showView('shift-edit')" class="bg-orange-600 text-white px-6 py-2 rounded-lg hover:bg-orange-700 transition">
                    ã‚·ãƒ•ãƒˆä¿®æ­£ç”»é¢ã¸
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div id="shiftManagementMessage" class="mt-4 hidden"></div>
        </div>
      </div>

      <!-- ã‚·ãƒ•ãƒˆä¿®æ­£ç”»é¢ -->
      <div id="shiftEditView" class="hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold mb-6 text-gray-800">ã‚·ãƒ•ãƒˆä¿®æ­£</h2>
          <p class="text-gray-600 mb-6">ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸æŠã—ã¦ã‚·ãƒ•ãƒˆã®ç¢ºèªãƒ»ä¿®æ­£ã‚’è¡Œã„ã¾ã™ã€‚</p>

          <!-- ã‚°ãƒ«ãƒ¼ãƒ—ãƒ»æœˆé¸æŠ -->
          <div class="flex flex-wrap gap-4 mb-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">å¯¾è±¡æœˆ</label>
              <input type="month" id="shiftEditTargetMonth"
                class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ã‚°ãƒ«ãƒ¼ãƒ—</label>
              <select id="shiftEditGroup"
                class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="">-- é¸æŠ --</option>
              </select>
            </div>
            <div class="flex items-end">
              <button onclick="loadShiftEditData()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                è¡¨ç¤º
              </button>
            </div>
          </div>

          <!-- ã‚·ãƒ•ãƒˆç·¨é›†ãƒ†ãƒ¼ãƒ–ãƒ« -->
          <div id="shiftEditTableContainer" class="hidden">
            <!-- å‡¡ä¾‹ -->
            <div class="mb-4 flex flex-wrap gap-4 text-sm">
              <span class="flex items-center"><span class="w-4 h-4 bg-blue-100 border border-blue-300 mr-1"></span>åœŸæ›œæ—¥</span>
              <span class="flex items-center"><span class="w-4 h-4 bg-pink-100 border border-pink-300 mr-1"></span>æ—¥æ›œãƒ»ç¥æ—¥</span>
            </div>

            <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚³ãƒ³ãƒ†ãƒŠ -->
            <div class="overflow-x-auto border border-gray-200 rounded-lg mb-6">
              <table id="shiftEditTable" class="min-w-full text-sm">
                <thead class="bg-gray-50">
                  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã¯å‹•çš„ã«ç”Ÿæˆ -->
                </thead>
                <tbody>
                  <!-- ãƒ‡ãƒ¼ã‚¿ã¯å‹•çš„ã«ç”Ÿæˆ -->
                </tbody>
              </table>
            </div>

            <!-- çµ±è¨ˆãƒ†ãƒ¼ãƒ–ãƒ« -->
            <div class="mb-6">
              <h3 class="text-lg font-semibold text-gray-800 mb-3">ã‚·ãƒ•ãƒˆé›†è¨ˆ</h3>
              <div class="overflow-x-auto border border-gray-200 rounded-lg">
                <table id="shiftStatsTable" class="min-w-full text-sm">
                  <thead class="bg-gray-50">
                    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã¯å‹•çš„ã«ç”Ÿæˆ -->
                  </thead>
                  <tbody>
                    <!-- ãƒ‡ãƒ¼ã‚¿ã¯å‹•çš„ã«ç”Ÿæˆ -->
                  </tbody>
                </table>
              </div>
            </div>

            <!-- ç¢ºå®šãƒœã‚¿ãƒ³ -->
            <div class="flex justify-end space-x-4">
              <button onclick="confirmAndRegisterCalendar()" class="bg-red-600 text-white px-8 py-3 rounded-lg hover:bg-red-700 transition font-semibold">
                ç¢ºå®šã—ã¦ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç™»éŒ²
              </button>
            </div>
          </div>

          <!-- è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆãƒ‘ãƒãƒ« -->
          <div id="diagnosticsPanel" class="hidden mt-6">
            <div class="bg-white border border-gray-200 rounded-lg p-6">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆ</h3>
                <button onclick="runDiagnostics()"
                  class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition text-sm">
                  è¨ºæ–­ã‚’å®Ÿè¡Œ
                </button>
              </div>
              <div id="diagnosticsResult" class="hidden">
                <div id="diagnosticsSummary" class="flex gap-4 mb-4"></div>
                <div id="diagnosticsList"></div>
              </div>
              <p id="diagnosticsEmpty" class="text-gray-500 text-sm">
                ã€Œè¨ºæ–­ã‚’å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ç¾åœ¨ã®ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ã®ãƒ«ãƒ¼ãƒ«é•åã‚’ç¢ºèªã§ãã¾ã™ã€‚
              </p>
            </div>
          </div>

          <div id="shiftEditMessage" class="mt-4 hidden"></div>
        </div>
      </div>

      <!-- å‹¤å‹™æŒ‡å®šç®¡ç†ç”»é¢ï¼ˆç®¡ç†è€…å°‚ç”¨ï¼‰ -->
      <div id="shiftAssignmentView" class="hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold mb-4 text-gray-800">äº‹å‰å‹¤å‹™æŒ‡å®šï¼ˆã‚·ãƒ•ãƒˆå›ºå®šï¼‰</h2>
          <p class="text-gray-600 mb-4 text-sm bg-yellow-50 border border-yellow-200 rounded p-3">
            è‡ªå‹•ã‚·ãƒ•ãƒˆä½œæˆå‰ã«ç‰¹å®šã®è·å“¡ã®ç‰¹å®šæ—¥ã®ã‚·ãƒ•ãƒˆã‚’å›ºå®šã§ãã¾ã™ã€‚
            3ç¨®CSVå‡ºåŠ›æ™‚ã« M_è¨­å®š.csv ã«å«ã¾ã‚Œã¾ã™ã€‚
          </p>
          <div class="mb-4 flex gap-2">
            <input type="month" id="shiftAssignTargetMonth"
              class="px-4 py-2 border border-gray-300 rounded-lg">
            <button onclick="loadShiftAssignments()"
              class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">
              è¡¨ç¤º
            </button>
          </div>
          <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">
            <h3 class="text-md font-semibold text-purple-800 mb-3">æ–°è¦å‹¤å‹™æŒ‡å®šã‚’è¿½åŠ </h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">è·å“¡å</label>
                <select id="assignStaffName"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                  <option value="">-- é¸æŠ --</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">æ—¥ä»˜</label>
                <input type="date" id="assignDate"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">ã‚·ãƒ•ãƒˆ</label>
                <select id="assignShiftName"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                  <option value="">-- é¸æŠ --</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">å‚™è€ƒ</label>
                <input type="text" id="assignNotes"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
              </div>
            </div>
            <div class="mt-3">
              <button onclick="addShiftAssignment()"
                class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition text-sm">
                æŒ‡å®šã‚’è¿½åŠ 
              </button>
            </div>
            <p id="assignmentAddMessage" class="mt-2 text-sm hidden"></p>
          </div>
          <h3 class="text-md font-semibold text-gray-800 mb-3">å‹¤å‹™æŒ‡å®šä¸€è¦§</h3>
          <div class="overflow-x-auto border border-gray-200 rounded-lg">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">æ—¥ä»˜</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">è·å“¡å</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">G</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">ã‚·ãƒ•ãƒˆ</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">å‚™è€ƒ</th>
                  <th class="px-4 py-2 text-center text-xs font-medium text-gray-500">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="assignmentTableBody" class="bg-white divide-y divide-gray-200">
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </main>
  </div>

  <script>
    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let currentSession = null;
    // é¸æŠã•ã‚ŒãŸä¼‘ã¿å¸Œæœ›: [{day: æ•°å€¤, priority: æ•°å€¤}]
    let selectedRequests = [];
    // æœˆé–“å…¬ä¼‘æ•°ï¼ˆå„ªå…ˆé †ä½ã®ä¸Šé™ï¼‰
    let maxHolidays = 9;

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
    window.onload = function() {
      hideLoading();
      showView('login');
    };

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    function showLoading() {
      document.getElementById('loading').classList.remove('hidden');
    }

    function hideLoading() {
      document.getElementById('loading').classList.add('hidden');
    }

    // ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
    function showView(viewName) {
      // ãƒã‚¤ãƒ•ãƒ³åŒºåˆ‡ã‚Šã®åå‰ã‚’ã‚­ãƒ£ãƒ¡ãƒ«ã‚±ãƒ¼ã‚¹ã®IDã«å¤‰æ›
      const viewIdMap = {
        'login': 'loginView',
        'holiday-request': 'holidayRequestView',
        'staff-master': 'staffMasterView',
        'shift-master': 'shiftMasterView',
        'shift-management': 'shiftManagementView',
        'shift-edit': 'shiftEditView',
        'shift-assignment': 'shiftAssignmentView'
      };

      const viewId = viewIdMap[viewName] || viewName;

      const views = ['loginView', 'holidayRequestView', 'staffMasterView', 'shiftMasterView', 'shiftManagementView', 'shiftEditView', 'shiftAssignmentView'];
      views.forEach(v => {
        document.getElementById(v).classList.add('hidden');
      });

      if (viewName === 'login') {
        document.getElementById('loginView').classList.remove('hidden');
        document.getElementById('app').classList.remove('hidden');
        document.getElementById('userInfo').classList.add('hidden');
        document.getElementById('adminNav').classList.add('hidden');
      } else {
        document.getElementById(viewId).classList.remove('hidden');
        document.getElementById('app').classList.remove('hidden');
        document.getElementById('userInfo').classList.remove('hidden');

        if (currentSession && currentSession.isAdmin) {
          document.getElementById('adminNav').classList.remove('hidden');
        }

        // ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºæ™‚ã®å‡¦ç†
        if (viewId === 'holidayRequestView') {
          initHolidayRequestView();
        } else if (viewId === 'staffMasterView') {
          loadStaffList();
        } else if (viewId === 'shiftMasterView') {
          loadShiftMasterList();
        } else if (viewId === 'shiftManagementView') {
          initShiftManagementView();
        } else if (viewId === 'shiftEditView') {
          initShiftEditView();
        } else if (viewId === 'shiftAssignmentView') {
          initShiftAssignmentView();
        }
      }
    }

    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    function handleLogin(event) {
      event.preventDefault();
      showLoading();

      const loginId = document.getElementById('loginId').value;
      const password = document.getElementById('loginPassword').value;

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            currentSession = result.session;
            document.getElementById('userName').textContent = result.session.name;
            document.getElementById('loginError').classList.add('hidden');
            showView('holiday-request');
          } else {
            document.getElementById('loginError').textContent = result.message;
            document.getElementById('loginError').classList.remove('hidden');
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          document.getElementById('loginError').textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
          document.getElementById('loginError').classList.remove('hidden');
          console.error(error);
        })
        .apiLogin(loginId, password);
    }

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    function logout() {
      showLoading();
      google.script.run
        .withSuccessHandler(function() {
          currentSession = null;
          hideLoading();
          showView('login');
        })
        .withFailureHandler(function(error) {
          hideLoading();
          console.error(error);
        })
        .apiLogout();
    }

    // ä¼‘ã¿å¸Œæœ›æå‡ºç”»é¢ã®åˆæœŸåŒ–
    function initHolidayRequestView() {
      const now = new Date();
      document.getElementById('targetMonth').value =
        now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
      if (currentSession && currentSession.isAdmin) {
        document.getElementById('eventManagementSection').classList.remove('hidden');
      }
      loadHolidayRequest();
    }

    // ä¼‘ã¿å¸Œæœ›èª­ã¿è¾¼ã¿
    function loadHolidayRequest() {
      const targetMonth = document.getElementById('targetMonth').value;
      if (!targetMonth) return;

      const [year, month] = targetMonth.split('-').map(Number);
      const configKey = `MONTHLY_HOLIDAYS_${year}${String(month).padStart(2, '0')}`;

      showLoading();

      // ã¾ãšå…¬ä¼‘æ•°ã‚’å–å¾—ã—ã¦ã‹ã‚‰ä¼‘ã¿å¸Œæœ›ã‚’èª­ã¿è¾¼ã‚€
      google.script.run
        .withSuccessHandler(function(configResult) {
          // å…¬ä¼‘æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
          maxHolidays = configResult.value ? parseInt(configResult.value) : 9;
          console.log(`å…¬ä¼‘æ•°ã‚’å–å¾—: ${maxHolidays}æ—¥`);

          // ä¼‘ã¿å¸Œæœ›ã‚’èª­ã¿è¾¼ã‚€
          google.script.run
            .withSuccessHandler(function(result) {
              if (result.success) {
                google.script.run
                  .withSuccessHandler(function(evResult) {
                    hideLoading();
                    var events = evResult.success ? evResult.events : [];
                    renderCalendar(year, month, result.data, events);
                  })
                  .withFailureHandler(function(e) {
                    hideLoading();
                    renderCalendar(year, month, result.data, []);
                    console.error(e);
                  })
                  .apiGetEventsByMonth(year, month);
              }
            })
            .withFailureHandler(function(error) {
              hideLoading();
              console.error(error);
            })
            .apiGetHolidayRequest(currentSession.name, year, month);
        })
        .withFailureHandler(function(error) {
          console.error('å…¬ä¼‘æ•°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          maxHolidays = 9; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤

          // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ä¼‘ã¿å¸Œæœ›ã¯èª­ã¿è¾¼ã‚€
          google.script.run
            .withSuccessHandler(function(result) {
              if (result.success) {
                google.script.run
                  .withSuccessHandler(function(evResult) {
                    hideLoading();
                    var events = evResult.success ? evResult.events : [];
                    renderCalendar(year, month, result.data, events);
                  })
                  .withFailureHandler(function(e) {
                    hideLoading();
                    renderCalendar(year, month, result.data, []);
                    console.error(e);
                  })
                  .apiGetEventsByMonth(year, month);
              }
            })
            .withFailureHandler(function(error) {
              hideLoading();
              console.error(error);
            })
            .apiGetHolidayRequest(currentSession.name, year, month);
        })
        .apiGetConfig(configKey);

      // ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
      checkSubmissionLock(year, month);

      // å…¬ä¼‘ä¸Šé™ã‚’è¡¨ç¤º
      displayHolidayLimit(year, month);
    }

    // å…¬ä¼‘ä¸Šé™ã‚’è¡¨ç¤º
    function displayHolidayLimit(year, month) {
      const configKey = `MONTHLY_HOLIDAYS_${year}${String(month).padStart(2, '0')}`;

      google.script.run
        .withSuccessHandler(function(result) {
          const maxHolidays = result.value ? parseFloat(result.value) : 9;
          const daysInMonth = new Date(year, month, 0).getDate();

          // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ä¸Šã«æƒ…å ±ã‚’è¡¨ç¤º
          const calendar = document.getElementById('calendar');
          const infoDiv = document.createElement('div');
          infoDiv.className = 'mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm';
          infoDiv.innerHTML = `
            <p class="font-semibold text-blue-800">ğŸ“… ${year}å¹´${month}æœˆã®æƒ…å ±</p>
            <p class="text-blue-700">â€¢ æš¦æ—¥æ•°: ${daysInMonth}æ—¥</p>
            <p class="text-blue-700">â€¢ æœˆé–“å…¬ä¼‘ä¸Šé™: <span class="font-bold text-lg">${maxHolidays}æ—¥</span></p>
            <p class="text-blue-700">â€¢ ç¾åœ¨é¸æŠä¸­: <span id="selectedCount" class="font-bold text-lg">${selectedDates.length}æ—¥</span></p>
          `;

          // æ—¢å­˜ã®æƒ…å ±è¡¨ç¤ºãŒã‚ã‚Œã°å‰Šé™¤
          const existingInfo = calendar.previousElementSibling;
          if (existingInfo && existingInfo.classList.contains('bg-blue-50')) {
            existingInfo.remove();
          }

          calendar.parentNode.insertBefore(infoDiv, calendar);
        })
        .apiGetConfig(configKey);
    }

    // æå‡ºãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
    function checkSubmissionLock(year, month) {
      const lockKey = `SUBMISSION_LOCK_${year}${String(month).padStart(2, '0')}`;

      google.script.run
        .withSuccessHandler(function(result) {
          const isLocked = result.value === 'TRUE' || result.value === true;
          const lockMessage = document.getElementById('lockMessage');
          const saveButton = document.getElementById('saveButton');

          if (isLocked) {
            lockMessage.classList.remove('hidden');
            saveButton.disabled = true;
            saveButton.classList.add('opacity-50', 'cursor-not-allowed');
          } else {
            lockMessage.classList.add('hidden');
            saveButton.disabled = false;
            saveButton.classList.remove('opacity-50', 'cursor-not-allowed');
          }
        })
        .apiGetConfig(lockKey);
    }

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
    function renderCalendar(year, month, existingRequests, events) {
      events = events || [];
      // æ—¥â†’ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆã®ãƒãƒƒãƒ—
      var eventMap = {};
      events.forEach(function(e) {
        var day = parseInt(e['æ—¥ä»˜'].split('-')[2]);
        if (!eventMap[day]) eventMap[day] = [];
        eventMap[day].push(e);
      });
      const calendarDiv = document.getElementById('calendar');
      calendarDiv.innerHTML = '';

      // existingRequestsã‹ã‚‰é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã¨å„ªå…ˆé †ä½ã‚’å¾©å…ƒ
      selectedRequests = existingRequests.map(req => ({
        day: new Date(req['æ—¥ä»˜']).getDate(),
        priority: req['å„ªå…ˆé †ä½'] || 1
      }));

      const daysInMonth = new Date(year, month, 0).getDate();
      const firstDay = new Date(year, month - 1, 1).getDay();

      let html = '<div class="grid grid-cols-7 gap-2">';

      // æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼
      const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      dayNames.forEach((name, index) => {
        const color = index === 0 ? 'text-red-600' : index === 6 ? 'text-blue-600' : 'text-gray-700';
        html += `<div class="text-center font-bold ${color}">${name}</div>`;
      });

      // ç©ºç™½ã‚»ãƒ«
      for (let i = 0; i < firstDay; i++) {
        html += '<div></div>';
      }

      // æ—¥ä»˜ã‚»ãƒ«
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month - 1, day);
        const dayOfWeek = date.getDay();
        const request = selectedRequests.find(r => r.day === day);
        const isSelected = !!request;

        let bgColor = isSelected ? 'bg-blue-500 text-white' : 'bg-white hover:bg-blue-100';
        let textColor = dayOfWeek === 0 ? 'text-red-600' : dayOfWeek === 6 ? 'text-blue-600' : 'text-gray-700';

        if (isSelected) {
          textColor = 'text-white';
        }

        // å„ªå…ˆé †ä½ãƒãƒƒã‚¸ã‚’è¡¨ç¤º
        const priorityBadge = isSelected ? `<span class="text-xs">ç¬¬${request.priority}å¸Œæœ›</span>` : '';

        html += `<div class="calendar-day ${isSelected ? 'selected' : ''} ${bgColor} ${textColor} border border-gray-300 rounded p-2 text-center cursor-pointer"
                     onclick="toggleDate(${day})">
                  <div class="font-bold">${day}</div>
                  ${priorityBadge}
                </div>`;
      }

      html += '</div>';
      calendarDiv.innerHTML = html;

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ¼ã‚«ãƒ¼ã‚’DOMæ“ä½œã§è¿½åŠ 
      var calendarDayEls = calendarDiv.querySelectorAll('.calendar-day');
      var dayIndex = 0;
      for (var d = 1; d <= daysInMonth; d++) {
        var dayEvents = eventMap[d] || [];
        if (dayEvents.length > 0) {
          var dayEl = calendarDiv.querySelector('.calendar-day[data-day="' + d + '"]');
          // data-dayå±æ€§ãŒãªã„å ´åˆã¯ä½ç½®ã§æ¢ã™
          if (!dayEl) {
            var allDayEls = calendarDiv.querySelectorAll('.calendar-day');
            allDayEls.forEach(function(el) {
              var boldEl = el.querySelector('.font-bold');
              if (boldEl && parseInt(boldEl.textContent) === d) {
                dayEl = el;
              }
            });
          }
          if (dayEl) {
            dayEvents.forEach(function(ev) {
              var evEl = document.createElement('div');
              evEl.className = 'mt-1 px-1 bg-orange-500 text-white text-xs rounded truncate';
              evEl.textContent = ev['ã‚¿ã‚¤ãƒˆãƒ«'];
              evEl.title = ev['ã‚¿ã‚¤ãƒˆãƒ«'] + (ev['å‚™è€ƒ'] ? ': ' + ev['å‚™è€ƒ'] : '');
              dayEl.appendChild(evEl);
            });
          }
        }
      }

      // é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã®ä¸€è¦§ã‚’æ›´æ–°
      renderSelectedRequestsList(year, month);
      renderEventList(events);
    }

    // æ—¥ä»˜é¸æŠãƒˆã‚°ãƒ«
    function toggleDate(day) {
      const requestIndex = selectedRequests.findIndex(r => r.day === day);
      if (requestIndex >= 0) {
        // æ—¢ã«é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å‰Šé™¤
        selectedRequests.splice(requestIndex, 1);
      } else {
        // å…¬ä¼‘æ•°ã‚’è¶…ãˆã¦ã„ã‚‹å ´åˆã¯è¿½åŠ ä¸å¯
        if (selectedRequests.length >= maxHolidays) {
          alert(`å…¬ä¼‘ä¸Šé™ï¼ˆ${maxHolidays}æ—¥ï¼‰ã«é”ã—ã¦ã„ã¾ã™ã€‚\nä»–ã®æ—¥ä»˜ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚`);
          return;
        }

        // æ¬¡ã«ä½¿ç”¨å¯èƒ½ãªå„ªå…ˆé †ä½ã‚’è‡ªå‹•å‰²ã‚Šå½“ã¦
        const usedPriorities = selectedRequests.map(r => r.priority);
        let nextPriority = 1;
        for (let p = 1; p <= maxHolidays; p++) {
          if (!usedPriorities.includes(p)) {
            nextPriority = p;
            break;
          }
        }

        selectedRequests.push({ day: day, priority: nextPriority });
      }

      const targetMonth = document.getElementById('targetMonth').value;
      const [year, month] = targetMonth.split('-').map(Number);

      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å†æç”»
      const existingRequests = selectedRequests.map(r => ({
        'æ—¥ä»˜': new Date(year, month - 1, r.day),
        'å„ªå…ˆé †ä½': r.priority
      }));
      renderCalendar(year, month, existingRequests);

      // é¸æŠä¸­ã®æ—¥æ•°ã‚’æ›´æ–°
      const selectedCountElem = document.getElementById('selectedCount');
      if (selectedCountElem) {
        selectedCountElem.textContent = `${selectedRequests.length}æ—¥`;
      }
    }

    // é¸æŠã•ã‚ŒãŸä¼‘ã¿å¸Œæœ›ã®ä¸€è¦§ã‚’è¡¨ç¤º
    function renderSelectedRequestsList(year, month) {
      const container = document.getElementById('selectedDatesContainer');
      const tbody = document.getElementById('selectedDatesList');

      if (selectedRequests.length === 0) {
        container.classList.add('hidden');
        return;
      }

      container.classList.remove('hidden');

      // ä½¿ç”¨ä¸­ã®å„ªå…ˆé †ä½ã‚’å–å¾—
      const usedPriorities = selectedRequests.map(r => r.priority);

      // å„ªå…ˆé †ä½ã§ã‚½ãƒ¼ãƒˆï¼ˆæ—¥ä»˜ã§ã¯ãªãå„ªå…ˆé †ä½é †ã«è¡¨ç¤ºï¼‰
      const sortedRequests = [...selectedRequests].sort((a, b) => a.priority - b.priority);

      let html = '';
      sortedRequests.forEach((request, index) => {
        // å…¬ä¼‘æ•°åˆ†ã®é¸æŠè‚¢ã‚’ç”Ÿæˆï¼ˆé‡è¤‡ç¦æ­¢ï¼‰
        const options = [];
        for (let p = 1; p <= maxHolidays; p++) {
          const isUsed = usedPriorities.includes(p) && p !== request.priority;
          const selected = p === request.priority ? 'selected' : '';
          const disabled = isUsed ? 'disabled' : '';
          const style = isUsed ? 'color: #ccc;' : '';
          options.push(`<option value="${p}" ${selected} ${disabled} style="${style}">ç¬¬${p}å¸Œæœ›${isUsed ? 'ï¼ˆä½¿ç”¨ä¸­ï¼‰' : ''}</option>`);
        }

        html += `
          <tr class="border-b">
            <td class="py-2 px-2">${month}æœˆ${request.day}æ—¥</td>
            <td class="py-2 px-2">
              <select onchange="updatePriority(${request.day}, this.value)" class="border border-gray-300 rounded px-2 py-1">
                ${options.join('')}
              </select>
            </td>
            <td class="py-2 px-2 text-center">
              <button onclick="removeRequest(${request.day})" class="text-red-600 hover:text-red-800">
                å‰Šé™¤
              </button>
            </td>
          </tr>
        `;
      });

      tbody.innerHTML = html;
    }

    // å„ªå…ˆé †ä½ã‚’æ›´æ–°
    function updatePriority(day, priority) {
      const request = selectedRequests.find(r => r.day === day);
      if (request) {
        request.priority = parseInt(priority);

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å†æç”»ï¼ˆå„ªå…ˆé †ä½ãƒãƒƒã‚¸ã‚’æ›´æ–°ï¼‰
        const targetMonth = document.getElementById('targetMonth').value;
        const [year, month] = targetMonth.split('-').map(Number);
        const existingRequests = selectedRequests.map(r => ({
          'æ—¥ä»˜': new Date(year, month - 1, r.day),
          'å„ªå…ˆé †ä½': r.priority
        }));
        renderCalendar(year, month, existingRequests);
      }
    }

    // ä¼‘ã¿å¸Œæœ›ã‚’å‰Šé™¤
    function removeRequest(day) {
      toggleDate(day);  // ãƒˆã‚°ãƒ«ã§å‰Šé™¤
    }

    // ä¼‘ã¿å¸Œæœ›ä¿å­˜ï¼ˆä¸Šé™ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
    function saveHolidayRequest() {
      if (selectedRequests.length === 0) {
        alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      const targetMonth = document.getElementById('targetMonth').value;
      const [year, month] = targetMonth.split('-').map(Number);
      const notes = document.getElementById('requestNotes').value;

      // ä¸Šé™ãƒã‚§ãƒƒã‚¯: æœˆé–“å…¬ä¼‘æ•°ã‚’å–å¾—
      const configKey = `MONTHLY_HOLIDAYS_${year}${String(month).padStart(2, '0')}`;

      showLoading();

      // ã¾ãšå…¬ä¼‘æ•°ã®ä¸Šé™ã‚’å–å¾—
      google.script.run
        .withSuccessHandler(function(configResult) {
          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ9æ—¥
          const maxHolidays = configResult.value ? parseFloat(configResult.value) : 9;

          // ä¸Šé™ãƒã‚§ãƒƒã‚¯
          if (selectedRequests.length > maxHolidays) {
            hideLoading();
            alert(`âš ï¸ ä¼‘ã¿ã™ãã§ã™ï¼\n\né¸æŠã•ã‚ŒãŸæ—¥æ•°: ${selectedRequests.length}æ—¥\næœˆé–“å…¬ä¼‘ä¸Šé™: ${maxHolidays}æ—¥\n\nå…¬ä¼‘ä¸Šé™ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚æ—¥æ•°ã‚’æ¸›ã‚‰ã—ã¦ãã ã•ã„ã€‚`);
            return;
          }

          // ä¸Šé™å†…ãªã®ã§ä¿å­˜å‡¦ç†ã‚’å®Ÿè¡Œ
          // requestList: [{date: ISOæ–‡å­—åˆ—, priority: æ•°å€¤}]
          const requestList = selectedRequests.map(req => {
            const date = new Date(year, month - 1, req.day);
            return {
              date: date.toISOString(),
              priority: req.priority
            };
          });

          google.script.run
            .withSuccessHandler(function(result) {
              hideLoading();
              if (result && result.success) {
                showMessage('holidayMessage', result.message, 'success');
              } else {
                showMessage('holidayMessage', result ? result.message : 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
              }
            })
            .withFailureHandler(function(error) {
              hideLoading();
              showMessage('holidayMessage', 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
              console.error(error);
            })
            .apiSaveHolidayRequest(currentSession.name, requestList, notes);
        })
        .withFailureHandler(function(error) {
          hideLoading();
          console.error('è¨­å®šå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤9æ—¥ã§ç¶šè¡Œ
          if (selectedRequests.length > 9) {
            alert(`âš ï¸ ä¼‘ã¿ã™ãã§ã™ï¼\n\né¸æŠã•ã‚ŒãŸæ—¥æ•°: ${selectedRequests.length}æ—¥\nãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå…¬ä¼‘ä¸Šé™: 9æ—¥\n\nå…¬ä¼‘ä¸Šé™ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚æ—¥æ•°ã‚’æ¸›ã‚‰ã—ã¦ãã ã•ã„ã€‚`);
            return;
          }

          // ä¿å­˜å‡¦ç†ã‚’å®Ÿè¡Œ
          const requestList = selectedRequests.map(req => {
            const date = new Date(year, month - 1, req.day);
            return {
              date: date.toISOString(),
              priority: req.priority
            };
          });

          google.script.run
            .withSuccessHandler(function(result) {
              hideLoading();
              if (result && result.success) {
                showMessage('holidayMessage', result.message, 'success');
              } else {
                showMessage('holidayMessage', result ? result.message : 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
              }
            })
            .withFailureHandler(function(error) {
              hideLoading();
              showMessage('holidayMessage', 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
              console.error(error);
            })
            .apiSaveHolidayRequest(currentSession.name, requestList, notes);
        })
        .apiGetConfig(configKey);
    }

    // ä¼‘ã¿å¸Œæœ›ã‚¯ãƒªã‚¢
    function clearHolidayRequest() {
      selectedRequests = [];
      const targetMonth = document.getElementById('targetMonth').value;
      const [year, month] = targetMonth.split('-').map(Number);
      renderCalendar(year, month, []);
      document.getElementById('requestNotes').value = '';
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function showMessage(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.textContent = message;
      element.className = type === 'success' ? 'p-4 bg-green-100 text-green-800 rounded-lg' : 'p-4 bg-red-100 text-red-800 rounded-lg';
      element.classList.remove('hidden');

      setTimeout(() => {
        element.classList.add('hidden');
      }, 3000);
    }

    // è·å“¡ä¸€è¦§èª­ã¿è¾¼ã¿
    function loadStaffList() {
      showLoading();

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            renderStaffTable(result.data);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          console.error(error);
        })
        .apiGetAllStaff();
    }

    // è·å“¡ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    function renderStaffTable(staffList) {
      const tbody = document.getElementById('staffTableBody');
      tbody.innerHTML = '';

      staffList.forEach(staff => {
        const row = `<tr>
          <td class="px-4 py-3">${staff['æ°å']}</td>
          <td class="px-4 py-3">${staff['å½¹è·']}</td>
          <td class="px-4 py-3">${staff['ã‚°ãƒ«ãƒ¼ãƒ—']}</td>
          <td class="px-4 py-3">${staff['é›‡ç”¨å½¢æ…‹']}</td>
          <td class="px-4 py-3">${staff['æœ‰åŠ¹'] ? 'âœ“' : ''}</td>
          <td class="px-4 py-3">
            <button onclick='editStaff(${JSON.stringify(staff).replace(/'/g, "&#39;")})' class="text-blue-600 hover:underline">
              ç·¨é›†
            </button>
          </td>
        </tr>`;
        tbody.innerHTML += row;
      });
    }

    // è·å“¡ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
    function showStaffForm() {
      document.getElementById('staffFormModal').classList.remove('hidden');
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
      document.getElementById('staff_id').value = 'STAFF_' + Date.now();
      document.getElementById('staff_name').value = '';
      document.getElementById('staff_role').value = '';
      document.getElementById('staff_group').value = '1';
      document.getElementById('staff_employment').value = 'å¸¸å‹¤';
      document.getElementById('staff_login_id').value = '';
      document.getElementById('staff_password').value = '';
      document.getElementById('staff_calendar_id').value = '';
      document.getElementById('staff_qualified').checked = false;
      document.getElementById('staff_care_required').checked = false;
      document.getElementById('staff_active').checked = true;
    }

    // è·å“¡ç·¨é›†
    function editStaff(staff) {
      document.getElementById('staffFormModal').classList.remove('hidden');
      document.getElementById('staff_id').value = staff['è·å“¡ID'];
      document.getElementById('staff_name').value = staff['æ°å'];
      document.getElementById('staff_role').value = staff['å½¹è·'];
      document.getElementById('staff_group').value = staff['ã‚°ãƒ«ãƒ¼ãƒ—'];
      document.getElementById('staff_employment').value = staff['é›‡ç”¨å½¢æ…‹'];
      document.getElementById('staff_login_id').value = staff['ãƒ­ã‚°ã‚¤ãƒ³ID'];
      document.getElementById('staff_password').value = staff['ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰'];
      document.getElementById('staff_calendar_id').value = staff['ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID'];
      document.getElementById('staff_qualified').checked = staff['å–€ç—°å¸å¼•è³‡æ ¼è€…'];
      document.getElementById('staff_care_required').checked = staff['å‹¤å‹™é…æ…®'];
      document.getElementById('staff_active').checked = staff['æœ‰åŠ¹'];
    }

    // è·å“¡ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‰ã˜ã‚‹
    function closeStaffForm() {
      document.getElementById('staffFormModal').classList.add('hidden');
    }

    // è·å“¡ãƒ‡ãƒ¼ã‚¿ä¿å­˜
    function saveStaffData(event) {
      event.preventDefault();
      showLoading();

      const staffData = {
        'è·å“¡ID': document.getElementById('staff_id').value,
        'æ°å': document.getElementById('staff_name').value,
        'å½¹è·': document.getElementById('staff_role').value,
        'ã‚°ãƒ«ãƒ¼ãƒ—': document.getElementById('staff_group').value,
        'é›‡ç”¨å½¢æ…‹': document.getElementById('staff_employment').value,
        'ãƒ­ã‚°ã‚¤ãƒ³ID': document.getElementById('staff_login_id').value,
        'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰': document.getElementById('staff_password').value,
        'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID': document.getElementById('staff_calendar_id').value,
        'å–€ç—°å¸å¼•è³‡æ ¼è€…': document.getElementById('staff_qualified').checked,
        'å‹¤å‹™é…æ…®': document.getElementById('staff_care_required').checked,
        'æœ‰åŠ¹': document.getElementById('staff_active').checked
      };

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          closeStaffForm();
          if (result.success) {
            loadStaffList();
          } else {
            alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
          console.error(error);
        })
        .apiSaveStaff(staffData);
    }

    // ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ä¸€è¦§èª­ã¿è¾¼ã¿
    function loadShiftMasterList() {
      showLoading();

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result && result.success) {
            renderShiftMasterTable(result.data);
          } else {
            alert('ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result ? result.message : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
          console.error(error);
        })
        .apiGetAllShiftMaster();
    }

    // ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    function renderShiftMasterTable(shiftList) {
      const tbody = document.getElementById('shiftMasterTableBody');
      tbody.innerHTML = '';

      shiftList.forEach(shift => {
        const row = `<tr>
          <td class="px-4 py-3">${shift['ã‚·ãƒ•ãƒˆå']}</td>
          <td class="px-4 py-3">${shift['é–‹å§‹æ™‚é–“']}</td>
          <td class="px-4 py-3">${shift['çµ‚äº†æ™‚é–“']}</td>
          <td class="px-4 py-3">${shift['å‚™è€ƒ']}</td>
          <td class="px-4 py-3">
            <button onclick='editShiftMaster(${JSON.stringify(shift).replace(/'/g, "&#39;")})' class="text-blue-600 hover:underline mr-3">
              ç·¨é›†
            </button>
            <button onclick='deleteShiftMaster("${shift['ã‚·ãƒ•ãƒˆID']}", "${shift['ã‚·ãƒ•ãƒˆå']}")' class="text-red-600 hover:underline">
              å‰Šé™¤
            </button>
          </td>
        </tr>`;
        tbody.innerHTML += row;
      });
    }

    // ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºï¼ˆæ–°è¦ï¼‰
    function showShiftMasterForm() {
      document.getElementById('shiftMasterFormModal').classList.remove('hidden');
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
      document.getElementById('shift_id').value = 'SHIFT_' + Date.now();
      document.getElementById('shift_name').value = '';
      document.getElementById('shift_start_time').value = '';
      document.getElementById('shift_end_time').value = '';
      document.getElementById('shift_notes').value = '';
    }

    // ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºï¼ˆæ—¢å­˜ï¼‰
    function editShiftMaster(shift) {
      document.getElementById('shiftMasterFormModal').classList.remove('hidden');
      document.getElementById('shift_id').value = shift['ã‚·ãƒ•ãƒˆID'];
      document.getElementById('shift_name').value = shift['ã‚·ãƒ•ãƒˆå'];
      document.getElementById('shift_start_time').value = shift['é–‹å§‹æ™‚é–“'];
      document.getElementById('shift_end_time').value = shift['çµ‚äº†æ™‚é–“'];
      document.getElementById('shift_notes').value = shift['å‚™è€ƒ'];
    }

    // ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‰ã˜ã‚‹
    function closeShiftMasterForm() {
      document.getElementById('shiftMasterFormModal').classList.add('hidden');
    }

    // ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ä¿å­˜
    function saveShiftMasterData(event) {
      event.preventDefault();
      showLoading();

      const shiftData = {
        'ã‚·ãƒ•ãƒˆID': document.getElementById('shift_id').value,
        'ã‚·ãƒ•ãƒˆå': document.getElementById('shift_name').value,
        'é–‹å§‹æ™‚é–“': document.getElementById('shift_start_time').value,
        'çµ‚äº†æ™‚é–“': document.getElementById('shift_end_time').value,
        'å‚™è€ƒ': document.getElementById('shift_notes').value
      };

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          closeShiftMasterForm();
          if (result.success) {
            loadShiftMasterList();
          } else {
            alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
          console.error(error);
        })
        .apiSaveShiftMaster(shiftData);
    }

    // ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿å‰Šé™¤
    function deleteShiftMaster(shiftId, shiftName) {
      if (!confirm(`ã‚·ãƒ•ãƒˆã€Œ${shiftName}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
        return;
      }

      showLoading();

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            loadShiftMasterList();
          } else {
            alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
          console.error(error);
        })
        .apiDeleteShiftMaster(shiftId);
    }

    // ============================================
    // ã‚·ãƒ•ãƒˆç®¡ç†ç”»é¢ç”¨é–¢æ•°
    // ============================================

    // ã‚·ãƒ•ãƒˆç®¡ç†ç”»é¢ã®åˆæœŸåŒ–
    function initShiftManagementView() {
      const now = new Date();
      const targetMonth = document.getElementById('shiftMgmtTargetMonth');
      targetMonth.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      loadShiftManagementStatus();
    }

    // ã‚·ãƒ•ãƒˆç®¡ç†ç”»é¢ã®çŠ¶æ…‹ã‚’èª­ã¿è¾¼ã¿
    function loadShiftManagementStatus() {
      const targetMonth = document.getElementById('shiftMgmtTargetMonth').value;
      if (!targetMonth) return;

      const [year, month] = targetMonth.split('-').map(Number);
      const holidaysKey = `MONTHLY_HOLIDAYS_${year}${String(month).padStart(2, '0')}`;
      const lockKey = `SUBMISSION_LOCK_${year}${String(month).padStart(2, '0')}`;

      // å…¬ä¼‘æ—¥æ•°ã‚’å–å¾—
      google.script.run
        .withSuccessHandler(function(result) {
          const holidays = result.value ? parseInt(result.value) : 9;
          document.getElementById('monthlyHolidaysInput').value = holidays;
        })
        .apiGetConfig(holidaysKey);

      // ç· åˆ‡çŠ¶æ…‹ã‚’å–å¾—
      google.script.run
        .withSuccessHandler(function(result) {
          const isLocked = result.value === 'TRUE' || result.value === true;
          updateLockStatusDisplay(isLocked);
        })
        .apiGetConfig(lockKey);
    }

    // ç· åˆ‡çŠ¶æ…‹ã®è¡¨ç¤ºã‚’æ›´æ–°
    function updateLockStatusDisplay(isLocked) {
      const statusDiv = document.getElementById('submissionLockStatus');
      const lockBtn = document.getElementById('lockButton');
      const unlockBtn = document.getElementById('unlockButton');

      if (isLocked) {
        statusDiv.innerHTML = '<span class="text-red-600 font-semibold">ç¾åœ¨: ç· åˆ‡æ¸ˆã¿ï¼ˆæå‡ºä¸å¯ï¼‰</span>';
        lockBtn.classList.add('opacity-50');
        unlockBtn.classList.remove('opacity-50');
      } else {
        statusDiv.innerHTML = '<span class="text-green-600 font-semibold">ç¾åœ¨: å—ä»˜ä¸­ï¼ˆæå‡ºå¯èƒ½ï¼‰</span>';
        lockBtn.classList.remove('opacity-50');
        unlockBtn.classList.add('opacity-50');
      }
    }

    // å…¬ä¼‘æ—¥æ•°ã‚’ä¿å­˜
    function saveMonthlyHolidays() {
      const targetMonth = document.getElementById('shiftMgmtTargetMonth').value;
      if (!targetMonth) {
        alert('å¯¾è±¡æœˆã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      const [year, month] = targetMonth.split('-').map(Number);
      const holidays = document.getElementById('monthlyHolidaysInput').value;

      if (!holidays || holidays < 1 || holidays > 31) {
        alert('å…¬ä¼‘æ—¥æ•°ã¯1ã€œ31ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const configKey = `MONTHLY_HOLIDAYS_${year}${String(month).padStart(2, '0')}`;

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            alert(`${year}å¹´${month}æœˆã®å…¬ä¼‘æ—¥æ•°ã‚’${holidays}æ—¥ã«è¨­å®šã—ã¾ã—ãŸ`);
          } else {
            alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
          console.error(error);
        })
        .apiSetConfig(configKey, holidays);
    }

    // æå‡ºç· åˆ‡ã®åˆ‡ã‚Šæ›¿ãˆ
    function toggleSubmissionLock(lock) {
      const targetMonth = document.getElementById('shiftMgmtTargetMonth').value;
      if (!targetMonth) {
        alert('å¯¾è±¡æœˆã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      const [year, month] = targetMonth.split('-').map(Number);
      const action = lock ? 'ç· åˆ‡ï¼ˆãƒ­ãƒƒã‚¯ï¼‰' : 'å—ä»˜å†é–‹ï¼ˆè§£é™¤ï¼‰';

      if (!confirm(`${year}å¹´${month}æœˆã®ä¼‘ã¿å¸Œæœ›æå‡ºã‚’${action}ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
      }

      const configKey = `SUBMISSION_LOCK_${year}${String(month).padStart(2, '0')}`;
      const value = lock ? 'TRUE' : 'FALSE';

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            updateLockStatusDisplay(lock);
            alert(`${year}å¹´${month}æœˆã®æå‡ºã‚’${action}ã—ã¾ã—ãŸ`);
          } else {
            alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
          console.error(error);
        })
        .apiSetConfig(configKey, value);
    }

    // ã‚·ãƒ•ãƒˆä½œæˆç”¨3ç¨®CSVä¸€æ‹¬å‡ºåŠ›
    function exportAllCSVForShiftCreation() {
      const targetMonth = document.getElementById('shiftMgmtTargetMonth').value;
      if (!targetMonth) {
        alert('å¯¾è±¡æœˆã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      const [year, month] = targetMonth.split('-').map(Number);

      if (!confirm(`${year}å¹´${month}æœˆã®ã‚·ãƒ•ãƒˆä½œæˆç”¨CSVã‚’ä¸€æ‹¬å‡ºåŠ›ã—ã¾ã™ã‹ï¼Ÿ\n\nå‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«:\nãƒ»T_ä¼‘ã¿å¸Œæœ›_${year}${String(month).padStart(2, '0')}.csv\nãƒ»M_è·å“¡_${year}${String(month).padStart(2, '0')}.csv\nãƒ»M_è¨­å®š_${year}${String(month).padStart(2, '0')}.csv`)) {
        return;
      }

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          const resultDiv = document.getElementById('csvExportResult');

          if (result.success) {
            let fileList = result.files.map(f => `ãƒ»${f}`).join('<br>');
            resultDiv.innerHTML = `<span class="text-green-600">âœ… ${result.message}</span><br>
              <span class="text-gray-600">å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«:<br>${fileList}</span>`;
          } else {
            resultDiv.innerHTML = `<span class="text-red-600">âŒ ${result.message}</span>`;
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          document.getElementById('csvExportResult').innerHTML =
            `<span class="text-red-600">âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</span>`;
          console.error(error);
        })
        .apiExportAllCSVForShiftCreation(year, month);
    }

    // ã‚·ãƒ•ãƒˆçµæœCSVå–è¾¼ï¼ˆå¯¾è±¡æœˆã§è‡ªå‹•æ¤œç´¢ï¼‰
    function importShiftCSVByMonth() {
      const targetMonth = document.getElementById('shiftMgmtTargetMonth').value;
      if (!targetMonth) {
        alert('å¯¾è±¡æœˆã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      const [year, month] = targetMonth.split('-').map(Number);
      const ym = `${year}${String(month).padStart(2, '0')}`;

      if (!confirm(`${year}å¹´${month}æœˆã®ã‚·ãƒ•ãƒˆçµæœã‚’å–ã‚Šè¾¼ã¿ã¾ã™ã‹ï¼Ÿ\n\nå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«: ã‚·ãƒ•ãƒˆçµæœ_${ym}.csv\nï¼ˆæ—¢å­˜ã®ç¢ºå®šã‚·ãƒ•ãƒˆã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼‰`)) {
        return;
      }

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          const resultDiv = document.getElementById('csvImportResult');

          if (result.success) {
            resultDiv.innerHTML = `<span class="text-green-600">âœ… ${result.message}</span>`;
          } else {
            resultDiv.innerHTML = `<span class="text-red-600">âŒ ${result.message}</span>`;
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          document.getElementById('csvImportResult').innerHTML =
            `<span class="text-red-600">âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</span>`;
          console.error(error);
        })
        .apiImportShiftResultByMonth(year, month);
    }

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç™»éŒ²
    function registerShiftToCalendar() {
      const targetMonth = document.getElementById('shiftMgmtTargetMonth').value;
      if (!targetMonth) {
        alert('å¯¾è±¡æœˆã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      const [year, month] = targetMonth.split('-').map(Number);

      if (!confirm(`${year}å¹´${month}æœˆã®ã‚·ãƒ•ãƒˆã‚’Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ\n\næ³¨æ„: æ—¢å­˜ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼äºˆå®šã¯ä¸Šæ›¸ãã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚`)) {
        return;
      }

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          const resultDiv = document.getElementById('calendarRegisterResult');

          if (result.success) {
            resultDiv.innerHTML = `<span class="text-green-600">âœ… ${result.message}</span>`;
          } else {
            resultDiv.innerHTML = `<span class="text-red-600">âŒ ${result.message}</span>`;
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          document.getElementById('calendarRegisterResult').innerHTML =
            `<span class="text-red-600">âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</span>`;
          console.error(error);
        })
        .apiRegisterShiftToCalendar(year, month);
    }

    // ============================================
    // ã‚·ãƒ•ãƒˆä¿®æ­£ç”»é¢ç”¨é–¢æ•°
    // ============================================

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆã‚·ãƒ•ãƒˆä¿®æ­£ç”¨ï¼‰
    let shiftEditData = null;
    let shiftMasterList = [];

    // ã‚·ãƒ•ãƒˆä¿®æ­£ç”»é¢ã®åˆæœŸåŒ–
    function initShiftEditView() {
      const now = new Date();
      const targetMonth = document.getElementById('shiftEditTargetMonth');
      targetMonth.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

      // ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§ã‚’å–å¾—
      loadShiftEditGroups();

      // ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ã‚’å–å¾—
      loadShiftMasterForEdit();
    }

    // ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§ã‚’å–å¾—
    function loadShiftEditGroups() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            const select = document.getElementById('shiftEditGroup');
            select.innerHTML = '<option value="">-- é¸æŠ --</option>';
            result.groups.forEach(g => {
              select.innerHTML += `<option value="${g}">ã‚°ãƒ«ãƒ¼ãƒ— ${g}</option>`;
            });
          }
        })
        .withFailureHandler(function(error) {
          console.error('ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .apiGetGroups();
    }

    // ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ã‚’å–å¾—
    function loadShiftMasterForEdit() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            shiftMasterList = result.shifts;
          }
        })
        .withFailureHandler(function(error) {
          console.error('ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .apiGetShiftMaster();
    }

    // ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    function loadShiftEditData() {
      const targetMonth = document.getElementById('shiftEditTargetMonth').value;
      const group = document.getElementById('shiftEditGroup').value;

      if (!targetMonth) {
        alert('å¯¾è±¡æœˆã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      if (!group) {
        alert('ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      // ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯å¾…æ©Ÿ
      if (shiftMasterList.length === 0) {
        alert('ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
        loadShiftMasterForEdit();
        return;
      }

      const [year, month] = targetMonth.split('-').map(Number);

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          console.log('apiGetShiftDataByGroup result:', result);
          if (result && result.success) {
            shiftEditData = result;
            renderShiftEditTable(result);
            renderShiftStatsTable(result);
            document.getElementById('shiftEditTableContainer').classList.remove('hidden');
            document.getElementById('diagnosticsPanel').classList.remove('hidden');
            document.getElementById('diagnosticsResult').classList.add('hidden');
            document.getElementById('diagnosticsEmpty').classList.remove('hidden');
          } else if (result) {
            alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
          } else {
            alert('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          console.error('apiGetShiftDataByGroup error:', error);
          alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + (error.message || error));
        })
        .apiGetShiftDataByGroup(year, month, parseInt(group));
    }

    // ã‚·ãƒ•ãƒˆç·¨é›†ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”»
    function renderShiftEditTable(data) {
      const table = document.getElementById('shiftEditTable');
      const thead = table.querySelector('thead');
      const tbody = table.querySelector('tbody');

      // ãƒ˜ãƒƒãƒ€ãƒ¼ç”Ÿæˆ
      let headerHtml = '<tr><th class="px-2 py-2 text-left sticky left-0 bg-gray-50 border-b border-r">æ°å</th>';
      data.dateInfo.forEach(d => {
        let bgClass = '';
        if (d.isSunday || d.isHoliday) {
          bgClass = 'bg-pink-100';
        } else if (d.isSaturday) {
          bgClass = 'bg-blue-100';
        }
        const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
        headerHtml += `<th class="px-1 py-2 text-center border-b ${bgClass}" style="min-width: 70px;">
          <div class="text-xs">${d.day}</div>
          <div class="text-xs text-gray-500">${dayNames[d.dayOfWeek]}</div>
        </th>`;
      });
      headerHtml += '</tr>';
      thead.innerHTML = headerHtml;

      // ãƒœãƒ‡ã‚£ç”Ÿæˆ
      let bodyHtml = '';
      data.staffShifts.forEach(staff => {
        bodyHtml += `<tr><td class="px-2 py-2 whitespace-nowrap sticky left-0 bg-white border-r font-medium">${staff.name}</td>`;
        data.dateInfo.forEach(d => {
          const shift = staff.shifts[d.day];
          let bgClass = '';
          if (d.isSunday || d.isHoliday) {
            bgClass = 'bg-pink-50';
          } else if (d.isSaturday) {
            bgClass = 'bg-blue-50';
          }

          // ã‚·ãƒ•ãƒˆé¸æŠãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ç”Ÿæˆ
          let options = '<option value="ä¼‘ã¿">ä¼‘ã¿</option>';
          shiftMasterList.forEach(sm => {
            if (sm['ã‚·ãƒ•ãƒˆå'] !== 'ä¼‘ã¿') {
              const selected = shift.shiftName === sm['ã‚·ãƒ•ãƒˆå'] ? 'selected' : '';
              options += `<option value="${sm['ã‚·ãƒ•ãƒˆå']}" ${selected}>${sm['ã‚·ãƒ•ãƒˆå']}</option>`;
            }
          });
          // ä¼‘ã¿ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆ
          if (shift.shiftName === 'ä¼‘ã¿' || !shift.shiftName) {
            options = options.replace('value="ä¼‘ã¿"', 'value="ä¼‘ã¿" selected');
          }

          bodyHtml += `<td class="px-1 py-1 ${bgClass}">
            <select onchange="updateShiftCell('${staff.name}', ${data.year}, ${data.month}, ${d.day}, this.value)"
              class="w-full px-1 py-1 text-xs border border-gray-300 rounded">
              ${options}
            </select>
          </td>`;
        });
        bodyHtml += '</tr>';
      });
      tbody.innerHTML = bodyHtml;
    }

    // ã‚·ãƒ•ãƒˆã‚»ãƒ«ã‚’æ›´æ–°
    function updateShiftCell(staffName, year, month, day, shiftName) {
      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦çµ±è¨ˆã‚’æ›´æ–°
            loadShiftEditData();
          } else {
            alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
          console.error(error);
        })
        .apiUpdateShift(staffName, year, month, day, shiftName);
    }

    // çµ±è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”»
    function renderShiftStatsTable(data) {
      const table = document.getElementById('shiftStatsTable');
      const thead = table.querySelector('thead');
      const tbody = table.querySelector('tbody');

      // å…¨ã‚·ãƒ•ãƒˆç¨®é¡ã‚’å–å¾—
      const allShiftNames = new Set();
      data.statistics.forEach(stat => {
        Object.keys(stat.shiftCounts).forEach(name => allShiftNames.add(name));
      });
      const shiftNames = Array.from(allShiftNames).sort();

      // ãƒ˜ãƒƒãƒ€ãƒ¼ç”Ÿæˆ
      let headerHtml = '<tr>';
      headerHtml += '<th class="px-3 py-2 text-left border-b">æ°å</th>';
      headerHtml += '<th class="px-3 py-2 text-center border-b">å‹¤å‹™æ—¥æ•°</th>';
      headerHtml += '<th class="px-3 py-2 text-center border-b">ä¼‘æ—¥æ•°</th>';
      shiftNames.forEach(name => {
        headerHtml += `<th class="px-3 py-2 text-center border-b">${name}</th>`;
      });
      headerHtml += '</tr>';
      thead.innerHTML = headerHtml;

      // ãƒœãƒ‡ã‚£ç”Ÿæˆ
      let bodyHtml = '';
      data.statistics.forEach(stat => {
        bodyHtml += '<tr>';
        bodyHtml += `<td class="px-3 py-2 border-b font-medium">${stat.name}</td>`;
        bodyHtml += `<td class="px-3 py-2 border-b text-center">${stat.workDays}</td>`;
        bodyHtml += `<td class="px-3 py-2 border-b text-center">${stat.restDays}</td>`;
        shiftNames.forEach(name => {
          const count = stat.shiftCounts[name] || 0;
          bodyHtml += `<td class="px-3 py-2 border-b text-center">${count}</td>`;
        });
        bodyHtml += '</tr>';
      });
      tbody.innerHTML = bodyHtml;
    }

    // ç¢ºå®šã—ã¦ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç™»éŒ²
    function confirmAndRegisterCalendar() {
      if (!shiftEditData) {
        alert('å…ˆã«ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¦ãã ã•ã„');
        return;
      }

      const { year, month, group } = shiftEditData;

      if (!confirm(`ã‚°ãƒ«ãƒ¼ãƒ—${group}ã®${year}å¹´${month}æœˆã‚·ãƒ•ãƒˆã‚’ç¢ºå®šã—ã¦ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ\n\nç¢ºå®šã™ã‚‹ã¨:\nãƒ»ç™»éŒ²æ—¥æ™‚ãŒè¨˜éŒ²ã•ã‚Œã¾ã™\nãƒ»Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«äºˆå®šãŒç™»éŒ²ã•ã‚Œã¾ã™`)) {
        return;
      }

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            alert(`âœ… ${result.message}`);
            // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
            loadShiftEditData();
          } else {
            alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + result.message);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          alert('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
          console.error(error);
        })
        .apiConfirmShiftsAndRegisterCalendar(year, month, group);
    }

    function runDiagnostics() {
      var targetMonth = document.getElementById('shiftEditTargetMonth').value;
      if (!targetMonth) { alert('å¯¾è±¡æœˆã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
      var parts = targetMonth.split('-').map(Number);
      var year = parts[0], month = parts[1];

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (!result.success) { alert('ã‚¨ãƒ©ãƒ¼: ' + result.message); return; }

          document.getElementById('diagnosticsEmpty').classList.add('hidden');
          document.getElementById('diagnosticsResult').classList.remove('hidden');

          var summaryEl = document.getElementById('diagnosticsSummary');
          summaryEl.textContent = '';

          if (!result.hasData) {
            summaryEl.textContent = 'ç¢ºå®šã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“';
            document.getElementById('diagnosticsList').textContent = '';
            return;
          }

          // ã‚µãƒãƒªãƒ¼ãƒãƒƒã‚¸ã‚’DOMæ“ä½œã§æ§‹ç¯‰
          var errSpan = document.createElement('span');
          errSpan.className = 'px-3 py-1 rounded-full font-semibold ' +
            (result.summary.error > 0 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800');
          errSpan.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + result.summary.error + 'ä»¶';
          summaryEl.appendChild(errSpan);

          var warnSpan = document.createElement('span');
          warnSpan.className = 'px-3 py-1 rounded-full font-semibold ' +
            (result.summary.warning > 0 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800');
          warnSpan.textContent = 'è­¦å‘Š: ' + result.summary.warning + 'ä»¶';
          summaryEl.appendChild(warnSpan);

          var listEl = document.getElementById('diagnosticsList');
          listEl.textContent = '';

          if (result.summary.total === 0) {
            listEl.textContent = 'ãƒ«ãƒ¼ãƒ«é•åã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ';
            return;
          }

          // ã‚¿ã‚¤ãƒ—åˆ¥ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦DOMæ§‹ç¯‰
          var grouped = {};
          result.violations.concat(result.warnings).forEach(function(v) {
            if (!grouped[v.type]) grouped[v.type] = [];
            grouped[v.type].push(v);
          });

          Object.keys(grouped).forEach(function(type) {
            var items = grouped[type];
            var isError = items[0].level === 'error';

            var wrapper = document.createElement('div');
            wrapper.className = 'mb-4 border rounded-lg overflow-hidden ' +
              (isError ? 'border-red-200' : 'border-yellow-200');

            var header = document.createElement('div');
            header.className = 'px-4 py-2 font-semibold ' +
              (isError ? 'bg-red-50 text-red-800' : 'bg-yellow-50 text-yellow-800');
            header.textContent = (isError ? 'ã‚¨ãƒ©ãƒ¼: ' : 'è­¦å‘Š: ') + type + ' (' + items.length + 'ä»¶)';
            wrapper.appendChild(header);

            var ul = document.createElement('ul');
            ul.className = 'divide-y divide-gray-100';
            items.forEach(function(item) {
              var li = document.createElement('li');
              li.className = 'px-4 py-2 text-sm text-gray-700';
              li.textContent = item.message;
              ul.appendChild(li);
            });
            wrapper.appendChild(ul);
            listEl.appendChild(wrapper);
          });
        })
        .withFailureHandler(function(error) {
          hideLoading();
          alert('è¨ºæ–­ã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ');
          console.error(error);
        })
        .apiRunDiagnostics(year, month);
    }

    var assignmentStaffList = [];

    function initShiftAssignmentView() {
      var now = new Date();
      document.getElementById('shiftAssignTargetMonth').value =
        now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');

      if (assignmentStaffList.length === 0) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (!result.success) return;
            assignmentStaffList = result.data.filter(function(s) {
              return s['æœ‰åŠ¹'] === true || s['æœ‰åŠ¹'] === 'TRUE';
            });
            var select = document.getElementById('assignStaffName');
            assignmentStaffList.forEach(function(s) {
              var opt = document.createElement('option');
              opt.value = s['æ°å'];
              opt.textContent = s['æ°å'] + ' (G' + s['ã‚°ãƒ«ãƒ¼ãƒ—'] + ')';
              select.appendChild(opt);
            });
          })
          .withFailureHandler(function(e) { console.error(e); })
          .apiGetAllStaff();
      }

      google.script.run
        .withSuccessHandler(function(result) {
          if (!result.success) return;
          var select = document.getElementById('assignShiftName');
          while (select.firstChild) { select.removeChild(select.firstChild); }
          var defOpt = document.createElement('option');
          defOpt.value = '';
          defOpt.textContent = '-- é¸æŠ --';
          select.appendChild(defOpt);
          result.shifts.filter(function(s) { return s['ã‚·ãƒ•ãƒˆå'] !== 'ä¼‘ã¿'; }).forEach(function(s) {
            var opt = document.createElement('option');
            opt.value = s['ã‚·ãƒ•ãƒˆå'];
            opt.textContent = s['ã‚·ãƒ•ãƒˆå'];
            select.appendChild(opt);
          });
        })
        .withFailureHandler(function(e) { console.error(e); })
        .apiGetShiftMaster();
    }

    function loadShiftAssignments() {
      var targetMonth = document.getElementById('shiftAssignTargetMonth').value;
      if (!targetMonth) { alert('å¯¾è±¡æœˆã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
      var parts = targetMonth.split('-').map(Number);
      var year = parts[0], month = parts[1];

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          var tbody = document.getElementById('assignmentTableBody');
          tbody.textContent = '';

          if (!result.success || result.assignments.length === 0) {
            var tr = document.createElement('tr');
            var td = document.createElement('td');
            td.colSpan = 6;
            td.className = 'px-4 py-4 text-center text-gray-500';
            td.textContent = !result.success
              ? ('ã‚¨ãƒ©ãƒ¼: ' + result.message)
              : (year + 'å¹´' + month + 'æœˆã®å‹¤å‹™æŒ‡å®šã¯ã‚ã‚Šã¾ã›ã‚“');
            tr.appendChild(td);
            tbody.appendChild(tr);
            return;
          }

          var sorted = result.assignments.slice().sort(function(a, b) {
            return (a['æ—¥ä»˜'] || '').localeCompare(b['æ—¥ä»˜'] || '');
          });

          sorted.forEach(function(a) {
            var tr = document.createElement('tr');
            [a['æ—¥ä»˜'], a['æ°å'], a['ã‚°ãƒ«ãƒ¼ãƒ—'], a['ã‚·ãƒ•ãƒˆå'], a['å‚™è€ƒ'] || '-'].forEach(function(val) {
              var td = document.createElement('td');
              td.className = 'px-4 py-2';
              td.textContent = val;
              tr.appendChild(td);
            });
            var tdBtn = document.createElement('td');
            tdBtn.className = 'px-4 py-2 text-center';
            var btn = document.createElement('button');
            btn.className = 'bg-red-100 text-red-700 px-3 py-1 rounded hover:bg-red-200 text-xs';
            btn.textContent = 'å‰Šé™¤';
            btn.dataset.id = a['æŒ‡å®šID'];
            btn.addEventListener('click', function() { deleteAssignment(this.dataset.id); });
            tdBtn.appendChild(btn);
            tr.appendChild(tdBtn);
            tbody.appendChild(tr);
          });
        })
        .withFailureHandler(function(e) { hideLoading(); console.error(e); })
        .apiGetShiftAssignments(year, month);
    }

    function addShiftAssignment() {
      var staffName = document.getElementById('assignStaffName').value;
      var date = document.getElementById('assignDate').value;
      var shiftName = document.getElementById('assignShiftName').value;
      var notes = document.getElementById('assignNotes').value;
      var msgEl = document.getElementById('assignmentAddMessage');

      if (!staffName || !date || !shiftName) {
        msgEl.textContent = 'è·å“¡åã€æ—¥ä»˜ã€ã‚·ãƒ•ãƒˆã¯ã™ã¹ã¦å¿…é ˆã§ã™';
        msgEl.className = 'mt-2 text-sm text-red-600';
        msgEl.classList.remove('hidden');
        return;
      }

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          msgEl.classList.remove('hidden');
          msgEl.textContent = result.success ? 'ä¿å­˜ã—ã¾ã—ãŸ' : result.message;
          msgEl.className = 'mt-2 text-sm ' + (result.success ? 'text-green-600' : 'text-red-600');
          if (result.success) {
            document.getElementById('assignStaffName').value = '';
            document.getElementById('assignDate').value = '';
            document.getElementById('assignShiftName').value = '';
            document.getElementById('assignNotes').value = '';
            loadShiftAssignments();
          }
        })
        .withFailureHandler(function(e) {
          hideLoading();
          msgEl.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
          msgEl.className = 'mt-2 text-sm text-red-600';
          msgEl.classList.remove('hidden');
          console.error(e);
        })
        .apiSaveShiftAssignment(staffName, date, shiftName, notes);
    }

    function deleteAssignment(assignmentId) {
      if (!confirm('ã“ã®å‹¤å‹™æŒ‡å®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) { loadShiftAssignments(); }
          else { alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + result.message); }
        })
        .withFailureHandler(function(e) { hideLoading(); console.error(e); })
        .apiDeleteShiftAssignment(assignmentId);
    }

    function toggleEventForm() {
      document.getElementById('eventAddForm').classList.toggle('hidden');
    }

    function addEvent() {
      var title = document.getElementById('eventTitle').value.trim();
      var date = document.getElementById('eventDate').value;
      var notes = document.getElementById('eventNotes').value.trim();
      var msgEl = document.getElementById('eventAddMsg');

      if (!title || !date) { msgEl.textContent = 'ã‚¿ã‚¤ãƒˆãƒ«ã¨æ—¥ä»˜ã¯å¿…é ˆã§ã™'; return; }

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          msgEl.textContent = result.success ? 'è¿½åŠ ã—ã¾ã—ãŸ' : result.message;
          if (result.success) {
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDate').value = '';
            document.getElementById('eventNotes').value = '';
            loadHolidayRequest();
          }
        })
        .withFailureHandler(function(e) { hideLoading(); console.error(e); })
        .apiSaveEvent(title, date, notes);
    }

    function deleteEvent(eventId) {
      if (!confirm('ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) { loadHolidayRequest(); }
          else { alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + result.message); }
        })
        .withFailureHandler(function(e) { hideLoading(); console.error(e); })
        .apiDeleteEvent(eventId);
    }

    function renderEventList(events) {
      var listEl = document.getElementById('eventList');
      if (!listEl) return;
      listEl.textContent = '';
      if (!events || events.length === 0) {
        listEl.textContent = 'ã“ã®æœˆã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“';
        return;
      }
      var sorted = events.slice().sort(function(a, b) {
        return (a['æ—¥ä»˜'] || '').localeCompare(b['æ—¥ä»˜'] || '');
      });
      sorted.forEach(function(ev) {
        var row = document.createElement('div');
        row.className = 'flex items-center justify-between py-1 border-b border-orange-100';

        var text = document.createElement('span');
        var day = ev['æ—¥ä»˜'].split('-')[2];
        text.textContent = day + 'æ—¥: ' + ev['ã‚¿ã‚¤ãƒˆãƒ«'] +
          (ev['å‚™è€ƒ'] ? ' (' + ev['å‚™è€ƒ'] + ')' : '');
        row.appendChild(text);

        if (currentSession && currentSession.isAdmin) {
          var btn = document.createElement('button');
          btn.className = 'text-red-500 hover:text-red-700 text-xs ml-2';
          btn.textContent = 'å‰Šé™¤';
          btn.dataset.id = ev['ã‚¤ãƒ™ãƒ³ãƒˆID'];
          btn.addEventListener('click', function() { deleteEvent(this.dataset.id); });
          row.appendChild(btn);
        }
        listEl.appendChild(row);
      });
    }
  </script>

</body>
</html>
