<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>シフト管理システム</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .calendar-day {
      min-height: 40px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .calendar-day:hover {
      transform: scale(1.05);
    }

    .calendar-day.selected {
      background-color: #3b82f6;
      color: white;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- ローディング画面 -->
  <div id="loading" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-lg shadow-xl">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
      <p class="mt-4 text-gray-700">読み込み中...</p>
    </div>
  </div>

  <!-- メインコンテナ -->
  <div id="app" class="hidden">

    <!-- ヘッダー -->
    <header class="bg-blue-600 text-white shadow-lg">
      <div class="container mx-auto px-4 py-4">
        <div class="flex justify-between items-center">
          <h1 class="text-2xl font-bold">📅 シフト管理システム</h1>
          <div id="userInfo" class="hidden flex items-center">
            <span id="userName" class="mr-4"></span>
            <button onclick="showView('manual')" class="bg-blue-500 hover:bg-blue-400 px-3 py-2 rounded transition mr-2 text-sm">
              マニュアル
            </button>
            <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded transition">
              ログアウト
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- ナビゲーション（管理者のみ表示） -->
    <nav id="adminNav" class="bg-white shadow-md hidden">
      <div class="container mx-auto px-4">
        <ul class="flex space-x-4 py-3">
          <li>
            <button onclick="showView('holiday-request')" class="nav-btn px-4 py-2 rounded hover:bg-blue-100 transition">
              休み希望提出
            </button>
          </li>
          <li>
            <button onclick="showView('shift-management')" class="nav-btn px-4 py-2 rounded hover:bg-blue-100 transition bg-green-50 border border-green-200">
              シフト管理
            </button>
          </li>
          <li>
            <button onclick="showView('shift-edit')" class="nav-btn px-4 py-2 rounded hover:bg-blue-100 transition bg-orange-50 border border-orange-200">
              シフト修正
            </button>
          </li>
          <li>
            <button onclick="showView('staff-master')" class="nav-btn px-4 py-2 rounded hover:bg-blue-100 transition">
              職員マスタ管理
            </button>
          </li>
          <li>
            <button onclick="showView('shift-master')" class="nav-btn px-4 py-2 rounded hover:bg-blue-100 transition">
              シフトマスタ管理
            </button>
          </li>
          <li>
            <button onclick="showView('shift-assignment')"
              class="nav-btn px-4 py-2 rounded hover:bg-blue-100 transition bg-purple-50 border border-purple-200">
              勤務指定
            </button>
          </li>
          <li>
            <button onclick="showView('manual')" class="nav-btn px-4 py-2 rounded hover:bg-blue-100 transition bg-gray-50 border border-gray-300">
              マニュアル
            </button>
          </li>
        </ul>
      </div>
    </nav>

    <!-- メインコンテンツ -->
    <main class="container mx-auto px-4 py-8">

      <!-- ログイン画面 -->
      <div id="loginView" class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-8">
        <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">ログイン</h2>
        <form onsubmit="handleLogin(event)" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ログインID</label>
            <input type="text" id="loginId" required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">パスワード</label>
            <input type="password" id="loginPassword" required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <button type="submit"
            class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-semibold">
            ログイン
          </button>
        </form>
        <div id="loginError" class="mt-4 text-red-600 text-sm hidden"></div>
      </div>

      <!-- 休み希望提出画面 -->
      <div id="holidayRequestView" class="hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold mb-6 text-gray-800">休み希望提出</h2>

          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">対象月</label>
            <input type="month" id="targetMonth"
              class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              onchange="loadHolidayRequest()">
          </div>

          <div id="lockMessage" class="hidden mb-4 p-4 bg-yellow-100 border border-yellow-400 rounded-lg">
            <p class="text-yellow-800">⚠️ この月の提出は締め切られています。閲覧のみ可能です。</p>
          </div>

          <!-- イベント管理セクション（管理者のみ表示） -->
          <div id="eventManagementSection" class="mb-6 hidden">
            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
              <div class="flex justify-between items-center mb-3">
                <h3 class="text-md font-semibold text-orange-800">イベント・予定管理（管理者）</h3>
                <button onclick="toggleEventForm()"
                  class="text-orange-700 hover:text-orange-900 text-sm underline">
                  + イベントを追加
                </button>
              </div>
              <div id="eventAddForm" class="hidden mb-3 p-3 bg-white border border-orange-200 rounded">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">タイトル</label>
                    <input type="text" id="eventTitle"
                      class="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                      placeholder="全体会議 など">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">日付</label>
                    <input type="date" id="eventDate"
                      class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">備考</label>
                    <input type="text" id="eventNotes"
                      class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                  </div>
                </div>
                <button onclick="addEvent()"
                  class="bg-orange-600 text-white px-4 py-1 rounded hover:bg-orange-700 transition text-sm">
                  追加
                </button>
                <span id="eventAddMsg" class="ml-2 text-sm"></span>
              </div>
              <div id="eventList" class="text-sm text-gray-700">
                イベントを読み込み中...
              </div>
            </div>
          </div>

          <div id="calendar" class="mb-6"></div>

          <!-- 選択された日付と優先順位の一覧 -->
          <div id="selectedDatesContainer" class="mb-6 hidden">
            <h3 class="text-lg font-semibold text-gray-800 mb-3">選択された休み希望</h3>
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
              <table class="w-full">
                <thead>
                  <tr class="border-b">
                    <th class="text-left py-2 px-2 text-sm font-medium text-gray-700">日付</th>
                    <th class="text-left py-2 px-2 text-sm font-medium text-gray-700">優先順位</th>
                    <th class="text-center py-2 px-2 text-sm font-medium text-gray-700">操作</th>
                  </tr>
                </thead>
                <tbody id="selectedDatesList">
                </tbody>
              </table>
            </div>
          </div>

          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">特記事項</label>
            <textarea id="requestNotes" rows="3"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              placeholder="特記事項があれば入力してください"></textarea>
          </div>

          <div class="flex space-x-4">
            <button onclick="saveHolidayRequest()" id="saveButton"
              class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-semibold">
              保存
            </button>
            <button onclick="clearHolidayRequest()"
              class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition font-semibold">
              クリア
            </button>
          </div>

          <div id="holidayMessage" class="mt-4 hidden"></div>
        </div>
      </div>

      <!-- 職員マスタ管理画面 -->
      <div id="staffMasterView" class="hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold mb-6 text-gray-800">職員マスタ管理</h2>

          <div class="mb-4">
            <button onclick="showStaffForm()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">
              + 新規追加
            </button>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">氏名</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">役職</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">グループ</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">雇用形態</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">有効</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
                </tr>
              </thead>
              <tbody id="staffTableBody" class="bg-white divide-y divide-gray-200">
                <!-- ここに職員データが表示される -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- 職員編集フォーム（モーダル） -->
        <div id="staffFormModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full max-h-screen overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">職員情報編集</h3>
            <form onsubmit="saveStaffData(event)" class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">職員ID</label>
                  <input type="text" id="staff_id" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">氏名</label>
                  <input type="text" id="staff_name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">役職</label>
                  <input type="text" id="staff_role" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">グループ</label>
                  <select id="staff_group" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">雇用形態</label>
                  <select id="staff_employment" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="常勤">常勤</option>
                    <option value="パート">パート</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ログインID</label>
                  <input type="text" id="staff_login_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">パスワード</label>
                  <input type="password" id="staff_password" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">カレンダーID</label>
                  <input type="text" id="staff_calendar_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div class="flex items-center">
                  <input type="checkbox" id="staff_qualified" class="mr-2">
                  <label class="text-sm font-medium text-gray-700">喀痰吸引資格者</label>
                </div>
                <div class="flex items-center">
                  <input type="checkbox" id="staff_care_required" class="mr-2">
                  <label class="text-sm font-medium text-gray-700">勤務配慮</label>
                </div>
                <div class="flex items-center">
                  <input type="checkbox" id="staff_active" class="mr-2" checked>
                  <label class="text-sm font-medium text-gray-700">有効</label>
                </div>
              </div>

              <div class="flex space-x-4 mt-6">
                <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">
                  保存
                </button>
                <button type="button" onclick="closeStaffForm()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition">
                  キャンセル
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- シフトマスタ管理画面 -->
      <div id="shiftMasterView" class="hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold mb-6 text-gray-800">シフトマスタ管理</h2>

          <div class="mb-4">
            <button onclick="showShiftMasterForm()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">
              + 新規追加
            </button>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">シフト名</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">開始時間</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">終了時間</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">備考</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
                </tr>
              </thead>
              <tbody id="shiftMasterTableBody" class="bg-white divide-y divide-gray-200">
                <!-- ここにシフトマスタデータが表示される -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- シフトマスタ編集フォーム（モーダル） -->
        <div id="shiftMasterFormModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full max-h-screen overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">シフトマスタ編集</h3>
            <form onsubmit="saveShiftMasterData(event)" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">シフトID</label>
                <input type="text" id="shift_id" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" readonly>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">シフト名 <span class="text-red-500">*</span></label>
                <input type="text" id="shift_name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">開始時間 (HH:MM)</label>
                  <input type="time" id="shift_start_time" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">終了時間 (HH:MM)</label>
                  <input type="time" id="shift_end_time" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">備考</label>
                <textarea id="shift_notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
              </div>

              <div class="flex space-x-4 mt-6">
                <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">
                  保存
                </button>
                <button type="button" onclick="closeShiftMasterForm()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition">
                  キャンセル
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- シフト管理画面（管理者専用） -->
      <div id="shiftManagementView" class="hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold mb-6 text-gray-800">シフト管理</h2>
          <p class="text-gray-600 mb-6">シフト作成に必要なCSV出力や、提出締切の管理を行います。</p>

          <!-- 対象月選択 -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">対象月</label>
            <input type="month" id="shiftMgmtTargetMonth"
              class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              onchange="loadShiftManagementStatus()">
          </div>

          <!-- 月次設定カード -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- 公休日数設定 -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <h3 class="text-lg font-semibold text-blue-800 mb-3">公休日数設定</h3>
              <div class="flex items-center space-x-4">
                <input type="number" id="monthlyHolidaysInput" min="1" max="31"
                  class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-center text-lg font-bold">
                <span class="text-gray-700">日</span>
                <button onclick="saveMonthlyHolidays()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                  保存
                </button>
              </div>
              <p class="text-sm text-blue-600 mt-2">職員が選択できる休み希望の上限数です</p>
            </div>

            <!-- 提出締切設定 -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
              <h3 class="text-lg font-semibold text-yellow-800 mb-3">提出締切設定</h3>
              <div id="submissionLockStatus" class="mb-3">
                <!-- 状態が動的に表示される -->
              </div>
              <div class="flex space-x-2">
                <button onclick="toggleSubmissionLock(true)" id="lockButton" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">
                  締切（ロック）
                </button>
                <button onclick="toggleSubmissionLock(false)" id="unlockButton" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                  受付中（解除）
                </button>
              </div>
            </div>
          </div>

          <!-- シフト作成フロー -->
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">シフト作成フロー</h3>

            <div class="space-y-4">
              <!-- ステップ1: CSV出力 -->
              <div class="flex items-start space-x-4 p-4 bg-white rounded-lg border border-gray-200">
                <div class="flex-shrink-0 w-10 h-10 bg-green-500 text-white rounded-full flex items-center justify-center font-bold">1</div>
                <div class="flex-grow">
                  <h4 class="font-semibold text-gray-800">シフト作成用CSV一括出力</h4>
                  <p class="text-sm text-gray-600 mb-3">シフト最適化に必要な3種類のCSVをGoogleドライブに出力します。</p>
                  <ul class="text-xs text-gray-500 mb-3 list-disc list-inside">
                    <li>T_休み希望_YYYYMM.csv - 休み希望データ</li>
                    <li>M_職員_YYYYMM.csv - 職員マスタ</li>
                    <li>M_設定_YYYYMM.csv - 月間設定</li>
                  </ul>
                  <button onclick="exportAllCSVForShiftCreation()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">
                    3種CSV一括出力
                  </button>
                  <div id="csvExportResult" class="mt-2 text-sm"></div>
                </div>
              </div>

              <!-- ステップ2: Python実行 -->
              <div class="flex items-start space-x-4 p-4 bg-white rounded-lg border border-gray-200">
                <div class="flex-shrink-0 w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold">2</div>
                <div class="flex-grow">
                  <h4 class="font-semibold text-gray-800">シフト最適化実行（Google Colab）</h4>
                  <p class="text-sm text-gray-600 mb-3">Google Colabでシフト最適化Pythonを実行してください。</p>
                  <p class="text-sm text-gray-500 mb-3">→ 結果CSVがGoogleドライブのoutputフォルダに保存されます。</p>
                  <div id="colabLinkContainer">
                    <a id="colabLinkButton" href="#" target="_blank" rel="noopener noreferrer"
                      class="hidden inline-block bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                      Google Colabを開く
                    </a>
                    <p id="colabLinkNotSet" class="hidden text-xs text-gray-400">※ スクリプトプロパティ「GOOGLE_COLAB_URL」にColabのURLを設定すると、ここにリンクボタンが表示されます。</p>
                  </div>
                </div>
              </div>

              <!-- ステップ3: CSV取込 -->
              <div class="flex items-start space-x-4 p-4 bg-white rounded-lg border border-gray-200">
                <div class="flex-shrink-0 w-10 h-10 bg-purple-500 text-white rounded-full flex items-center justify-center font-bold">3</div>
                <div class="flex-grow">
                  <h4 class="font-semibold text-gray-800">シフト結果CSV取込</h4>
                  <p class="text-sm text-gray-600 mb-3">対象月のシフト結果CSVを自動で検索して取り込みます。</p>
                  <p class="text-xs text-gray-500 mb-3">対象ファイル: シフト結果_YYYYMM.csv</p>
                  <button onclick="importShiftCSVByMonth()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition">
                    シフト結果取込
                  </button>
                  <div id="csvImportResult" class="mt-2 text-sm"></div>
                </div>
              </div>

              <!-- ステップ4: 確認・修正・カレンダー登録 -->
              <div class="flex items-start space-x-4 p-4 bg-white rounded-lg border border-orange-300 bg-orange-50">
                <div class="flex-shrink-0 w-10 h-10 bg-orange-500 text-white rounded-full flex items-center justify-center font-bold">4</div>
                <div class="flex-grow">
                  <h4 class="font-semibold text-gray-800">シフト確認・修正・カレンダー登録</h4>
                  <p class="text-sm text-gray-600 mb-3">「シフト修正」画面でグループごとにシフトを確認・修正し、確定してカレンダーに登録します。</p>
                  <button onclick="showView('shift-edit')" class="bg-orange-600 text-white px-6 py-2 rounded-lg hover:bg-orange-700 transition">
                    シフト修正画面へ
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div id="shiftManagementMessage" class="mt-4 hidden"></div>
        </div>
      </div>

      <!-- シフト修正画面 -->
      <div id="shiftEditView" class="hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold mb-4 text-gray-800">シフト修正</h2>

          <!-- 操作パネル -->
          <div class="mb-4">
            <div class="flex flex-wrap items-start gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
              <!-- 対象月 -->
              <div class="flex flex-col">
                <label class="text-xs font-medium text-gray-600 mb-1">対象月</label>
                <input type="month" id="shiftEditTargetMonth"
                  class="px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500">
              </div>
              <!-- グループ -->
              <div class="flex flex-col">
                <label class="text-xs font-medium text-gray-600 mb-1">グループ</label>
                <div id="shiftEditGroup" class="flex flex-wrap gap-x-2 gap-y-0.5"></div>
              </div>
              <!-- ユニット -->
              <div class="flex flex-col">
                <label class="text-xs font-medium text-gray-600 mb-1">ユニット</label>
                <div id="shiftEditUnit" class="flex flex-wrap gap-x-2 gap-y-0.5"></div>
              </div>
              <!-- 雇用形態 -->
              <div class="flex flex-col">
                <label class="text-xs font-medium text-gray-600 mb-1">雇用形態</label>
                <div id="shiftEditEmployment" class="flex flex-wrap gap-x-2 gap-y-0.5"></div>
              </div>
              <!-- 属性フィルター -->
              <div class="flex flex-col gap-0.5 pt-4">
                <label class="flex items-center gap-1 text-xs cursor-pointer">
                  <input type="checkbox" id="shiftEditSuctionOnly" onchange="applyFiltersAndRender()"> 喀痰吸引資格者のみ
                </label>
                <label class="flex items-center gap-1 text-xs cursor-pointer">
                  <input type="checkbox" id="shiftEditCareOnly" onchange="applyFiltersAndRender()"> 勤務配慮ありのみ
                </label>
              </div>
              <!-- ボタン群 -->
              <div class="flex flex-col gap-1 pt-3">
                <div class="flex gap-2">
                  <button onclick="loadShiftEditData()" class="bg-blue-600 text-white px-4 py-1.5 rounded text-sm hover:bg-blue-700 transition">
                    表示
                  </button>
                  <button onclick="showView('shift-management')" class="bg-gray-500 text-white px-4 py-1.5 rounded text-sm hover:bg-gray-600 transition">
                    戻る
                  </button>
                </div>
                <button onclick="clearShiftEditFilters()" class="text-xs text-blue-600 hover:underline">
                  フィルターをリセット
                </button>
              </div>
              <!-- 確定ボタン（右寄せ） -->
              <div id="btnConfirmArea" class="hidden ml-auto flex gap-2 pt-3">
                <button id="btnConfirmOnly" onclick="confirmShiftsOnly()" class="bg-blue-600 text-white px-4 py-1.5 rounded text-sm hover:bg-blue-700 transition font-semibold">
                  確定
                </button>
                <button id="btnConfirmCalendar" onclick="confirmAndRegisterCalendar()" class="bg-red-600 text-white px-4 py-1.5 rounded text-sm hover:bg-red-700 transition font-semibold">
                  Googleカレンダー登録して確定
                </button>
              </div>
            </div>
          </div>

          <!-- シフト編集テーブル -->
          <div id="shiftEditTableContainer" class="hidden">
            <!-- 凡例 -->
            <div class="mb-3 flex flex-wrap gap-4 text-sm">
              <span class="flex items-center"><span class="w-4 h-4 bg-blue-100 border border-blue-300 mr-1"></span>土曜日</span>
              <span class="flex items-center"><span class="w-4 h-4 bg-pink-100 border border-pink-300 mr-1"></span>日曜・祝日</span>
              <span class="flex items-center"><span class="w-4 h-4 border mr-1" style="background-color:#FFFDE7; border-color:#FDD835;"></span>喀痰吸引資格者</span>
            </div>

            <!-- シフトテーブル -->
            <div class="overflow-x-auto border border-gray-200 rounded-lg mb-6">
              <table id="shiftEditTable" class="min-w-full text-sm">
                <thead class="bg-gray-50"></thead>
                <tbody></tbody>
              </table>
            </div>

            <!-- 集計（日別） -->
            <div class="mb-6">
              <h3 class="text-lg font-semibold text-gray-800 mb-3">集計（日別）</h3>
              <div class="overflow-x-auto border border-gray-200 rounded-lg">
                <table id="shiftDailyStatsTable" class="min-w-full text-sm">
                  <thead class="bg-gray-50"></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <!-- 集計（職員別） -->
            <div class="mb-6">
              <h3 class="text-lg font-semibold text-gray-800 mb-3">集計（職員別）</h3>
              <div class="overflow-x-auto border border-gray-200 rounded-lg">
                <table id="shiftStatsTable" class="min-w-full text-sm">
                  <thead class="bg-gray-50"></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- 診断レポートパネル -->
          <div id="diagnosticsPanel" class="hidden mt-6">
            <div class="bg-white border border-gray-200 rounded-lg p-6">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">診断レポート（Google Colabから取得）</h3>
                <button onclick="runDiagnostics()"
                  class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition text-sm">
                  診断を実行
                </button>
              </div>
              <div id="diagnosticsResult" class="hidden">
                <div id="diagnosticsSummary" class="flex gap-4 mb-4"></div>
                <div id="diagnosticsFilters" class="hidden flex gap-4 mb-4 items-center">
                  <label class="text-sm font-medium text-gray-600">フィルター:</label>
                  <select id="diagnosticsGroupFilter" onchange="applyDiagnosticsFilter()" class="px-3 py-1 border border-gray-300 rounded text-sm">
                    <option value="">全グループ</option>
                  </select>
                  <select id="diagnosticsStaffFilter" onchange="applyDiagnosticsFilter()" class="px-3 py-1 border border-gray-300 rounded text-sm">
                    <option value="">全職員</option>
                  </select>
                </div>
                <div id="diagnosticsList"></div>
              </div>
              <p id="diagnosticsEmpty" class="text-gray-500 text-sm">
                「診断を実行」ボタンを押すと、現在のシフトデータのルール違反を確認できます。
              </p>
            </div>
          </div>

          <div id="shiftEditMessage" class="mt-4 hidden"></div>
        </div>
      </div>

      <!-- 勤務指定管理画面（管理者専用） -->
      <div id="shiftAssignmentView" class="hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold mb-4 text-gray-800">事前勤務指定（シフト固定）</h2>
          <p class="text-gray-600 mb-4 text-sm bg-yellow-50 border border-yellow-200 rounded p-3">
            自動シフト作成前に特定の職員の特定日のシフトを固定できます。
            3種CSV出力時に M_設定.csv に含まれます。
          </p>
          <div class="mb-4 flex gap-2">
            <input type="month" id="shiftAssignTargetMonth"
              class="px-4 py-2 border border-gray-300 rounded-lg">
            <button onclick="loadShiftAssignments()"
              class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">
              表示
            </button>
          </div>
          <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">
            <h3 class="text-md font-semibold text-purple-800 mb-3">新規勤務指定を追加</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">職員名</label>
                <select id="assignStaffName"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                  <option value="">-- 選択 --</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">日付</label>
                <input type="date" id="assignDate"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">シフト</label>
                <select id="assignShiftName"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                  <option value="">-- 選択 --</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">備考</label>
                <input type="text" id="assignNotes"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
              </div>
            </div>
            <div class="mt-3">
              <button onclick="addShiftAssignment()"
                class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition text-sm">
                指定を追加
              </button>
            </div>
            <p id="assignmentAddMessage" class="mt-2 text-sm hidden"></p>
          </div>
          <h3 class="text-md font-semibold text-gray-800 mb-3">勤務指定一覧</h3>
          <div class="overflow-x-auto border border-gray-200 rounded-lg">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">日付</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">職員名</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">G</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">シフト</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">備考</th>
                  <th class="px-4 py-2 text-center text-xs font-medium text-gray-500">操作</th>
                </tr>
              </thead>
              <tbody id="assignmentTableBody" class="bg-white divide-y divide-gray-200">
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- マニュアル画面 -->
      <div id="manualView" class="hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold mb-6 text-gray-800">使い方マニュアル</h2>

          <!-- マニュアル内ナビゲーション -->
          <div class="flex flex-wrap gap-2 mb-6 pb-4 border-b">
            <button onclick="showManualSection('manual-overview')" class="manual-nav-btn px-3 py-1 rounded bg-blue-100 text-blue-800 text-sm font-medium hover:bg-blue-200 transition">全体の流れ</button>
            <button onclick="showManualSection('manual-staff')" class="manual-nav-btn px-3 py-1 rounded bg-gray-100 text-gray-700 text-sm font-medium hover:bg-gray-200 transition">職員向け</button>
            <button onclick="showManualSection('manual-admin')" class="manual-nav-btn px-3 py-1 rounded bg-gray-100 text-gray-700 text-sm font-medium hover:bg-gray-200 transition">管理者向け</button>
            <button onclick="showManualSection('manual-python')" class="manual-nav-btn px-3 py-1 rounded bg-gray-100 text-gray-700 text-sm font-medium hover:bg-gray-200 transition">シフト自動作成</button>
            <button onclick="showManualSection('manual-rules')" class="manual-nav-btn px-3 py-1 rounded bg-gray-100 text-gray-700 text-sm font-medium hover:bg-gray-200 transition">シフトルール</button>
            <button onclick="showManualSection('manual-faq')" class="manual-nav-btn px-3 py-1 rounded bg-gray-100 text-gray-700 text-sm font-medium hover:bg-gray-200 transition">よくある質問</button>
          </div>

          <!-- 全体の流れ -->
          <div id="manual-overview" class="manual-section">
            <h3 class="text-xl font-bold mb-4 text-blue-700">毎月のシフト作成の流れ</h3>
            <div class="space-y-4">
              <div class="flex items-start gap-4 p-4 bg-blue-50 rounded-lg">
                <div class="flex-shrink-0 w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold text-lg">1</div>
                <div>
                  <p class="font-bold text-blue-800">職員が休み希望を入力</p>
                  <p class="text-sm text-gray-600 mt-1">各職員がログインして、カレンダーから希望休の日を選びます。第1希望、第2希望...と優先順位をつけられます。</p>
                </div>
              </div>
              <div class="flex items-start gap-4 p-4 bg-blue-50 rounded-lg">
                <div class="flex-shrink-0 w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold text-lg">2</div>
                <div>
                  <p class="font-bold text-blue-800">管理者が提出を締め切る</p>
                  <p class="text-sm text-gray-600 mt-1">「シフト管理」画面から提出締切を設定します。締切後は職員が変更できなくなります。</p>
                </div>
              </div>
              <div class="flex items-start gap-4 p-4 bg-blue-50 rounded-lg">
                <div class="flex-shrink-0 w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold text-lg">3</div>
                <div>
                  <p class="font-bold text-blue-800">管理者が勤務指定を入力（任意）</p>
                  <p class="text-sm text-gray-600 mt-1">「勤務指定」画面で、特定の職員・日付のシフトを事前に固定できます（研修日など）。</p>
                </div>
              </div>
              <div class="flex items-start gap-4 p-4 bg-green-50 rounded-lg">
                <div class="flex-shrink-0 w-10 h-10 bg-green-600 text-white rounded-full flex items-center justify-center font-bold text-lg">4</div>
                <div>
                  <p class="font-bold text-green-800">3種CSV出力 → Python自動計算</p>
                  <p class="text-sm text-gray-600 mt-1">「シフト管理」画面から3種CSVを出力し、Google Colabで自動シフト作成を実行します。完了するとシステムに自動取込されます。</p>
                </div>
              </div>
              <div class="flex items-start gap-4 p-4 bg-orange-50 rounded-lg">
                <div class="flex-shrink-0 w-10 h-10 bg-orange-600 text-white rounded-full flex items-center justify-center font-bold text-lg">5</div>
                <div>
                  <p class="font-bold text-orange-800">管理者がシフトを確認・修正</p>
                  <p class="text-sm text-gray-600 mt-1">「シフト修正」画面でフィルターを使って内容を確認し、必要に応じて手修正します。統計情報やルールチェックで問題がないか確認できます。</p>
                </div>
              </div>
              <div class="flex items-start gap-4 p-4 bg-purple-50 rounded-lg">
                <div class="flex-shrink-0 w-10 h-10 bg-purple-600 text-white rounded-full flex items-center justify-center font-bold text-lg">6</div>
                <div>
                  <p class="font-bold text-purple-800">確定（カレンダー登録は任意）</p>
                  <p class="text-sm text-gray-600 mt-1">問題なければ「確定」ボタンでシフトを確定します。必要に応じて「Googleカレンダー登録して確定」で各職員のカレンダーにも反映できます。</p>
                </div>
              </div>
            </div>
          </div>

          <!-- 職員向け -->
          <div id="manual-staff" class="manual-section hidden">
            <h3 class="text-xl font-bold mb-4 text-blue-700">職員向け：休み希望の出し方</h3>

            <div class="space-y-6">
              <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-bold text-gray-800 mb-2">1. ログインする</h4>
                <p class="text-sm text-gray-600">管理者から配布されたログインIDとパスワードでログインしてください。</p>
              </div>

              <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-bold text-gray-800 mb-2">2. 対象月を選ぶ</h4>
                <p class="text-sm text-gray-600">「休み希望提出」画面で対象の年月を選択します。</p>
              </div>

              <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-bold text-gray-800 mb-2">3. カレンダーから希望日をクリック</h4>
                <p class="text-sm text-gray-600">カレンダー上の日付をクリックすると、クリックした順に第1希望、第2希望...と自動で番号がつきます。</p>
                <ul class="text-sm text-gray-600 mt-2 list-disc list-inside space-y-1">
                  <li>もう一度クリックすると解除されます</li>
                  <li>公休日数分まで選択可能です（例: 9日分）</li>
                  <li>第1希望が最も優先されます</li>
                </ul>
              </div>

              <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-bold text-gray-800 mb-2">4. 保存する</h4>
                <p class="text-sm text-gray-600">選択が終わったら「保存」ボタンを押してください。締切後は変更できなくなるので、早めに提出しましょう。</p>
              </div>

              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <p class="text-sm text-yellow-800"><strong>ポイント：</strong>第1希望は最優先で反映されますが、他の職員と希望が重なった場合は調整されることがあります。第2希望以降は「できるだけ叶える」ソフト制約です。</p>
              </div>
            </div>
          </div>

          <!-- 管理者向け -->
          <div id="manual-admin" class="manual-section hidden">
            <h3 class="text-xl font-bold mb-4 text-blue-700">管理者向け：各画面の使い方</h3>

            <div class="space-y-6">
              <!-- シフト管理 -->
              <div class="border border-green-200 rounded-lg p-4">
                <h4 class="font-bold text-green-800 mb-2">シフト管理画面</h4>
                <ul class="text-sm text-gray-600 space-y-2">
                  <li><strong>提出締切設定：</strong>対象月の休み希望提出を「ロック（締切）」または「アンロック（再開）」します。</li>
                  <li><strong>3種CSV一括出力：</strong>Python自動計算に必要な3ファイル（休み希望/職員/設定）をDriveに出力します。</li>
                  <li><strong>シフト結果取込：</strong>Python計算後の結果CSVを手動取込します（通常はWebhookで自動取込されます）。</li>
                  <li><strong>診断レポート：</strong>Python計算時の診断結果を確認できます。職員名やグループでフィルター可能です。</li>
                </ul>
              </div>

              <!-- シフト修正 -->
              <div class="border border-orange-200 rounded-lg p-4">
                <h4 class="font-bold text-orange-800 mb-2">シフト修正画面</h4>
                <ul class="text-sm text-gray-600 space-y-2">
                  <li><strong>フィルター機能：</strong>グループ、ユニット、雇用形態、喀痰吸引資格者、勤務配慮の複数条件でフィルター可能。チェックボックスで即座に反映されます。</li>
                  <li><strong>シフト修正：</strong>セルのプルダウンからシフトを変更できます。変更は即座に統計に反映されます（サーバー通信なし）。</li>
                  <li><strong>黄色背景の行：</strong>喀痰吸引資格者です。夜勤に資格者が入っているか視覚的に確認できます。</li>
                  <li><strong>統計テーブル：</strong>日別の人数集計と個人別の勤務日数・夜勤回数を自動計算して表示します。</li>
                  <li><strong>確定ボタン：</strong>「確定」はシフトデータのみ保存。「Googleカレンダー登録して確定」は各職員のカレンダーにも自動登録します。</li>
                </ul>
              </div>

              <!-- 職員マスタ -->
              <div class="border border-blue-200 rounded-lg p-4">
                <h4 class="font-bold text-blue-800 mb-2">職員マスタ管理画面</h4>
                <ul class="text-sm text-gray-600 space-y-2">
                  <li>職員の新規登録・編集・削除ができます。</li>
                  <li><strong>グループ（1〜6）：</strong>シフト自動作成はグループ単位で行います。</li>
                  <li><strong>喀痰吸引資格者：</strong>ONにすると、法定要件として毎日の配置チェック対象になります。</li>
                  <li><strong>勤務配慮：</strong>ONにすると、夜勤が免除されます。</li>
                  <li><strong>有効：</strong>OFFにするとログイン不可＆シフト作成対象外になります。</li>
                </ul>
              </div>

              <!-- シフトマスタ -->
              <div class="border border-blue-200 rounded-lg p-4">
                <h4 class="font-bold text-blue-800 mb-2">シフトマスタ管理画面</h4>
                <p class="text-sm text-gray-600">シフト種別（早出/日勤/遅出/夜勤/休み）の開始・終了時間を管理します。シフト名の表示はここで設定した名前がシステム全体に反映されます。</p>
              </div>

              <!-- 勤務指定 -->
              <div class="border border-purple-200 rounded-lg p-4">
                <h4 class="font-bold text-purple-800 mb-2">勤務指定画面</h4>
                <ul class="text-sm text-gray-600 space-y-2">
                  <li>自動シフト作成前に、特定の職員・日付のシフトを固定します。</li>
                  <li>研修日や会議など、あらかじめ決まっている勤務を指定する際に使います。</li>
                  <li>指定した内容は3種CSV出力に含まれ、Python計算で考慮されます。</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- シフト自動作成 -->
          <div id="manual-python" class="manual-section hidden">
            <h3 class="text-xl font-bold mb-4 text-blue-700">シフト自動作成（Python/Colab）</h3>

            <div class="space-y-6">
              <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-bold text-gray-800 mb-2">実行手順</h4>
                <ol class="text-sm text-gray-600 list-decimal list-inside space-y-2">
                  <li>Webアプリの「シフト管理」画面で「3種CSV一括出力」を実行</li>
                  <li>Google Colabのノートブックを開く</li>
                  <li>対象年月を設定して実行（1セルで完結）</li>
                  <li>完了すると自動でWebアプリに取り込まれます</li>
                </ol>
              </div>

              <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-bold text-gray-800 mb-2">自動計算の仕組み</h4>
                <p class="text-sm text-gray-600">OR-Tools CP-SAT Solver（Google製の数理最適化エンジン）を使用して、全ての制約条件を満たすシフトを自動計算します。グループ別に最適化し、失敗した場合は自動で制約を緩和してリトライします。</p>
              </div>

              <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-bold text-gray-800 mb-2">診断レポート</h4>
                <p class="text-sm text-gray-600">計算結果と一緒に診断レポート（JSON）が保存されます。「シフト管理」画面の診断レポートセクションで内容を確認できます。職員名やグループでフィルターして、問題点を素早く見つけることができます。</p>
              </div>

              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <p class="text-sm text-yellow-800"><strong>注意：</strong>自動計算の結果は「高精度なたたき台」です。必ず「シフト修正」画面で確認し、現場の事情に合わせて手修正してから確定してください。</p>
              </div>
            </div>
          </div>

          <!-- シフトルール -->
          <div id="manual-rules" class="manual-section hidden">
            <h3 class="text-xl font-bold mb-4 text-blue-700">シフトルール一覧</h3>

            <div class="space-y-4">
              <div class="overflow-x-auto">
                <table class="min-w-full text-sm border-collapse">
                  <thead>
                    <tr class="bg-gray-100">
                      <th class="border px-3 py-2 text-left">ルール</th>
                      <th class="border px-3 py-2 text-left">内容</th>
                      <th class="border px-3 py-2 text-left">優先度</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr><td class="border px-3 py-2 font-medium">公休数の遵守</td><td class="border px-3 py-2">月の暦日数 - 公休数 = 勤務日数。必ず守ります。</td><td class="border px-3 py-2 text-red-600 font-bold">必須</td></tr>
                    <tr><td class="border px-3 py-2 font-medium">連勤制限</td><td class="border px-3 py-2">連続5日まで（6連勤以上は不可）</td><td class="border px-3 py-2 text-red-600 font-bold">必須</td></tr>
                    <tr><td class="border px-3 py-2 font-medium">夜勤明けルール</td><td class="border px-3 py-2">夜勤の翌日は「休み」、翌々日も「休み」（夜勤→休→休）</td><td class="border px-3 py-2 text-red-600 font-bold">必須</td></tr>
                    <tr><td class="border px-3 py-2 font-medium">勤務間インターバル</td><td class="border px-3 py-2">遅出→翌日早出は禁止</td><td class="border px-3 py-2 text-red-600 font-bold">必須</td></tr>
                    <tr><td class="border px-3 py-2 font-medium">勤務配慮</td><td class="border px-3 py-2">勤務配慮ありの職員は夜勤免除</td><td class="border px-3 py-2 text-red-600 font-bold">必須</td></tr>
                    <tr><td class="border px-3 py-2 font-medium">資格者配置</td><td class="border px-3 py-2">施設全体で毎日1名以上の喀痰吸引資格者を配置（法的要件）</td><td class="border px-3 py-2 text-red-600 font-bold">必須</td></tr>
                    <tr><td class="border px-3 py-2 font-medium">第1休み希望</td><td class="border px-3 py-2">第1希望は必ず休みにする</td><td class="border px-3 py-2 text-red-600 font-bold">必須</td></tr>
                    <tr class="bg-yellow-50"><td class="border px-3 py-2 font-medium">最低人数</td><td class="border px-3 py-2">グループ別：早出2名/日勤1名（日曜0可）/遅出1名/夜勤1名 以上</td><td class="border px-3 py-2 text-yellow-700">できるだけ</td></tr>
                    <tr class="bg-yellow-50"><td class="border px-3 py-2 font-medium">第2希望以降の休み</td><td class="border px-3 py-2">できるだけ叶えるが、他の制約と衝突する場合は調整される</td><td class="border px-3 py-2 text-yellow-700">できるだけ</td></tr>
                    <tr class="bg-yellow-50"><td class="border px-3 py-2 font-medium">夜勤の資格者配置</td><td class="border px-3 py-2">夜勤にも施設全体で1名以上の資格者を配置</td><td class="border px-3 py-2 text-yellow-700">できるだけ</td></tr>
                  </tbody>
                </table>
              </div>

              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h4 class="font-bold text-blue-800 mb-2">夜勤の休日カウントについて</h4>
                <p class="text-sm text-gray-600">夜勤は日をまたぐため、シフト表では2日分（当日「夜勤」＋翌日「休み」）として表示されます。ただし休日カウントとしては、夜勤明けの翌日のみが実質的な公休1日となります。</p>
                <p class="text-sm text-gray-600 mt-1">例: 21日「夜勤」→ 22日「休み」→ 23日「休み」の場合、公休は1日としてカウント。</p>
              </div>
            </div>
          </div>

          <!-- よくある質問 -->
          <div id="manual-faq" class="manual-section hidden">
            <h3 class="text-xl font-bold mb-4 text-blue-700">よくある質問</h3>

            <div class="space-y-4">
              <div class="border rounded-lg p-4">
                <p class="font-bold text-gray-800">Q. 休み希望を出し忘れました</p>
                <p class="text-sm text-gray-600 mt-1">A. 締切前であれば、いつでもログインして入力・修正できます。締切後は管理者に相談してください。</p>
              </div>
              <div class="border rounded-lg p-4">
                <p class="font-bold text-gray-800">Q. 希望が通らないことはありますか？</p>
                <p class="text-sm text-gray-600 mt-1">A. 第1希望は必ず反映されます。第2希望以降は、他の職員と重なった場合に調整されることがあります。</p>
              </div>
              <div class="border rounded-lg p-4">
                <p class="font-bold text-gray-800">Q. シフト修正画面の黄色い行は何ですか？</p>
                <p class="text-sm text-gray-600 mt-1">A. 喀痰吸引資格者の行です。夜勤に資格者が入っているか視覚的に確認するための目印です。</p>
              </div>
              <div class="border rounded-lg p-4">
                <p class="font-bold text-gray-800">Q. 自動計算が失敗（INFEASIBLE）になりました</p>
                <p class="text-sm text-gray-600 mt-1">A. 制約を全て満たすシフトが組めない状態です。診断レポートで原因を確認してください。よくある原因: グループの人数不足、夜勤可能者不足、休み希望の集中。</p>
              </div>
              <div class="border rounded-lg p-4">
                <p class="font-bold text-gray-800">Q. カレンダー登録せずに確定できますか？</p>
                <p class="text-sm text-gray-600 mt-1">A. はい。「確定」ボタンを使えば、Googleカレンダーへの登録なしでシフトを確定できます。</p>
              </div>
              <div class="border rounded-lg p-4">
                <p class="font-bold text-gray-800">Q. フィルターで絞り込んだ時、他の職員のデータは消えますか？</p>
                <p class="text-sm text-gray-600 mt-1">A. いいえ。フィルターは表示の絞り込みだけです。編集した内容も保持されます。全員チェックを戻せば全職員が表示されます。</p>
              </div>
            </div>
          </div>

        </div>
      </div>

    </main>
  </div>

  <script>
    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // グローバル変数
    let currentSession = null;
    // 選択された休み希望: [{day: 数値, priority: 数値}]
    let selectedRequests = [];
    // 月間公休数（優先順位の上限）
    let maxHolidays = 9;
    // カレンダーに表示中のイベントキャッシュ
    var currentEvents = [];
    // カレンダーに表示中の勤務指定キャッシュ（ログイン中ユーザーの分）
    var currentAssignments = [];

    // ページ読み込み時の初期化
    window.onload = function() {
      hideLoading();
      showView('login');
    };

    // ローディング表示
    function showLoading() {
      document.getElementById('loading').classList.remove('hidden');
    }

    function hideLoading() {
      document.getElementById('loading').classList.add('hidden');
    }

    // ビュー切り替え
    function showView(viewName) {
      // ハイフン区切りの名前をキャメルケースのIDに変換
      const viewIdMap = {
        'login': 'loginView',
        'holiday-request': 'holidayRequestView',
        'staff-master': 'staffMasterView',
        'shift-master': 'shiftMasterView',
        'shift-management': 'shiftManagementView',
        'shift-edit': 'shiftEditView',
        'shift-assignment': 'shiftAssignmentView',
        'manual': 'manualView'
      };

      const viewId = viewIdMap[viewName] || viewName;

      const views = ['loginView', 'holidayRequestView', 'staffMasterView', 'shiftMasterView', 'shiftManagementView', 'shiftEditView', 'shiftAssignmentView', 'manualView'];
      views.forEach(v => {
        document.getElementById(v).classList.add('hidden');
      });

      if (viewName === 'login') {
        document.getElementById('loginView').classList.remove('hidden');
        document.getElementById('app').classList.remove('hidden');
        document.getElementById('userInfo').classList.add('hidden');
        document.getElementById('adminNav').classList.add('hidden');
      } else {
        document.getElementById(viewId).classList.remove('hidden');
        document.getElementById('app').classList.remove('hidden');
        document.getElementById('userInfo').classList.remove('hidden');

        if (currentSession && currentSession.isAdmin) {
          document.getElementById('adminNav').classList.remove('hidden');
        }

        // ビュー表示時の処理
        if (viewId === 'holidayRequestView') {
          initHolidayRequestView();
        } else if (viewId === 'staffMasterView') {
          loadStaffList();
        } else if (viewId === 'shiftMasterView') {
          loadShiftMasterList();
        } else if (viewId === 'shiftManagementView') {
          initShiftManagementView();
        } else if (viewId === 'shiftEditView') {
          initShiftEditView();
        } else if (viewId === 'shiftAssignmentView') {
          initShiftAssignmentView();
        }
      }
    }

    // マニュアル内セクション切替
    function showManualSection(sectionId) {
      document.querySelectorAll('.manual-section').forEach(function(el) {
        el.classList.add('hidden');
      });
      document.getElementById(sectionId).classList.remove('hidden');
      document.querySelectorAll('.manual-nav-btn').forEach(function(btn) {
        btn.classList.remove('bg-blue-100', 'text-blue-800');
        btn.classList.add('bg-gray-100', 'text-gray-700');
      });
      var btns = document.querySelectorAll('.manual-nav-btn');
      var sectionMap = ['manual-overview', 'manual-staff', 'manual-admin', 'manual-python', 'manual-rules', 'manual-faq'];
      var idx = sectionMap.indexOf(sectionId);
      if (idx >= 0 && btns[idx]) {
        btns[idx].classList.remove('bg-gray-100', 'text-gray-700');
        btns[idx].classList.add('bg-blue-100', 'text-blue-800');
      }
    }

    // ログイン処理
    function handleLogin(event) {
      event.preventDefault();
      showLoading();

      const loginId = document.getElementById('loginId').value;
      const password = document.getElementById('loginPassword').value;

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            currentSession = result.session;
            document.getElementById('userName').textContent = result.session.name;
            document.getElementById('loginError').classList.add('hidden');
            showView('holiday-request');
          } else {
            document.getElementById('loginError').textContent = result.message;
            document.getElementById('loginError').classList.remove('hidden');
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          document.getElementById('loginError').textContent = 'エラーが発生しました';
          document.getElementById('loginError').classList.remove('hidden');
          console.error(error);
        })
        .apiLogin(loginId, password);
    }

    // ログアウト
    function logout() {
      showLoading();
      google.script.run
        .withSuccessHandler(function() {
          currentSession = null;
          hideLoading();
          showView('login');
        })
        .withFailureHandler(function(error) {
          hideLoading();
          console.error(error);
        })
        .apiLogout();
    }

    // 休み希望提出画面の初期化
    function initHolidayRequestView() {
      const now = new Date();
      document.getElementById('targetMonth').value =
        now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
      if (currentSession && currentSession.isAdmin) {
        document.getElementById('eventManagementSection').classList.remove('hidden');
      }
      loadHolidayRequest();
    }

    // 休み希望読み込み
    function loadHolidayRequest() {
      const targetMonth = document.getElementById('targetMonth').value;
      if (!targetMonth) return;

      const [year, month] = targetMonth.split('-').map(Number);
      const configKey = `MONTHLY_HOLIDAYS_${year}${String(month).padStart(2, '0')}`;

      showLoading();

      // まず公休数を取得してから休み希望を読み込む
      google.script.run
        .withSuccessHandler(function(configResult) {
          // 公休数をグローバル変数に保存
          maxHolidays = configResult.value ? parseInt(configResult.value) : 9;
          console.log(`公休数を取得: ${maxHolidays}日`);

          // 休み希望を読み込む
          google.script.run
            .withSuccessHandler(function(result) {
              if (result.success) {
                google.script.run
                  .withSuccessHandler(function(evResult) {
                    var events = evResult.success ? evResult.events : [];
                    // 自分の勤務指定を取得してカレンダーに反映
                    google.script.run
                      .withSuccessHandler(function(aResult) {
                        hideLoading();
                        var assignments = aResult.success ? aResult.assignments : [];
                        renderCalendar(year, month, result.data, events, assignments);
                      })
                      .withFailureHandler(function(e) {
                        hideLoading();
                        renderCalendar(year, month, result.data, events, []);
                        console.error(e);
                      })
                      .apiGetMyShiftAssignments(year, month);
                  })
                  .withFailureHandler(function(e) {
                    hideLoading();
                    renderCalendar(year, month, result.data, [], []);
                    console.error(e);
                  })
                  .apiGetEventsByMonth(year, month);
              } else {
                hideLoading();
              }
            })
            .withFailureHandler(function(error) {
              hideLoading();
              console.error(error);
            })
            .apiGetHolidayRequest(currentSession.staffId, year, month);
        })
        .withFailureHandler(function(error) {
          console.error('公休数取得エラー:', error);
          maxHolidays = 9; // デフォルト値

          // エラーでも休み希望は読み込む
          google.script.run
            .withSuccessHandler(function(result) {
              if (result.success) {
                google.script.run
                  .withSuccessHandler(function(evResult) {
                    var events = evResult.success ? evResult.events : [];
                    google.script.run
                      .withSuccessHandler(function(aResult) {
                        hideLoading();
                        var assignments = aResult.success ? aResult.assignments : [];
                        renderCalendar(year, month, result.data, events, assignments);
                      })
                      .withFailureHandler(function(e) {
                        hideLoading();
                        renderCalendar(year, month, result.data, events, []);
                        console.error(e);
                      })
                      .apiGetMyShiftAssignments(year, month);
                  })
                  .withFailureHandler(function(e) {
                    hideLoading();
                    renderCalendar(year, month, result.data, [], []);
                    console.error(e);
                  })
                  .apiGetEventsByMonth(year, month);
              } else {
                hideLoading();
              }
            })
            .withFailureHandler(function(error) {
              hideLoading();
              console.error(error);
            })
            .apiGetHolidayRequest(currentSession.staffId, year, month);
        })
        .apiGetConfig(configKey);

      // ロック状態をチェック
      checkSubmissionLock(year, month);

      // 公休上限を表示
      displayHolidayLimit(year, month);
    }

    // 公休上限を表示
    function displayHolidayLimit(year, month) {
      const configKey = `MONTHLY_HOLIDAYS_${year}${String(month).padStart(2, '0')}`;

      google.script.run
        .withSuccessHandler(function(result) {
          const maxHolidays = result.value ? parseFloat(result.value) : 9;
          const daysInMonth = new Date(year, month, 0).getDate();

          // カレンダーの上に情報を表示
          const calendar = document.getElementById('calendar');
          const infoDiv = document.createElement('div');
          infoDiv.className = 'mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm';
          infoDiv.innerHTML = `
            <p class="font-semibold text-blue-800">📅 ${year}年${month}月の情報</p>
            <p class="text-blue-700">• 暦日数: ${daysInMonth}日</p>
            <p class="text-blue-700">• 月間公休上限: <span class="font-bold text-lg">${maxHolidays}日</span></p>
            <p class="text-blue-700">• 現在選択中: <span id="selectedCount" class="font-bold text-lg">${selectedDates.length}日</span></p>
          `;

          // 既存の情報表示があれば削除
          const existingInfo = calendar.previousElementSibling;
          if (existingInfo && existingInfo.classList.contains('bg-blue-50')) {
            existingInfo.remove();
          }

          calendar.parentNode.insertBefore(infoDiv, calendar);
        })
        .apiGetConfig(configKey);
    }

    // 提出ロック状態をチェック
    function checkSubmissionLock(year, month) {
      const lockKey = `SUBMISSION_LOCK_${year}${String(month).padStart(2, '0')}`;

      google.script.run
        .withSuccessHandler(function(result) {
          const isLocked = result.value === 'TRUE' || result.value === true;
          const lockMessage = document.getElementById('lockMessage');
          const saveButton = document.getElementById('saveButton');

          if (isLocked) {
            lockMessage.classList.remove('hidden');
            saveButton.disabled = true;
            saveButton.classList.add('opacity-50', 'cursor-not-allowed');
          } else {
            lockMessage.classList.add('hidden');
            saveButton.disabled = false;
            saveButton.classList.remove('opacity-50', 'cursor-not-allowed');
          }
        })
        .apiGetConfig(lockKey);
    }

    // カレンダー描画
    function renderCalendar(year, month, existingRequests, events, assignments) {
      events = events || [];
      assignments = assignments || [];
      if (events.length > 0) currentEvents = events;
      if (assignments.length > 0) currentAssignments = assignments;
      // 日→イベントリストのマップ
      var eventMap = {};
      events.forEach(function(e) {
        var day = parseInt(e['日付'].split('-')[2]);
        if (!eventMap[day]) eventMap[day] = [];
        eventMap[day].push(e);
      });
      // 日→勤務指定マップ（ログイン中ユーザーのみ）
      var assignmentMap = {};
      assignments.forEach(function(a) {
        var day = parseInt(a['日付'].split('-')[2]);
        assignmentMap[day] = a;
      });
      const calendarDiv = document.getElementById('calendar');
      calendarDiv.innerHTML = '';

      // existingRequestsから選択された日付と優先順位を復元
      selectedRequests = existingRequests.map(req => ({
        day: new Date(req['日付']).getDate(),
        priority: req['優先順位'] || 1
      }));

      const daysInMonth = new Date(year, month, 0).getDate();
      const firstDay = new Date(year, month - 1, 1).getDay();

      let html = '<div class="grid grid-cols-7 gap-2">';

      // 曜日ヘッダー
      const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
      dayNames.forEach((name, index) => {
        const color = index === 0 ? 'text-red-600' : index === 6 ? 'text-blue-600' : 'text-gray-700';
        html += `<div class="text-center font-bold ${color}">${name}</div>`;
      });

      // 空白セル
      for (let i = 0; i < firstDay; i++) {
        html += '<div></div>';
      }

      // 日付セル
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month - 1, day);
        const dayOfWeek = date.getDay();
        const request = selectedRequests.find(r => r.day === day);
        const isSelected = !!request;
        const assignment = assignmentMap[day];
        const isAssigned = !!assignment;

        let bgColor, textColor;
        if (isAssigned) {
          // 勤務指定あり: 紫系・選択不可
          bgColor = 'bg-purple-100 cursor-not-allowed';
          textColor = dayOfWeek === 0 ? 'text-red-400' : dayOfWeek === 6 ? 'text-blue-400' : 'text-purple-700';
        } else if (isSelected) {
          bgColor = 'bg-blue-500 text-white';
          textColor = 'text-white';
        } else {
          bgColor = 'bg-white hover:bg-blue-100';
          textColor = dayOfWeek === 0 ? 'text-red-600' : dayOfWeek === 6 ? 'text-blue-600' : 'text-gray-700';
        }

        // 優先順位バッジ or 勤務指定バッジ
        const priorityBadge = isSelected ? `<span class="text-xs">第${request.priority}希望</span>` : '';
        const assignBadge = isAssigned
          ? `<span class="text-xs px-1 bg-purple-500 text-white rounded">${assignment['シフト名'] || assignment['シフトID']}</span>`
          : '';

        // 勤務指定日はonclickなし（選択不可）
        const clickAttr = isAssigned ? '' : `onclick="toggleDate(${day})"`;

        html += `<div class="calendar-day ${isSelected ? 'selected' : ''} ${bgColor} ${textColor} border border-gray-300 rounded p-2 text-center" ${clickAttr}>
                  <div class="font-bold">${day}</div>
                  ${priorityBadge}${assignBadge}
                </div>`;
      }

      html += '</div>';
      calendarDiv.innerHTML = html;

      // イベントマーカーをDOM操作で追加
      var calendarDayEls = calendarDiv.querySelectorAll('.calendar-day');
      var dayIndex = 0;
      for (var d = 1; d <= daysInMonth; d++) {
        var dayEvents = eventMap[d] || [];
        if (dayEvents.length > 0) {
          var dayEl = calendarDiv.querySelector('.calendar-day[data-day="' + d + '"]');
          // data-day属性がない場合は位置で探す
          if (!dayEl) {
            var allDayEls = calendarDiv.querySelectorAll('.calendar-day');
            allDayEls.forEach(function(el) {
              var boldEl = el.querySelector('.font-bold');
              if (boldEl && parseInt(boldEl.textContent) === d) {
                dayEl = el;
              }
            });
          }
          if (dayEl) {
            dayEvents.forEach(function(ev) {
              var evEl = document.createElement('div');
              evEl.className = 'mt-1 px-1 bg-orange-500 text-white text-xs rounded truncate';
              evEl.textContent = ev['タイトル'];
              evEl.title = ev['タイトル'] + (ev['備考'] ? ': ' + ev['備考'] : '');
              dayEl.appendChild(evEl);
            });
          }
        }
      }

      // 選択された日付の一覧を更新
      renderSelectedRequestsList(year, month);
      renderEventList(events);
    }

    // 日付選択トグル
    function toggleDate(day) {
      // 勤務指定がある日は選択不可
      if (currentAssignments.some(function(a) { return parseInt(a['日付'].split('-')[2]) === day; })) return;
      const requestIndex = selectedRequests.findIndex(r => r.day === day);
      if (requestIndex >= 0) {
        // 既に選択されている場合は削除
        selectedRequests.splice(requestIndex, 1);
      } else {
        // 公休数を超えている場合は追加不可
        if (selectedRequests.length >= maxHolidays) {
          alert(`公休上限（${maxHolidays}日）に達しています。\n他の日付を削除してから追加してください。`);
          return;
        }

        // 次に使用可能な優先順位を自動割り当て
        const usedPriorities = selectedRequests.map(r => r.priority);
        let nextPriority = 1;
        for (let p = 1; p <= maxHolidays; p++) {
          if (!usedPriorities.includes(p)) {
            nextPriority = p;
            break;
          }
        }

        selectedRequests.push({ day: day, priority: nextPriority });
      }

      const targetMonth = document.getElementById('targetMonth').value;
      const [year, month] = targetMonth.split('-').map(Number);

      // カレンダーを再描画
      const existingRequests = selectedRequests.map(r => ({
        '日付': new Date(year, month - 1, r.day),
        '優先順位': r.priority
      }));
      renderCalendar(year, month, existingRequests, currentEvents, currentAssignments);

      // 選択中の日数を更新
      const selectedCountElem = document.getElementById('selectedCount');
      if (selectedCountElem) {
        selectedCountElem.textContent = `${selectedRequests.length}日`;
      }
    }

    // 選択された休み希望の一覧を表示
    function renderSelectedRequestsList(year, month) {
      const container = document.getElementById('selectedDatesContainer');
      const tbody = document.getElementById('selectedDatesList');

      if (selectedRequests.length === 0) {
        container.classList.add('hidden');
        return;
      }

      container.classList.remove('hidden');

      // 使用中の優先順位を取得
      const usedPriorities = selectedRequests.map(r => r.priority);

      // 優先順位でソート（日付ではなく優先順位順に表示）
      const sortedRequests = [...selectedRequests].sort((a, b) => a.priority - b.priority);

      let html = '';
      sortedRequests.forEach((request, index) => {
        // 公休数分の選択肢を生成（重複禁止）
        const options = [];
        for (let p = 1; p <= maxHolidays; p++) {
          const isUsed = usedPriorities.includes(p) && p !== request.priority;
          const selected = p === request.priority ? 'selected' : '';
          const disabled = isUsed ? 'disabled' : '';
          const style = isUsed ? 'color: #ccc;' : '';
          options.push(`<option value="${p}" ${selected} ${disabled} style="${style}">第${p}希望${isUsed ? '（使用中）' : ''}</option>`);
        }

        html += `
          <tr class="border-b">
            <td class="py-2 px-2">${month}月${request.day}日</td>
            <td class="py-2 px-2">
              <select onchange="updatePriority(${request.day}, this.value)" class="border border-gray-300 rounded px-2 py-1">
                ${options.join('')}
              </select>
            </td>
            <td class="py-2 px-2 text-center">
              <button onclick="removeRequest(${request.day})" class="text-red-600 hover:text-red-800">
                削除
              </button>
            </td>
          </tr>
        `;
      });

      tbody.innerHTML = html;
    }

    // 優先順位を更新
    function updatePriority(day, priority) {
      const request = selectedRequests.find(r => r.day === day);
      if (request) {
        request.priority = parseInt(priority);

        // カレンダーを再描画（優先順位バッジを更新）
        const targetMonth = document.getElementById('targetMonth').value;
        const [year, month] = targetMonth.split('-').map(Number);
        const existingRequests = selectedRequests.map(r => ({
          '日付': new Date(year, month - 1, r.day),
          '優先順位': r.priority
        }));
        renderCalendar(year, month, existingRequests, currentEvents, currentAssignments);
      }
    }

    // 休み希望を削除
    function removeRequest(day) {
      toggleDate(day);  // トグルで削除
    }

    // 休み希望保存（上限チェック付き）
    function saveHolidayRequest() {
      if (selectedRequests.length === 0) {
        alert('日付を選択してください');
        return;
      }

      const targetMonth = document.getElementById('targetMonth').value;
      const [year, month] = targetMonth.split('-').map(Number);
      const notes = document.getElementById('requestNotes').value;

      // 上限チェック: 月間公休数を取得
      const configKey = `MONTHLY_HOLIDAYS_${year}${String(month).padStart(2, '0')}`;

      showLoading();

      // まず公休数の上限を取得
      google.script.run
        .withSuccessHandler(function(configResult) {
          // デフォルト9日
          const maxHolidays = configResult.value ? parseFloat(configResult.value) : 9;

          // 上限チェック
          if (selectedRequests.length > maxHolidays) {
            hideLoading();
            alert(`⚠️ 休みすぎです！\n\n選択された日数: ${selectedRequests.length}日\n月間公休上限: ${maxHolidays}日\n\n公休上限を超えています。日数を減らしてください。`);
            return;
          }

          // 上限内なので保存処理を実行
          // requestList: [{date: ISO文字列, priority: 数値}]
          const requestList = selectedRequests.map(req => {
            const date = new Date(year, month - 1, req.day);
            return {
              date: date.toISOString(),
              priority: req.priority
            };
          });

          google.script.run
            .withSuccessHandler(function(result) {
              hideLoading();
              if (result && result.success) {
                showMessage('holidayMessage', result.message, 'success');
              } else {
                showMessage('holidayMessage', result ? result.message : 'エラーが発生しました', 'error');
              }
            })
            .withFailureHandler(function(error) {
              hideLoading();
              showMessage('holidayMessage', 'エラーが発生しました', 'error');
              console.error(error);
            })
            .apiSaveHolidayRequest(currentSession.staffId, currentSession.name, requestList, notes);
        })
        .withFailureHandler(function(error) {
          hideLoading();
          console.error('設定取得エラー:', error);
          // エラーでもデフォルト値9日で続行
          if (selectedRequests.length > 9) {
            alert(`⚠️ 休みすぎです！\n\n選択された日数: ${selectedRequests.length}日\nデフォルト公休上限: 9日\n\n公休上限を超えています。日数を減らしてください。`);
            return;
          }

          // 保存処理を実行
          const requestList = selectedRequests.map(req => {
            const date = new Date(year, month - 1, req.day);
            return {
              date: date.toISOString(),
              priority: req.priority
            };
          });

          google.script.run
            .withSuccessHandler(function(result) {
              hideLoading();
              if (result && result.success) {
                showMessage('holidayMessage', result.message, 'success');
              } else {
                showMessage('holidayMessage', result ? result.message : 'エラーが発生しました', 'error');
              }
            })
            .withFailureHandler(function(error) {
              hideLoading();
              showMessage('holidayMessage', 'エラーが発生しました', 'error');
              console.error(error);
            })
            .apiSaveHolidayRequest(currentSession.staffId, currentSession.name, requestList, notes);
        })
        .apiGetConfig(configKey);
    }

    // 休み希望クリア
    function clearHolidayRequest() {
      selectedRequests = [];
      const targetMonth = document.getElementById('targetMonth').value;
      const [year, month] = targetMonth.split('-').map(Number);
      renderCalendar(year, month, [], currentEvents, currentAssignments);
      document.getElementById('requestNotes').value = '';
    }

    // メッセージ表示
    function showMessage(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.textContent = message;
      element.className = type === 'success' ? 'p-4 bg-green-100 text-green-800 rounded-lg' : 'p-4 bg-red-100 text-red-800 rounded-lg';
      element.classList.remove('hidden');

      setTimeout(() => {
        element.classList.add('hidden');
      }, 3000);
    }

    // 職員一覧読み込み
    function loadStaffList() {
      showLoading();

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            renderStaffTable(result.data);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          console.error(error);
        })
        .apiGetAllStaff();
    }

    // 職員テーブル描画
    function renderStaffTable(staffList) {
      const tbody = document.getElementById('staffTableBody');
      tbody.innerHTML = '';

      staffList.forEach(staff => {
        const row = `<tr>
          <td class="px-4 py-3">${staff['氏名']}</td>
          <td class="px-4 py-3">${staff['役職']}</td>
          <td class="px-4 py-3">${staff['グループ']}</td>
          <td class="px-4 py-3">${staff['雇用形態']}</td>
          <td class="px-4 py-3">${staff['有効'] ? '✓' : ''}</td>
          <td class="px-4 py-3">
            <button onclick='editStaff(${JSON.stringify(staff).replace(/'/g, "&#39;")})' class="text-blue-600 hover:underline">
              編集
            </button>
          </td>
        </tr>`;
        tbody.innerHTML += row;
      });
    }

    // 職員編集フォーム表示
    function showStaffForm() {
      document.getElementById('staffFormModal').classList.remove('hidden');
      // フォームをクリア
      document.getElementById('staff_id').value = 'STAFF_' + Date.now();
      document.getElementById('staff_name').value = '';
      document.getElementById('staff_role').value = '';
      document.getElementById('staff_group').value = '1';
      document.getElementById('staff_employment').value = '常勤';
      document.getElementById('staff_login_id').value = '';
      document.getElementById('staff_password').value = '';
      document.getElementById('staff_calendar_id').value = '';
      document.getElementById('staff_qualified').checked = false;
      document.getElementById('staff_care_required').checked = false;
      document.getElementById('staff_active').checked = true;
    }

    // 職員編集
    function editStaff(staff) {
      document.getElementById('staffFormModal').classList.remove('hidden');
      document.getElementById('staff_id').value = staff['職員ID'];
      document.getElementById('staff_name').value = staff['氏名'];
      document.getElementById('staff_role').value = staff['役職'];
      document.getElementById('staff_group').value = staff['グループ'];
      document.getElementById('staff_employment').value = staff['雇用形態'];
      document.getElementById('staff_login_id').value = staff['ログインID'];
      document.getElementById('staff_password').value = staff['パスワード'];
      document.getElementById('staff_calendar_id').value = staff['カレンダーID'];
      document.getElementById('staff_qualified').checked = staff['喀痰吸引資格者'];
      document.getElementById('staff_care_required').checked = staff['勤務配慮'];
      document.getElementById('staff_active').checked = staff['有効'];
    }

    // 職員フォームを閉じる
    function closeStaffForm() {
      document.getElementById('staffFormModal').classList.add('hidden');
    }

    // 職員データ保存
    function saveStaffData(event) {
      event.preventDefault();
      showLoading();

      const staffData = {
        '職員ID': document.getElementById('staff_id').value,
        '氏名': document.getElementById('staff_name').value,
        '役職': document.getElementById('staff_role').value,
        'グループ': document.getElementById('staff_group').value,
        '雇用形態': document.getElementById('staff_employment').value,
        'ログインID': document.getElementById('staff_login_id').value,
        'パスワード': document.getElementById('staff_password').value,
        'カレンダーID': document.getElementById('staff_calendar_id').value,
        '喀痰吸引資格者': document.getElementById('staff_qualified').checked,
        '勤務配慮': document.getElementById('staff_care_required').checked,
        '有効': document.getElementById('staff_active').checked
      };

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          closeStaffForm();
          if (result.success) {
            loadStaffList();
          } else {
            alert('エラー: ' + result.message);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          alert('エラーが発生しました');
          console.error(error);
        })
        .apiSaveStaff(staffData);
    }

    // シフトマスタ一覧読み込み
    function loadShiftMasterList() {
      showLoading();

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result && result.success) {
            renderShiftMasterTable(result.data);
          } else {
            alert('シフトマスタの読み込みに失敗しました: ' + (result ? result.message : '不明なエラー'));
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          alert('エラーが発生しました: ' + error.message);
          console.error(error);
        })
        .apiGetAllShiftMaster();
    }

    // シフトマスタテーブル描画
    function renderShiftMasterTable(shiftList) {
      const tbody = document.getElementById('shiftMasterTableBody');
      tbody.innerHTML = '';

      shiftList.forEach(shift => {
        const row = `<tr>
          <td class="px-4 py-3">${shift['シフト名']}</td>
          <td class="px-4 py-3">${shift['開始時間']}</td>
          <td class="px-4 py-3">${shift['終了時間']}</td>
          <td class="px-4 py-3">${shift['備考']}</td>
          <td class="px-4 py-3">
            <button onclick='editShiftMaster(${JSON.stringify(shift).replace(/'/g, "&#39;")})' class="text-blue-600 hover:underline mr-3">
              編集
            </button>
            <button onclick='deleteShiftMaster("${shift['シフトID']}", "${shift['シフト名']}")' class="text-red-600 hover:underline">
              削除
            </button>
          </td>
        </tr>`;
        tbody.innerHTML += row;
      });
    }

    // シフトマスタ編集フォーム表示（新規）
    function showShiftMasterForm() {
      document.getElementById('shiftMasterFormModal').classList.remove('hidden');
      // フォームをクリア
      document.getElementById('shift_id').value = 'SHIFT_' + Date.now();
      document.getElementById('shift_name').value = '';
      document.getElementById('shift_start_time').value = '';
      document.getElementById('shift_end_time').value = '';
      document.getElementById('shift_notes').value = '';
    }

    // シフトマスタ編集フォーム表示（既存）
    function editShiftMaster(shift) {
      document.getElementById('shiftMasterFormModal').classList.remove('hidden');
      document.getElementById('shift_id').value = shift['シフトID'];
      document.getElementById('shift_name').value = shift['シフト名'];
      document.getElementById('shift_start_time').value = shift['開始時間'];
      document.getElementById('shift_end_time').value = shift['終了時間'];
      document.getElementById('shift_notes').value = shift['備考'];
    }

    // シフトマスタフォームを閉じる
    function closeShiftMasterForm() {
      document.getElementById('shiftMasterFormModal').classList.add('hidden');
    }

    // シフトマスタデータ保存
    function saveShiftMasterData(event) {
      event.preventDefault();
      showLoading();

      const shiftData = {
        'シフトID': document.getElementById('shift_id').value,
        'シフト名': document.getElementById('shift_name').value,
        '開始時間': document.getElementById('shift_start_time').value,
        '終了時間': document.getElementById('shift_end_time').value,
        '備考': document.getElementById('shift_notes').value
      };

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          closeShiftMasterForm();
          if (result.success) {
            loadShiftMasterList();
          } else {
            alert('エラー: ' + result.message);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          alert('エラーが発生しました');
          console.error(error);
        })
        .apiSaveShiftMaster(shiftData);
    }

    // シフトマスタ削除
    function deleteShiftMaster(shiftId, shiftName) {
      if (!confirm(`シフト「${shiftName}」を削除してもよろしいですか？`)) {
        return;
      }

      showLoading();

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            loadShiftMasterList();
          } else {
            alert('エラー: ' + result.message);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          alert('エラーが発生しました');
          console.error(error);
        })
        .apiDeleteShiftMaster(shiftId);
    }

    // ============================================
    // シフト管理画面用関数
    // ============================================

    // シフト管理画面の初期化
    function initShiftManagementView() {
      const now = new Date();
      const targetMonth = document.getElementById('shiftMgmtTargetMonth');
      targetMonth.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      loadShiftManagementStatus();
      loadColabUrl();
    }

    function loadColabUrl() {
      google.script.run
        .withSuccessHandler(function(result) {
          var btn = document.getElementById('colabLinkButton');
          var msg = document.getElementById('colabLinkNotSet');
          if (result.success && result.url) {
            btn.href = result.url;
            btn.classList.remove('hidden');
            if (msg) msg.classList.add('hidden');
          } else {
            btn.classList.add('hidden');
            if (msg) msg.classList.remove('hidden');
          }
        })
        .withFailureHandler(function(e) {
          console.error('Colab URL取得エラー:', e);
          var msg = document.getElementById('colabLinkNotSet');
          if (msg) msg.classList.remove('hidden');
        })
        .apiGetColabUrl();
    }

    // シフト管理画面の状態を読み込み
    function loadShiftManagementStatus() {
      const targetMonth = document.getElementById('shiftMgmtTargetMonth').value;
      if (!targetMonth) return;

      const [year, month] = targetMonth.split('-').map(Number);
      const holidaysKey = `MONTHLY_HOLIDAYS_${year}${String(month).padStart(2, '0')}`;
      const lockKey = `SUBMISSION_LOCK_${year}${String(month).padStart(2, '0')}`;

      // 公休日数を取得
      google.script.run
        .withSuccessHandler(function(result) {
          const holidays = result.value ? parseInt(result.value) : 9;
          document.getElementById('monthlyHolidaysInput').value = holidays;
        })
        .apiGetConfig(holidaysKey);

      // 締切状態を取得
      google.script.run
        .withSuccessHandler(function(result) {
          const isLocked = result.value === 'TRUE' || result.value === true;
          updateLockStatusDisplay(isLocked);
        })
        .apiGetConfig(lockKey);
    }

    // 締切状態の表示を更新
    function updateLockStatusDisplay(isLocked) {
      const statusDiv = document.getElementById('submissionLockStatus');
      const lockBtn = document.getElementById('lockButton');
      const unlockBtn = document.getElementById('unlockButton');

      if (isLocked) {
        statusDiv.innerHTML = '<span class="text-red-600 font-semibold">現在: 締切済み（提出不可）</span>';
        lockBtn.classList.add('opacity-50');
        unlockBtn.classList.remove('opacity-50');
      } else {
        statusDiv.innerHTML = '<span class="text-green-600 font-semibold">現在: 受付中（提出可能）</span>';
        lockBtn.classList.remove('opacity-50');
        unlockBtn.classList.add('opacity-50');
      }
    }

    // 公休日数を保存
    function saveMonthlyHolidays() {
      const targetMonth = document.getElementById('shiftMgmtTargetMonth').value;
      if (!targetMonth) {
        alert('対象月を選択してください');
        return;
      }

      const [year, month] = targetMonth.split('-').map(Number);
      const holidays = document.getElementById('monthlyHolidaysInput').value;

      if (!holidays || holidays < 1 || holidays > 31) {
        alert('公休日数は1〜31の範囲で入力してください');
        return;
      }

      const configKey = `MONTHLY_HOLIDAYS_${year}${String(month).padStart(2, '0')}`;

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            alert(`${year}年${month}月の公休日数を${holidays}日に設定しました`);
          } else {
            alert('エラー: ' + result.message);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          alert('エラーが発生しました');
          console.error(error);
        })
        .apiSetConfig(configKey, holidays);
    }

    // 提出締切の切り替え
    function toggleSubmissionLock(lock) {
      const targetMonth = document.getElementById('shiftMgmtTargetMonth').value;
      if (!targetMonth) {
        alert('対象月を選択してください');
        return;
      }

      const [year, month] = targetMonth.split('-').map(Number);
      const action = lock ? '締切（ロック）' : '受付再開（解除）';

      if (!confirm(`${year}年${month}月の休み希望提出を${action}しますか？`)) {
        return;
      }

      const configKey = `SUBMISSION_LOCK_${year}${String(month).padStart(2, '0')}`;
      const value = lock ? 'TRUE' : 'FALSE';

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            updateLockStatusDisplay(lock);
            alert(`${year}年${month}月の提出を${action}しました`);
          } else {
            alert('エラー: ' + result.message);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          alert('エラーが発生しました');
          console.error(error);
        })
        .apiSetConfig(configKey, value);
    }

    // シフト作成用3種CSV一括出力
    function exportAllCSVForShiftCreation() {
      const targetMonth = document.getElementById('shiftMgmtTargetMonth').value;
      if (!targetMonth) {
        alert('対象月を選択してください');
        return;
      }

      const [year, month] = targetMonth.split('-').map(Number);

      if (!confirm(`${year}年${month}月のシフト作成用CSVを一括出力しますか？\n\n出力ファイル:\n・T_休み希望_${year}${String(month).padStart(2, '0')}.csv\n・M_職員_${year}${String(month).padStart(2, '0')}.csv\n・M_設定_${year}${String(month).padStart(2, '0')}.csv`)) {
        return;
      }

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          const resultDiv = document.getElementById('csvExportResult');

          if (result.success) {
            let fileList = result.files.map(f => `・${f}`).join('<br>');
            resultDiv.innerHTML = `<span class="text-green-600">✅ ${result.message}</span><br>
              <span class="text-gray-600">出力ファイル:<br>${fileList}</span>`;
          } else {
            resultDiv.innerHTML = `<span class="text-red-600">❌ ${result.message}</span>`;
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          document.getElementById('csvExportResult').innerHTML =
            `<span class="text-red-600">❌ エラーが発生しました</span>`;
          console.error(error);
        })
        .apiExportAllCSVForShiftCreation(year, month);
    }

    // シフト結果CSV取込（対象月で自動検索）
    function importShiftCSVByMonth() {
      const targetMonth = document.getElementById('shiftMgmtTargetMonth').value;
      if (!targetMonth) {
        alert('対象月を選択してください');
        return;
      }

      const [year, month] = targetMonth.split('-').map(Number);
      const ym = `${year}${String(month).padStart(2, '0')}`;

      if (!confirm(`${year}年${month}月のシフト結果を取り込みますか？\n\n対象ファイル: シフト結果_${ym}.csv\n（既存の確定シフトは上書きされます）`)) {
        return;
      }

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          const resultDiv = document.getElementById('csvImportResult');

          if (result.success) {
            resultDiv.innerHTML = `<span class="text-green-600">✅ ${result.message}</span>`;
          } else {
            resultDiv.innerHTML = `<span class="text-red-600">❌ ${result.message}</span>`;
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          document.getElementById('csvImportResult').innerHTML =
            `<span class="text-red-600">❌ エラーが発生しました</span>`;
          console.error(error);
        })
        .apiImportShiftResultByMonth(year, month);
    }

    // カレンダー登録
    function registerShiftToCalendar() {
      const targetMonth = document.getElementById('shiftMgmtTargetMonth').value;
      if (!targetMonth) {
        alert('対象月を選択してください');
        return;
      }

      const [year, month] = targetMonth.split('-').map(Number);

      if (!confirm(`${year}年${month}月のシフトをGoogleカレンダーに登録しますか？\n\n注意: 既存のカレンダー予定は上書きされる場合があります。`)) {
        return;
      }

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          const resultDiv = document.getElementById('calendarRegisterResult');

          if (result.success) {
            resultDiv.innerHTML = `<span class="text-green-600">✅ ${result.message}</span>`;
          } else {
            resultDiv.innerHTML = `<span class="text-red-600">❌ ${result.message}</span>`;
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          document.getElementById('calendarRegisterResult').innerHTML =
            `<span class="text-red-600">❌ エラーが発生しました</span>`;
          console.error(error);
        })
        .apiRegisterShiftToCalendar(year, month);
    }

    // ============================================
    // シフト修正画面用関数
    // ============================================

    // グローバル変数（シフト修正用）
    let shiftEditData = null;
    let shiftMasterList = [];

    // シフト修正画面の初期化
    function initShiftEditView() {
      const now = new Date();
      const targetMonth = document.getElementById('shiftEditTargetMonth');
      targetMonth.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

      // フィルター選択肢を取得
      loadShiftEditFilterOptions();

      // シフトマスタを取得
      loadShiftMasterForEdit();
    }

    // チェックボックスグループを生成するヘルパー
    function buildCheckboxGroup(containerId, items, labelFn) {
      var container = document.getElementById(containerId);
      container.innerHTML = '';
      items.forEach(function(val) {
        var label = document.createElement('label');
        label.className = 'flex items-center gap-0.5 text-xs cursor-pointer whitespace-nowrap';
        var cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = val;
        cb.className = 'filter-cb-' + containerId;
        cb.addEventListener('change', applyFiltersAndRender);
        label.appendChild(cb);
        label.appendChild(document.createTextNode(labelFn ? labelFn(val) : val));
        container.appendChild(label);
      });
    }

    // フィルター選択肢を取得
    function loadShiftEditFilterOptions() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            buildCheckboxGroup('shiftEditGroup', result.groups, function(g) { return 'G' + g; });
            buildCheckboxGroup('shiftEditUnit', result.units);
            buildCheckboxGroup('shiftEditEmployment', result.employmentTypes);
          }
        })
        .withFailureHandler(function(error) {
          console.error('フィルター選択肢取得エラー:', error);
        })
        .apiGetShiftFilterOptions();
    }

    // フィルターをリセット
    function clearShiftEditFilters() {
      document.querySelectorAll('#shiftEditGroup input, #shiftEditUnit input, #shiftEditEmployment input').forEach(function(cb) {
        cb.checked = false;
      });
      document.getElementById('shiftEditSuctionOnly').checked = false;
      document.getElementById('shiftEditCareOnly').checked = false;
      applyFiltersAndRender();
    }

    // チェックされた値を取得するヘルパー
    function getCheckedValues(containerId) {
      var values = [];
      document.querySelectorAll('#' + containerId + ' input:checked').forEach(function(cb) {
        values.push(cb.value);
      });
      return values;
    }

    // 現在のフィルター条件を取得
    function getShiftEditFilters() {
      var filters = {};

      var groups = getCheckedValues('shiftEditGroup');
      var totalGroups = document.querySelectorAll('#shiftEditGroup input').length;
      if (groups.length > 0 && groups.length < totalGroups) {
        filters.groups = groups;
      }

      var units = getCheckedValues('shiftEditUnit');
      var totalUnits = document.querySelectorAll('#shiftEditUnit input').length;
      if (units.length > 0 && units.length < totalUnits) {
        filters.units = units;
      }

      var emp = getCheckedValues('shiftEditEmployment');
      var totalEmp = document.querySelectorAll('#shiftEditEmployment input').length;
      if (emp.length > 0 && emp.length < totalEmp) {
        filters.employmentTypes = emp;
      }

      if (document.getElementById('shiftEditSuctionOnly').checked) {
        filters.suctionOnly = true;
      }
      if (document.getElementById('shiftEditCareOnly').checked) {
        filters.careOnly = true;
      }

      return filters;
    }

    // シフトマスタを取得
    function loadShiftMasterForEdit() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            shiftMasterList = result.shifts;
          }
        })
        .withFailureHandler(function(error) {
          console.error('シフトマスタ取得エラー:', error);
        })
        .apiGetShiftMaster();
    }

    // シフトデータを読み込み（全職員データをサーバーから取得）
    function loadShiftEditData() {
      var targetMonth = document.getElementById('shiftEditTargetMonth').value;

      if (!targetMonth) {
        alert('対象月を選択してください');
        return;
      }

      // シフトマスタが読み込まれていない場合は待機
      if (shiftMasterList.length === 0) {
        alert('シフトマスタを読み込み中です。少し待ってから再度お試しください。');
        loadShiftMasterForEdit();
        return;
      }

      var parts = targetMonth.split('-');
      var year = Number(parts[0]);
      var month = Number(parts[1]);

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result && result.success) {
            shiftEditData = result;
            applyFiltersAndRender();
            document.getElementById('shiftEditTableContainer').classList.remove('hidden');
            document.getElementById('btnConfirmArea').classList.remove('hidden');
            document.getElementById('diagnosticsPanel').classList.remove('hidden');
            document.getElementById('diagnosticsResult').classList.add('hidden');
            document.getElementById('diagnosticsEmpty').classList.remove('hidden');
          } else if (result) {
            alert('エラー: ' + result.message);
          } else {
            alert('データの取得に失敗しました。再度お試しください。');
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          alert('エラーが発生しました: ' + (error.message || error));
        })
        .apiGetShiftDataFiltered(year, month, {});
    }

    // クライアントサイドでフィルタリングしたデータを返す
    function getFilteredShiftData() {
      if (!shiftEditData) return null;

      var filters = getShiftEditFilters();
      var filtered = shiftEditData.staffShifts;

      // グループフィルター
      if (filters.groups && filters.groups.length > 0) {
        filtered = filtered.filter(function(s) {
          return filters.groups.indexOf(String(s.group)) !== -1;
        });
      }

      // ユニットフィルター
      if (filters.units && filters.units.length > 0) {
        filtered = filtered.filter(function(s) {
          return filters.units.indexOf(s.unit) !== -1;
        });
      }

      // 雇用形態フィルター
      if (filters.employmentTypes && filters.employmentTypes.length > 0) {
        filtered = filtered.filter(function(s) {
          return filters.employmentTypes.indexOf(s.employmentType) !== -1;
        });
      }

      // 喀痰吸引資格者のみ
      if (filters.suctionOnly) {
        filtered = filtered.filter(function(s) { return s.hasSuction; });
      }

      // 勤務配慮ありのみ
      if (filters.careOnly) {
        filtered = filtered.filter(function(s) { return s.hasCare; });
      }

      // shiftEditDataのコピーにフィルター済みstaffShiftsを差し替え
      return {
        year: shiftEditData.year,
        month: shiftEditData.month,
        dateInfo: shiftEditData.dateInfo,
        staffShifts: filtered,
        statistics: null // 再計算が必要
      };
    }

    // フィルター変更時にクライアントサイドで即座に再描画
    function applyFiltersAndRender() {
      if (!shiftEditData) return;

      var viewData = getFilteredShiftData();
      // フィルター済みデータで統計を再計算
      recalculateStatisticsFor(viewData);
      renderShiftEditTable(viewData);
      renderShiftDailyStatsTable(viewData);
      renderShiftStatsTable(viewData);
    }

    // シフト編集テーブルを描画
    function renderShiftEditTable(data) {
      var table = document.getElementById('shiftEditTable');
      var thead = table.querySelector('thead');
      var tbody = table.querySelector('tbody');

      // ヘッダー生成
      var dayNames = ['日', '月', '火', '水', '木', '金', '土'];
      var headerHtml = '<tr><th class="px-2 py-2 text-left sticky left-0 bg-gray-50 border-b border-r" style="min-width:140px;">氏名</th>';
      data.dateInfo.forEach(function(d) {
        var bgClass = '';
        if (d.isSunday || d.isHoliday) bgClass = 'bg-pink-100';
        else if (d.isSaturday) bgClass = 'bg-blue-100';
        headerHtml += '<th class="px-1 py-2 text-center border-b ' + bgClass + '" style="min-width: 70px;">' +
          '<div class="text-xs">' + d.day + '</div>' +
          '<div class="text-xs text-gray-500">' + dayNames[d.dayOfWeek] + '</div></th>';
      });
      headerHtml += '</tr>';
      thead.innerHTML = headerHtml;

      // SHIFT_YASUMIの表示名を事前取得
      var yasumiEntry = shiftMasterList.find(function(sm) { return sm['シフトID'] === 'SHIFT_YASUMI'; });
      var yasumiDisplayName = yasumiEntry ? yasumiEntry['シフト名'] : '休み';

      // ボディ生成
      var bodyHtml = '';
      data.staffShifts.forEach(function(staff) {
        // 資格者行は薄い黄色背景
        var rowBg = staff.hasSuction ? 'background-color:#FFFDE7;' : '';
        var stickyBg = staff.hasSuction ? 'background-color:#FFFDE7;' : 'background-color:white;';

        // 氏名セル：グループ・属性バッジ付き
        var badges = '';
        badges += '<span class="inline-block text-xs px-1 rounded bg-gray-200 text-gray-700 mr-0.5">G' + (staff.group || '') + '</span>';
        if (staff.hasSuction) {
          badges += '<span class="inline-block text-xs px-1 rounded bg-yellow-300 text-yellow-900 mr-0.5">資格</span>';
        }
        if (staff.hasCare) {
          badges += '<span class="inline-block text-xs px-1 rounded bg-green-200 text-green-800 mr-0.5">配慮</span>';
        }

        bodyHtml += '<tr style="' + rowBg + '">';
        bodyHtml += '<td class="px-2 py-1 whitespace-nowrap sticky left-0 border-r font-medium" style="' + stickyBg + '">';
        bodyHtml += '<div class="text-sm">' + staff.name + '</div>';
        bodyHtml += '<div class="leading-tight">' + badges + '</div>';
        bodyHtml += '</td>';

        data.dateInfo.forEach(function(d) {
          var shift = staff.shifts[d.day];
          var cellBg = '';
          if (d.isSunday || d.isHoliday) cellBg = 'bg-pink-50';
          else if (d.isSaturday) cellBg = 'bg-blue-50';

          // シフト選択プルダウン生成
          var options = '<option value="' + yasumiDisplayName + '">' + yasumiDisplayName + '</option>';
          shiftMasterList.forEach(function(sm) {
            if (sm['シフトID'] !== 'SHIFT_YASUMI') {
              var selected = shift.shiftName === sm['シフト名'] ? ' selected' : '';
              options += '<option value="' + sm['シフト名'] + '"' + selected + '>' + sm['シフト名'] + '</option>';
            }
          });
          // 休みが選択されている場合
          if (shift.shiftName === yasumiDisplayName || !shift.shiftName) {
            options = options.replace('value="' + yasumiDisplayName + '"', 'value="' + yasumiDisplayName + '" selected');
          }

          var escapedId = String(staff.staffId).replace(/'/g, "\\'");
          bodyHtml += '<td class="px-1 py-1 ' + cellBg + '">' +
            '<select onchange="updateShiftCell(\'' + escapedId + '\', ' + data.year + ', ' + data.month + ', ' + d.day + ', this.value)" ' +
            'class="w-full px-1 py-1 text-xs border border-gray-300 rounded">' +
            options + '</select></td>';
        });
        bodyHtml += '</tr>';
      });
      tbody.innerHTML = bodyHtml;
    }

    // シフトセルを更新（クライアントサイドで即座に反映）
    function updateShiftCell(staffId, year, month, day, shiftName) {
      if (!shiftEditData) return;

      // ローカルデータを即座に更新（staffIdで検索）
      var staffEntry = shiftEditData.staffShifts.find(function(s) { return String(s.staffId) === String(staffId); });
      if (staffEntry && staffEntry.shifts[day]) {
        staffEntry.shifts[day].shiftName = shiftName;
        // 時間情報も更新
        var smEntry = shiftMasterList.find(function(sm) { return sm['シフト名'] === shiftName; });
        if (smEntry) {
          staffEntry.shifts[day].startTime = smEntry['開始時間'] || '';
          staffEntry.shifts[day].endTime = smEntry['終了時間'] || '';
        } else {
          staffEntry.shifts[day].startTime = '';
          staffEntry.shifts[day].endTime = '';
        }
      }

      // フィルター済みビューで統計を再計算して再描画
      var viewData = getFilteredShiftData();
      recalculateStatisticsFor(viewData);
      renderShiftDailyStatsTable(viewData);
      renderShiftStatsTable(viewData);

      // バックグラウンドでサーバーに保存（ローディング表示なし）
      // apiUpdateShift は氏名ベースなので氏名を渡す
      var staffName = staffEntry ? staffEntry.name : '';
      google.script.run
        .withSuccessHandler(function(result) {
          if (!result.success) {
            console.error('シフト保存エラー:', result.message);
            loadShiftEditData();
          }
        })
        .withFailureHandler(function(error) {
          console.error('シフト保存エラー:', error);
          loadShiftEditData();
        })
        .apiUpdateShift(staffName, year, month, day, shiftName);
    }

    // 指定データの統計を計算してdata.statisticsにセット
    function recalculateStatisticsFor(data) {
      if (!data || !data.staffShifts) return;

      var daysInMonth = data.dateInfo.length;

      var yasumiName = '';
      var yakinName = '';
      shiftMasterList.forEach(function(sm) {
        if (sm['シフトID'] === 'SHIFT_YASUMI') yasumiName = sm['シフト名'];
        if (sm['シフトID'] === 'SHIFT_YAKIN') yakinName = sm['シフト名'];
      });
      if (!yasumiName) yasumiName = '休み';
      if (!yakinName) yakinName = '夜勤';

      data.statistics = data.staffShifts.map(function(staff) {
        var workDays = 0;
        var trueHolidays = 0;
        var shiftCounts = {};
        var prevShiftName = staff.prevMonthLastShift || '';

        for (var d = 1; d <= daysInMonth; d++) {
          var shift = staff.shifts[d];
          var sn = (shift && shift.shiftName) ? shift.shiftName : yasumiName;

          if (!shiftCounts[sn]) shiftCounts[sn] = 0;
          shiftCounts[sn]++;

          if (sn === yasumiName) {
            if (prevShiftName !== yakinName) {
              trueHolidays++;
            }
          } else {
            workDays++;
            if (sn === yakinName) workDays++;
          }
          prevShiftName = sn;
        }

        return {
          name: staff.name,
          workDays: workDays,
          restDays: trueHolidays,
          shiftCounts: shiftCounts
        };
      });
    }

    // 旧互換: updateShiftCellから呼ばれる
    function recalculateStatistics() {
      recalculateStatisticsFor(shiftEditData);
    }

    // 統計テーブルを描画
    // 集計（日別）テーブル描画
    function renderShiftDailyStatsTable(data) {
      var table = document.getElementById('shiftDailyStatsTable');
      var thead = table.querySelector('thead');
      var tbody = table.querySelector('tbody');

      // シフト種類一覧（マスタ順）
      var shiftNames = shiftMasterList.map(function(sm) { return sm['シフト名']; });
      var yasumiDefault = (shiftMasterList.find(function(sm) { return sm['シフトID'] === 'SHIFT_YASUMI'; }) || {})['シフト名'] || '休み';

      var dayNames = ['日','月','火','水','木','金','土'];

      // ヘッダー: 空白 + 各日付
      var headerHtml = '<tr><th class="px-2 py-2 text-left sticky left-0 bg-gray-50 border-b border-r min-w-[60px]"></th>';
      data.dateInfo.forEach(function(d) {
        var bgClass = '';
        if (d.isSunday || d.isHoliday) bgClass = 'bg-pink-100';
        else if (d.isSaturday) bgClass = 'bg-blue-100';
        headerHtml += '<th class="px-1 py-2 text-center border-b min-w-[36px] ' + bgClass + '">' +
          '<div class="text-xs">' + d.day + '</div>' +
          '<div class="text-xs text-gray-500">' + dayNames[d.dayOfWeek] + '</div></th>';
      });
      headerHtml += '</tr>';
      thead.innerHTML = headerHtml;

      // 日別集計を計算
      var dailyCounts = {};
      shiftNames.forEach(function(sn) { dailyCounts[sn] = {}; });

      data.staffShifts.forEach(function(staff) {
        data.dateInfo.forEach(function(d) {
          var shift = staff.shifts[d.day];
          var name = shift ? (shift.shiftName || yasumiDefault) : yasumiDefault;
          if (!dailyCounts[name]) {
            dailyCounts[name] = {};
            shiftNames.push(name);
          }
          dailyCounts[name][d.day] = (dailyCounts[name][d.day] || 0) + 1;
        });
      });

      // ボディ: シフト種類 × 日付
      var bodyHtml = '';
      shiftNames.forEach(function(sn) {
        bodyHtml += '<tr>';
        bodyHtml += '<td class="px-2 py-1 border-b border-r font-medium sticky left-0 bg-white text-sm">' + sn + '</td>';
        data.dateInfo.forEach(function(d) {
          var count = (dailyCounts[sn] && dailyCounts[sn][d.day]) || 0;
          var bgClass = '';
          if (d.isSunday || d.isHoliday) bgClass = 'bg-pink-50';
          else if (d.isSaturday) bgClass = 'bg-blue-50';
          bodyHtml += '<td class="px-1 py-1 border-b text-center text-sm ' + bgClass + '">' + (count || '') + '</td>';
        });
        bodyHtml += '</tr>';
      });
      tbody.innerHTML = bodyHtml;
    }

    function renderShiftStatsTable(data) {
      const table = document.getElementById('shiftStatsTable');
      const thead = table.querySelector('thead');
      const tbody = table.querySelector('tbody');

      // 全シフト種類を取得
      const allShiftNames = new Set();
      data.statistics.forEach(stat => {
        Object.keys(stat.shiftCounts).forEach(name => allShiftNames.add(name));
      });
      const shiftNames = Array.from(allShiftNames).sort();

      // ヘッダー生成
      let headerHtml = '<tr>';
      headerHtml += '<th class="px-3 py-2 text-left border-b">氏名</th>';
      headerHtml += '<th class="px-3 py-2 text-center border-b">勤務日数</th>';
      headerHtml += '<th class="px-3 py-2 text-center border-b">公休数</th>';
      shiftNames.forEach(name => {
        headerHtml += `<th class="px-3 py-2 text-center border-b">${name}</th>`;
      });
      headerHtml += '</tr>';
      thead.innerHTML = headerHtml;

      // ボディ生成
      let bodyHtml = '';
      data.statistics.forEach(stat => {
        bodyHtml += '<tr>';
        bodyHtml += `<td class="px-3 py-2 border-b font-medium">${stat.name}</td>`;
        bodyHtml += `<td class="px-3 py-2 border-b text-center">${stat.workDays}</td>`;
        bodyHtml += `<td class="px-3 py-2 border-b text-center">${stat.restDays}</td>`;
        shiftNames.forEach(name => {
          const count = stat.shiftCounts[name] || 0;
          bodyHtml += `<td class="px-3 py-2 border-b text-center">${count}</td>`;
        });
        bodyHtml += '</tr>';
      });
      tbody.innerHTML = bodyHtml;
    }

    // 表示中の職員IDリストを取得
    function getDisplayedStaffIds() {
      if (!shiftEditData || !shiftEditData.staffShifts) return [];
      return shiftEditData.staffShifts.map(function(s) { return s.staffId; });
    }

    // 確定のみ（カレンダー登録なし）
    function confirmShiftsOnly() {
      if (!shiftEditData) {
        alert('先にシフトデータを表示してください');
        return;
      }

      var year = shiftEditData.year;
      var month = shiftEditData.month;
      var staffIds = getDisplayedStaffIds();
      var staffCount = staffIds.length;

      if (!confirm('表示中の' + staffCount + '名の' + year + '年' + month + '月シフトを確定しますか？\n\n確定すると登録日時が記録されます。')) {
        return;
      }

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            alert(result.message);
            loadShiftEditData();
          } else {
            alert('エラー: ' + result.message);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          alert('エラーが発生しました: ' + (error.message || error));
        })
        .apiConfirmShifts(year, month, staffIds);
    }

    // 確定してカレンダー登録
    function confirmAndRegisterCalendar() {
      if (!shiftEditData) {
        alert('先にシフトデータを表示してください');
        return;
      }

      var year = shiftEditData.year;
      var month = shiftEditData.month;
      var staffIds = getDisplayedStaffIds();
      var staffCount = staffIds.length;

      if (!confirm('表示中の' + staffCount + '名の' + year + '年' + month + '月シフトを確定してカレンダーに登録しますか？\n\n確定すると:\n・登録日時が記録されます\n・Googleカレンダーに予定が登録されます')) {
        return;
      }

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            alert(result.message);
            loadShiftEditData();
          } else {
            alert('エラー: ' + result.message);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          alert('エラーが発生しました');
          console.error(error);
        })
        .apiConfirmShiftsAndRegisterCalendar(year, month, staffIds);
    }

    var diagnosticsData = null;

    function runDiagnostics() {
      var targetMonth = document.getElementById('shiftEditTargetMonth').value;
      if (!targetMonth) { alert('対象月を選択してください'); return; }
      var parts = targetMonth.split('-').map(Number);
      var year = parts[0], month = parts[1];

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (!result.success) { alert('エラー: ' + result.message); return; }

          diagnosticsData = result;

          document.getElementById('diagnosticsEmpty').classList.add('hidden');
          document.getElementById('diagnosticsResult').classList.remove('hidden');

          var summaryEl = document.getElementById('diagnosticsSummary');
          summaryEl.textContent = '';

          if (!result.hasData) {
            summaryEl.textContent = '確定シフトデータがありません';
            document.getElementById('diagnosticsList').textContent = '';
            document.getElementById('diagnosticsFilters').classList.add('hidden');
            return;
          }

          // サマリーバッジをDOM操作で構築
          var errSpan = document.createElement('span');
          errSpan.className = 'px-3 py-1 rounded-full font-semibold ' +
            (result.summary.error > 0 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800');
          errSpan.textContent = 'エラー: ' + result.summary.error + '件';
          summaryEl.appendChild(errSpan);

          var warnSpan = document.createElement('span');
          warnSpan.className = 'px-3 py-1 rounded-full font-semibold ' +
            (result.summary.warning > 0 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800');
          warnSpan.textContent = '警告: ' + result.summary.warning + '件';
          summaryEl.appendChild(warnSpan);

          // フィルタードロップダウンを構築
          var groupFilter = document.getElementById('diagnosticsGroupFilter');
          groupFilter.textContent = '';
          var allGroupOpt = document.createElement('option');
          allGroupOpt.value = '';
          allGroupOpt.textContent = '全グループ';
          groupFilter.appendChild(allGroupOpt);
          if (result.groupList) {
            result.groupList.forEach(function(g) {
              var opt = document.createElement('option');
              opt.value = g;
              opt.textContent = 'グループ' + g;
              groupFilter.appendChild(opt);
            });
          }

          var staffFilter = document.getElementById('diagnosticsStaffFilter');
          staffFilter.textContent = '';
          var allStaffOpt = document.createElement('option');
          allStaffOpt.value = '';
          allStaffOpt.textContent = '全職員';
          staffFilter.appendChild(allStaffOpt);
          if (result.staffList) {
            result.staffList.forEach(function(s) {
              var opt = document.createElement('option');
              opt.value = s.name;
              opt.textContent = s.name + '(G' + s.group + ')';
              staffFilter.appendChild(opt);
            });
          }

          document.getElementById('diagnosticsFilters').classList.remove('hidden');

          // 全件表示
          var allItems = result.violations.concat(result.warnings);
          renderDiagnosticsList(allItems);
        })
        .withFailureHandler(function(error) {
          hideLoading();
          alert('診断の実行に失敗しました');
          console.error(error);
        })
        .apiRunDiagnostics(year, month);
    }

    function applyDiagnosticsFilter() {
      if (!diagnosticsData) return;

      var groupVal = document.getElementById('diagnosticsGroupFilter').value;
      var staffVal = document.getElementById('diagnosticsStaffFilter').value;

      var allItems = diagnosticsData.violations.concat(diagnosticsData.warnings);
      var filtered = allItems.filter(function(item) {
        if (groupVal && String(item.group) !== String(groupVal)) return false;
        if (staffVal && item.staffName !== staffVal) return false;
        return true;
      });

      renderDiagnosticsList(filtered);
    }

    function renderDiagnosticsList(items) {
      var listEl = document.getElementById('diagnosticsList');
      listEl.textContent = '';

      if (items.length === 0) {
        listEl.textContent = '該当するルール違反は見つかりませんでした';
        return;
      }

      // タイプ別グループ化してDOM構築
      var grouped = {};
      items.forEach(function(v) {
        if (!grouped[v.type]) grouped[v.type] = [];
        grouped[v.type].push(v);
      });

      Object.keys(grouped).forEach(function(type) {
        var typeItems = grouped[type];
        var isError = typeItems[0].level === 'error';

        var wrapper = document.createElement('div');
        wrapper.className = 'mb-4 border rounded-lg overflow-hidden ' +
          (isError ? 'border-red-200' : 'border-yellow-200');

        var header = document.createElement('div');
        header.className = 'px-4 py-2 font-semibold ' +
          (isError ? 'bg-red-50 text-red-800' : 'bg-yellow-50 text-yellow-800');
        header.textContent = (isError ? 'エラー: ' : '警告: ') + type + ' (' + typeItems.length + '件)';
        wrapper.appendChild(header);

        var ul = document.createElement('ul');
        ul.className = 'divide-y divide-gray-100';
        typeItems.forEach(function(item) {
          var li = document.createElement('li');
          li.className = 'px-4 py-2 text-sm text-gray-700';
          li.textContent = item.message;
          ul.appendChild(li);
        });
        wrapper.appendChild(ul);
        listEl.appendChild(wrapper);
      });
    }

    var assignmentStaffList = [];

    function initShiftAssignmentView() {
      var now = new Date();
      document.getElementById('shiftAssignTargetMonth').value =
        now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');

      if (assignmentStaffList.length === 0) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (!result.success) return;
            assignmentStaffList = result.data.filter(function(s) {
              return s['有効'] === true || s['有効'] === 'TRUE';
            });
            var select = document.getElementById('assignStaffName');
            assignmentStaffList.forEach(function(s) {
              var opt = document.createElement('option');
              opt.value = s['職員ID'];
              opt.dataset.name = s['氏名'];
              opt.textContent = s['氏名'] + ' (G' + s['グループ'] + ')';
              select.appendChild(opt);
            });
          })
          .withFailureHandler(function(e) { console.error(e); })
          .apiGetAllStaff();
      }

      google.script.run
        .withSuccessHandler(function(result) {
          if (!result.success) return;
          var select = document.getElementById('assignShiftName');
          while (select.firstChild) { select.removeChild(select.firstChild); }
          var defOpt = document.createElement('option');
          defOpt.value = '';
          defOpt.textContent = '-- 選択 --';
          select.appendChild(defOpt);
          result.shifts.filter(function(s) { return s['シフトID'] !== 'SHIFT_YASUMI'; }).forEach(function(s) {
            var opt = document.createElement('option');
            opt.value = s['シフトID'];      // 保存はキー
            opt.textContent = s['シフト名']; // 表示は名称
            select.appendChild(opt);
          });
        })
        .withFailureHandler(function(e) { console.error(e); })
        .apiGetShiftMaster();
    }

    function loadShiftAssignments() {
      var targetMonth = document.getElementById('shiftAssignTargetMonth').value;
      if (!targetMonth) { alert('対象月を選択してください'); return; }
      var parts = targetMonth.split('-').map(Number);
      var year = parts[0], month = parts[1];

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          var tbody = document.getElementById('assignmentTableBody');
          tbody.textContent = '';

          if (!result.success || result.assignments.length === 0) {
            var tr = document.createElement('tr');
            var td = document.createElement('td');
            td.colSpan = 6;
            td.className = 'px-4 py-4 text-center text-gray-500';
            td.textContent = !result.success
              ? ('エラー: ' + result.message)
              : (year + '年' + month + '月の勤務指定はありません');
            tr.appendChild(td);
            tbody.appendChild(tr);
            return;
          }

          var sorted = result.assignments.slice().sort(function(a, b) {
            return (a['日付'] || '').localeCompare(b['日付'] || '');
          });

          sorted.forEach(function(a) {
            var tr = document.createElement('tr');
            [a['日付'], a['氏名'], a['グループ'], a['シフト名'], a['備考'] || '-'].forEach(function(val) {
              var td = document.createElement('td');
              td.className = 'px-4 py-2';
              td.textContent = val;
              tr.appendChild(td);
            });
            var tdBtn = document.createElement('td');
            tdBtn.className = 'px-4 py-2 text-center';
            var btn = document.createElement('button');
            btn.className = 'bg-red-100 text-red-700 px-3 py-1 rounded hover:bg-red-200 text-xs';
            btn.textContent = '削除';
            btn.dataset.id = a['指定ID'];
            btn.addEventListener('click', function() { deleteAssignment(this.dataset.id); });
            tdBtn.appendChild(btn);
            tr.appendChild(tdBtn);
            tbody.appendChild(tr);
          });
        })
        .withFailureHandler(function(e) { hideLoading(); console.error(e); })
        .apiGetShiftAssignments(year, month);
    }

    function addShiftAssignment() {
      var staffSelect = document.getElementById('assignStaffName');
      var staffId = staffSelect.value;
      var staffName = staffSelect.options[staffSelect.selectedIndex]
        ? (staffSelect.options[staffSelect.selectedIndex].dataset.name || staffSelect.value)
        : staffSelect.value;
      var date = document.getElementById('assignDate').value;
      var shiftName = document.getElementById('assignShiftName').value;
      var notes = document.getElementById('assignNotes').value;
      var msgEl = document.getElementById('assignmentAddMessage');

      if (!staffId || !date || !shiftName) {
        msgEl.textContent = '職員名、日付、シフトはすべて必須です';
        msgEl.className = 'mt-2 text-sm text-red-600';
        msgEl.classList.remove('hidden');
        return;
      }

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          msgEl.classList.remove('hidden');
          msgEl.textContent = result.success ? '保存しました' : result.message;
          msgEl.className = 'mt-2 text-sm ' + (result.success ? 'text-green-600' : 'text-red-600');
          if (result.success) {
            document.getElementById('assignStaffName').value = '';
            document.getElementById('assignDate').value = '';
            document.getElementById('assignShiftName').value = '';
            document.getElementById('assignNotes').value = '';
            loadShiftAssignments();
          }
        })
        .withFailureHandler(function(e) {
          hideLoading();
          msgEl.textContent = 'エラーが発生しました';
          msgEl.className = 'mt-2 text-sm text-red-600';
          msgEl.classList.remove('hidden');
          console.error(e);
        })
        .apiSaveShiftAssignment(staffId, staffName, date, shiftName, notes);
    }

    function deleteAssignment(assignmentId) {
      if (!confirm('この勤務指定を削除しますか？')) return;
      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) { loadShiftAssignments(); }
          else { alert('削除エラー: ' + result.message); }
        })
        .withFailureHandler(function(e) { hideLoading(); console.error(e); })
        .apiDeleteShiftAssignment(assignmentId);
    }

    function toggleEventForm() {
      document.getElementById('eventAddForm').classList.toggle('hidden');
    }

    function addEvent() {
      var title = document.getElementById('eventTitle').value.trim();
      var date = document.getElementById('eventDate').value;
      var notes = document.getElementById('eventNotes').value.trim();
      var msgEl = document.getElementById('eventAddMsg');

      if (!title || !date) { msgEl.textContent = 'タイトルと日付は必須です'; return; }

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          msgEl.textContent = result.success ? '追加しました' : result.message;
          if (result.success) {
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDate').value = '';
            document.getElementById('eventNotes').value = '';
            loadHolidayRequest();
          }
        })
        .withFailureHandler(function(e) { hideLoading(); console.error(e); })
        .apiSaveEvent(title, date, notes);
    }

    function deleteEvent(eventId) {
      if (!confirm('このイベントを削除しますか？')) return;
      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) { loadHolidayRequest(); }
          else { alert('削除エラー: ' + result.message); }
        })
        .withFailureHandler(function(e) { hideLoading(); console.error(e); })
        .apiDeleteEvent(eventId);
    }

    function renderEventList(events) {
      var listEl = document.getElementById('eventList');
      if (!listEl) return;
      listEl.textContent = '';
      if (!events || events.length === 0) {
        listEl.textContent = 'この月のイベントはありません';
        return;
      }
      var sorted = events.slice().sort(function(a, b) {
        return (a['日付'] || '').localeCompare(b['日付'] || '');
      });
      sorted.forEach(function(ev) {
        var row = document.createElement('div');
        row.className = 'flex items-center justify-between py-1 border-b border-orange-100';

        var text = document.createElement('span');
        var day = ev['日付'].split('-')[2];
        text.textContent = day + '日: ' + ev['タイトル'] +
          (ev['備考'] ? ' (' + ev['備考'] + ')' : '');
        row.appendChild(text);

        if (currentSession && currentSession.isAdmin) {
          var btn = document.createElement('button');
          btn.className = 'text-red-500 hover:text-red-700 text-xs ml-2';
          btn.textContent = '削除';
          btn.dataset.id = ev['イベントID'];
          btn.addEventListener('click', function() { deleteEvent(this.dataset.id); });
          row.appendChild(btn);
        }
        listEl.appendChild(row);
      });
    }
  </script>

</body>
</html>
