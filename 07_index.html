<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚·ãƒ•ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .calendar-day {
      min-height: 40px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .calendar-day:hover {
      transform: scale(1.05);
    }

    .calendar-day.selected {
      background-color: #3b82f6;
      color: white;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
  <div id="loading" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-lg shadow-xl">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
      <p class="mt-4 text-gray-700">èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
  <div id="app" class="hidden">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-blue-600 text-white shadow-lg">
      <div class="container mx-auto px-4 py-4">
        <div class="flex justify-between items-center">
          <h1 class="text-2xl font-bold">ğŸ“… ã‚·ãƒ•ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
          <div id="userInfo" class="hidden">
            <span id="userName" class="mr-4"></span>
            <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded transition">
              ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç®¡ç†è€…ã®ã¿è¡¨ç¤ºï¼‰ -->
    <nav id="adminNav" class="bg-white shadow-md hidden">
      <div class="container mx-auto px-4">
        <ul class="flex space-x-4 py-3">
          <li>
            <button onclick="showView('holiday-request')" class="nav-btn px-4 py-2 rounded hover:bg-blue-100 transition">
              ä¼‘ã¿å¸Œæœ›æå‡º
            </button>
          </li>
          <li>
            <button onclick="showView('staff-master')" class="nav-btn px-4 py-2 rounded hover:bg-blue-100 transition">
              è·å“¡ãƒã‚¹ã‚¿ç®¡ç†
            </button>
          </li>
          <li>
            <button onclick="showView('shift-master')" class="nav-btn px-4 py-2 rounded hover:bg-blue-100 transition">
              ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ç®¡ç†
            </button>
          </li>
        </ul>
      </div>
    </nav>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="container mx-auto px-4 py-8">

      <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
      <div id="loginView" class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-8">
        <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">ãƒ­ã‚°ã‚¤ãƒ³</h2>
        <form onsubmit="handleLogin(event)" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ­ã‚°ã‚¤ãƒ³ID</label>
            <input type="text" id="loginId" required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input type="password" id="loginPassword" required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <button type="submit"
            class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-semibold">
            ãƒ­ã‚°ã‚¤ãƒ³
          </button>
        </form>
        <div id="loginError" class="mt-4 text-red-600 text-sm hidden"></div>
      </div>

      <!-- ä¼‘ã¿å¸Œæœ›æå‡ºç”»é¢ -->
      <div id="holidayRequestView" class="hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold mb-6 text-gray-800">ä¼‘ã¿å¸Œæœ›æå‡º</h2>

          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">å¯¾è±¡æœˆ</label>
            <input type="month" id="targetMonth"
              class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              onchange="loadHolidayRequest()">
          </div>

          <div id="lockMessage" class="hidden mb-4 p-4 bg-yellow-100 border border-yellow-400 rounded-lg">
            <p class="text-yellow-800">âš ï¸ ã“ã®æœˆã®æå‡ºã¯ç· ã‚åˆ‡ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚é–²è¦§ã®ã¿å¯èƒ½ã§ã™ã€‚</p>
          </div>

          <div id="calendar" class="mb-6"></div>

          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">ç‰¹è¨˜äº‹é …</label>
            <textarea id="requestNotes" rows="3"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              placeholder="ç‰¹è¨˜äº‹é …ãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
          </div>

          <div class="flex space-x-4">
            <button onclick="saveHolidayRequest()" id="saveButton"
              class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-semibold">
              ä¿å­˜
            </button>
            <button onclick="clearHolidayRequest()"
              class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition font-semibold">
              ã‚¯ãƒªã‚¢
            </button>
          </div>

          <div id="holidayMessage" class="mt-4 hidden"></div>
        </div>
      </div>

      <!-- è·å“¡ãƒã‚¹ã‚¿ç®¡ç†ç”»é¢ -->
      <div id="staffMasterView" class="hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold mb-6 text-gray-800">è·å“¡ãƒã‚¹ã‚¿ç®¡ç†</h2>

          <div class="mb-4">
            <button onclick="showStaffForm()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">
              + æ–°è¦è¿½åŠ 
            </button>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ°å</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">å½¹è·</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ã‚°ãƒ«ãƒ¼ãƒ—</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">é›‡ç”¨å½¢æ…‹</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æœ‰åŠ¹</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="staffTableBody" class="bg-white divide-y divide-gray-200">
                <!-- ã“ã“ã«è·å“¡ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- è·å“¡ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ -->
        <div id="staffFormModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full max-h-screen overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">è·å“¡æƒ…å ±ç·¨é›†</h3>
            <form onsubmit="saveStaffData(event)" class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">è·å“¡ID</label>
                  <input type="text" id="staff_id" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">æ°å</label>
                  <input type="text" id="staff_name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">å½¹è·</label>
                  <input type="text" id="staff_role" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ã‚°ãƒ«ãƒ¼ãƒ—</label>
                  <select id="staff_group" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">é›‡ç”¨å½¢æ…‹</label>
                  <select id="staff_employment" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="å¸¸å‹¤">å¸¸å‹¤</option>
                    <option value="ãƒ‘ãƒ¼ãƒˆ">ãƒ‘ãƒ¼ãƒˆ</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ãƒ­ã‚°ã‚¤ãƒ³ID</label>
                  <input type="text" id="staff_login_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                  <input type="password" id="staff_password" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID</label>
                  <input type="text" id="staff_calendar_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">å„ªå…ˆé †ä½ ğŸ’¡</label>
                  <input type="number" id="staff_priority" min="1" max="10" value="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                  <p class="text-xs text-gray-500 mt-1">æ•°å€¤ãŒå°ã•ã„ã»ã©å„ªå…ˆåº¦ãŒé«˜ã„ï¼ˆä¾‹: ç®¡ç†è€…=1ã€ä¸€èˆ¬=3ã€ãƒ‘ãƒ¼ãƒˆ=5ï¼‰</p>
                </div>
                <div class="flex items-center">
                  <input type="checkbox" id="staff_qualified" class="mr-2">
                  <label class="text-sm font-medium text-gray-700">å–€ç—°å¸å¼•è³‡æ ¼è€…</label>
                </div>
                <div class="flex items-center">
                  <input type="checkbox" id="staff_care_required" class="mr-2">
                  <label class="text-sm font-medium text-gray-700">å‹¤å‹™é…æ…®</label>
                </div>
                <div class="flex items-center">
                  <input type="checkbox" id="staff_active" class="mr-2" checked>
                  <label class="text-sm font-medium text-gray-700">æœ‰åŠ¹</label>
                </div>
              </div>

              <div class="flex space-x-4 mt-6">
                <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">
                  ä¿å­˜
                </button>
                <button type="button" onclick="closeStaffForm()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition">
                  ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ç®¡ç†ç”»é¢ -->
      <div id="shiftMasterView" class="hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold mb-6 text-gray-800">ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ç®¡ç†</h2>

          <div class="mb-4">
            <button onclick="showShiftMasterForm()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">
              + æ–°è¦è¿½åŠ 
            </button>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ã‚·ãƒ•ãƒˆå</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">é–‹å§‹æ™‚é–“</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">çµ‚äº†æ™‚é–“</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">å‚™è€ƒ</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="shiftMasterTableBody" class="bg-white divide-y divide-gray-200">
                <!-- ã“ã“ã«ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ -->
        <div id="shiftMasterFormModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full max-h-screen overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ç·¨é›†</h3>
            <form onsubmit="saveShiftMasterData(event)" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ã‚·ãƒ•ãƒˆID</label>
                <input type="text" id="shift_id" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" readonly>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ã‚·ãƒ•ãƒˆå <span class="text-red-500">*</span></label>
                <input type="text" id="shift_name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">é–‹å§‹æ™‚é–“ (HH:MM)</label>
                  <input type="time" id="shift_start_time" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">çµ‚äº†æ™‚é–“ (HH:MM)</label>
                  <input type="time" id="shift_end_time" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">å‚™è€ƒ</label>
                <textarea id="shift_notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
              </div>

              <div class="flex space-x-4 mt-6">
                <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">
                  ä¿å­˜
                </button>
                <button type="button" onclick="closeShiftMasterForm()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition">
                  ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

    </main>
  </div>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let currentSession = null;
    let selectedDates = [];

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
    window.onload = function() {
      hideLoading();
      showView('login');
    };

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    function showLoading() {
      document.getElementById('loading').classList.remove('hidden');
    }

    function hideLoading() {
      document.getElementById('loading').classList.add('hidden');
    }

    // ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
    function showView(viewName) {
      // ãƒã‚¤ãƒ•ãƒ³åŒºåˆ‡ã‚Šã®åå‰ã‚’ã‚­ãƒ£ãƒ¡ãƒ«ã‚±ãƒ¼ã‚¹ã®IDã«å¤‰æ›
      const viewIdMap = {
        'login': 'loginView',
        'holiday-request': 'holidayRequestView',
        'staff-master': 'staffMasterView',
        'shift-master': 'shiftMasterView'
      };

      const viewId = viewIdMap[viewName] || viewName;

      const views = ['loginView', 'holidayRequestView', 'staffMasterView', 'shiftMasterView'];
      views.forEach(v => {
        document.getElementById(v).classList.add('hidden');
      });

      if (viewName === 'login') {
        document.getElementById('loginView').classList.remove('hidden');
        document.getElementById('app').classList.remove('hidden');
        document.getElementById('userInfo').classList.add('hidden');
        document.getElementById('adminNav').classList.add('hidden');
      } else {
        document.getElementById(viewId).classList.remove('hidden');
        document.getElementById('app').classList.remove('hidden');
        document.getElementById('userInfo').classList.remove('hidden');

        if (currentSession && currentSession.isAdmin) {
          document.getElementById('adminNav').classList.remove('hidden');
        }

        // ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºæ™‚ã®å‡¦ç†
        if (viewId === 'holidayRequestView') {
          initHolidayRequestView();
        } else if (viewId === 'staffMasterView') {
          loadStaffList();
        } else if (viewId === 'shiftMasterView') {
          loadShiftMasterList();
        }
      }
    }

    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    function handleLogin(event) {
      event.preventDefault();
      showLoading();

      const loginId = document.getElementById('loginId').value;
      const password = document.getElementById('loginPassword').value;

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            currentSession = result.session;
            document.getElementById('userName').textContent = result.session.name;
            document.getElementById('loginError').classList.add('hidden');
            showView('holiday-request');
          } else {
            document.getElementById('loginError').textContent = result.message;
            document.getElementById('loginError').classList.remove('hidden');
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          document.getElementById('loginError').textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
          document.getElementById('loginError').classList.remove('hidden');
          console.error(error);
        })
        .apiLogin(loginId, password);
    }

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    function logout() {
      showLoading();
      google.script.run
        .withSuccessHandler(function() {
          currentSession = null;
          hideLoading();
          showView('login');
        })
        .withFailureHandler(function(error) {
          hideLoading();
          console.error(error);
        })
        .apiLogout();
    }

    // ä¼‘ã¿å¸Œæœ›æå‡ºç”»é¢ã®åˆæœŸåŒ–
    function initHolidayRequestView() {
      const now = new Date();
      const targetMonth = document.getElementById('targetMonth');
      targetMonth.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      loadHolidayRequest();
    }

    // ä¼‘ã¿å¸Œæœ›èª­ã¿è¾¼ã¿
    function loadHolidayRequest() {
      const targetMonth = document.getElementById('targetMonth').value;
      if (!targetMonth) return;

      const [year, month] = targetMonth.split('-').map(Number);

      showLoading();

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            renderCalendar(year, month, result.data);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          console.error(error);
        })
        .apiGetHolidayRequest(currentSession.name, year, month);

      // ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
      checkSubmissionLock(year, month);

      // å…¬ä¼‘ä¸Šé™ã‚’è¡¨ç¤º
      displayHolidayLimit(year, month);
    }

    // å…¬ä¼‘ä¸Šé™ã‚’è¡¨ç¤º
    function displayHolidayLimit(year, month) {
      const configKey = `MONTHLY_HOLIDAYS_${year}${String(month).padStart(2, '0')}`;

      google.script.run
        .withSuccessHandler(function(result) {
          const maxHolidays = result.value ? parseFloat(result.value) : 9;
          const daysInMonth = new Date(year, month, 0).getDate();

          // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ä¸Šã«æƒ…å ±ã‚’è¡¨ç¤º
          const calendar = document.getElementById('calendar');
          const infoDiv = document.createElement('div');
          infoDiv.className = 'mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm';
          infoDiv.innerHTML = `
            <p class="font-semibold text-blue-800">ğŸ“… ${year}å¹´${month}æœˆã®æƒ…å ±</p>
            <p class="text-blue-700">â€¢ æš¦æ—¥æ•°: ${daysInMonth}æ—¥</p>
            <p class="text-blue-700">â€¢ æœˆé–“å…¬ä¼‘ä¸Šé™: <span class="font-bold text-lg">${maxHolidays}æ—¥</span></p>
            <p class="text-blue-700">â€¢ ç¾åœ¨é¸æŠä¸­: <span id="selectedCount" class="font-bold text-lg">${selectedDates.length}æ—¥</span></p>
          `;

          // æ—¢å­˜ã®æƒ…å ±è¡¨ç¤ºãŒã‚ã‚Œã°å‰Šé™¤
          const existingInfo = calendar.previousElementSibling;
          if (existingInfo && existingInfo.classList.contains('bg-blue-50')) {
            existingInfo.remove();
          }

          calendar.parentNode.insertBefore(infoDiv, calendar);
        })
        .apiGetConfig(configKey);
    }

    // æå‡ºãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
    function checkSubmissionLock(year, month) {
      const lockKey = `SUBMISSION_LOCK_${year}${String(month).padStart(2, '0')}`;

      google.script.run
        .withSuccessHandler(function(result) {
          const isLocked = result.value === 'TRUE' || result.value === true;
          const lockMessage = document.getElementById('lockMessage');
          const saveButton = document.getElementById('saveButton');

          if (isLocked) {
            lockMessage.classList.remove('hidden');
            saveButton.disabled = true;
            saveButton.classList.add('opacity-50', 'cursor-not-allowed');
          } else {
            lockMessage.classList.add('hidden');
            saveButton.disabled = false;
            saveButton.classList.remove('opacity-50', 'cursor-not-allowed');
          }
        })
        .apiGetConfig(lockKey);
    }

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
    function renderCalendar(year, month, existingRequests) {
      const calendarDiv = document.getElementById('calendar');
      calendarDiv.innerHTML = '';

      selectedDates = existingRequests.map(req => new Date(req['æ—¥ä»˜']).getDate());

      const daysInMonth = new Date(year, month, 0).getDate();
      const firstDay = new Date(year, month - 1, 1).getDay();

      let html = '<div class="grid grid-cols-7 gap-2">';

      // æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼
      const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      dayNames.forEach((name, index) => {
        const color = index === 0 ? 'text-red-600' : index === 6 ? 'text-blue-600' : 'text-gray-700';
        html += `<div class="text-center font-bold ${color}">${name}</div>`;
      });

      // ç©ºç™½ã‚»ãƒ«
      for (let i = 0; i < firstDay; i++) {
        html += '<div></div>';
      }

      // æ—¥ä»˜ã‚»ãƒ«
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month - 1, day);
        const dayOfWeek = date.getDay();
        const isSelected = selectedDates.includes(day);

        let bgColor = isSelected ? 'bg-blue-500 text-white' : 'bg-white hover:bg-blue-100';
        let textColor = dayOfWeek === 0 ? 'text-red-600' : dayOfWeek === 6 ? 'text-blue-600' : 'text-gray-700';

        if (isSelected) {
          textColor = 'text-white';
        }

        html += `<div class="calendar-day ${isSelected ? 'selected' : ''} ${bgColor} ${textColor} border border-gray-300 rounded p-2 text-center"
                     onclick="toggleDate(${day})">
                  ${day}
                </div>`;
      }

      html += '</div>';
      calendarDiv.innerHTML = html;
    }

    // æ—¥ä»˜é¸æŠãƒˆã‚°ãƒ«
    function toggleDate(day) {
      const index = selectedDates.indexOf(day);
      if (index >= 0) {
        selectedDates.splice(index, 1);
      } else {
        selectedDates.push(day);
      }

      const targetMonth = document.getElementById('targetMonth').value;
      const [year, month] = targetMonth.split('-').map(Number);
      renderCalendar(year, month, selectedDates.map(d => ({ 'æ—¥ä»˜': new Date(year, month - 1, d) })));

      // é¸æŠä¸­ã®æ—¥æ•°ã‚’æ›´æ–°
      const selectedCountElem = document.getElementById('selectedCount');
      if (selectedCountElem) {
        selectedCountElem.textContent = `${selectedDates.length}æ—¥`;
      }
    }

    // ä¼‘ã¿å¸Œæœ›ä¿å­˜ï¼ˆä¸Šé™ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
    function saveHolidayRequest() {
      if (selectedDates.length === 0) {
        alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      const targetMonth = document.getElementById('targetMonth').value;
      const [year, month] = targetMonth.split('-').map(Number);
      const notes = document.getElementById('requestNotes').value;

      // ä¸Šé™ãƒã‚§ãƒƒã‚¯: æœˆé–“å…¬ä¼‘æ•°ã‚’å–å¾—
      const configKey = `MONTHLY_HOLIDAYS_${year}${String(month).padStart(2, '0')}`;

      showLoading();

      // ã¾ãšå…¬ä¼‘æ•°ã®ä¸Šé™ã‚’å–å¾—
      google.script.run
        .withSuccessHandler(function(configResult) {
          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ9æ—¥
          const maxHolidays = configResult.value ? parseFloat(configResult.value) : 9;

          // ä¸Šé™ãƒã‚§ãƒƒã‚¯
          if (selectedDates.length > maxHolidays) {
            hideLoading();
            alert(`âš ï¸ ä¼‘ã¿ã™ãã§ã™ï¼\n\né¸æŠã•ã‚ŒãŸæ—¥æ•°: ${selectedDates.length}æ—¥\næœˆé–“å…¬ä¼‘ä¸Šé™: ${maxHolidays}æ—¥\n\nå…¬ä¼‘ä¸Šé™ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚æ—¥æ•°ã‚’æ¸›ã‚‰ã—ã¦ãã ã•ã„ã€‚`);
            return;
          }

          // ä¸Šé™å†…ãªã®ã§ä¿å­˜å‡¦ç†ã‚’å®Ÿè¡Œ
          const dateList = selectedDates.map(day => {
            const date = new Date(year, month - 1, day);
            return date.toISOString();
          });

          google.script.run
            .withSuccessHandler(function(result) {
              hideLoading();
              if (result && result.success) {
                showMessage('holidayMessage', result.message, 'success');
              } else {
                showMessage('holidayMessage', result ? result.message : 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
              }
            })
            .withFailureHandler(function(error) {
              hideLoading();
              showMessage('holidayMessage', 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
              console.error(error);
            })
            .apiSaveHolidayRequest(currentSession.name, dateList, notes);
        })
        .withFailureHandler(function(error) {
          hideLoading();
          console.error('è¨­å®šå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤9æ—¥ã§ç¶šè¡Œ
          if (selectedDates.length > 9) {
            alert(`âš ï¸ ä¼‘ã¿ã™ãã§ã™ï¼\n\né¸æŠã•ã‚ŒãŸæ—¥æ•°: ${selectedDates.length}æ—¥\nãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå…¬ä¼‘ä¸Šé™: 9æ—¥\n\nå…¬ä¼‘ä¸Šé™ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚æ—¥æ•°ã‚’æ¸›ã‚‰ã—ã¦ãã ã•ã„ã€‚`);
            return;
          }

          // ä¿å­˜å‡¦ç†ã‚’å®Ÿè¡Œ
          const dateList = selectedDates.map(day => {
            const date = new Date(year, month - 1, day);
            return date.toISOString();
          });

          google.script.run
            .withSuccessHandler(function(result) {
              hideLoading();
              if (result && result.success) {
                showMessage('holidayMessage', result.message, 'success');
              } else {
                showMessage('holidayMessage', result ? result.message : 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
              }
            })
            .withFailureHandler(function(error) {
              hideLoading();
              showMessage('holidayMessage', 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
              console.error(error);
            })
            .apiSaveHolidayRequest(currentSession.name, dateList, notes);
        })
        .apiGetConfig(configKey);
    }

    // ä¼‘ã¿å¸Œæœ›ã‚¯ãƒªã‚¢
    function clearHolidayRequest() {
      selectedDates = [];
      const targetMonth = document.getElementById('targetMonth').value;
      const [year, month] = targetMonth.split('-').map(Number);
      renderCalendar(year, month, []);
      document.getElementById('requestNotes').value = '';
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function showMessage(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.textContent = message;
      element.className = type === 'success' ? 'p-4 bg-green-100 text-green-800 rounded-lg' : 'p-4 bg-red-100 text-red-800 rounded-lg';
      element.classList.remove('hidden');

      setTimeout(() => {
        element.classList.add('hidden');
      }, 3000);
    }

    // è·å“¡ä¸€è¦§èª­ã¿è¾¼ã¿
    function loadStaffList() {
      showLoading();

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            renderStaffTable(result.data);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          console.error(error);
        })
        .apiGetAllStaff();
    }

    // è·å“¡ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    function renderStaffTable(staffList) {
      const tbody = document.getElementById('staffTableBody');
      tbody.innerHTML = '';

      staffList.forEach(staff => {
        const row = `<tr>
          <td class="px-4 py-3">${staff['æ°å']}</td>
          <td class="px-4 py-3">${staff['å½¹è·']}</td>
          <td class="px-4 py-3">${staff['ã‚°ãƒ«ãƒ¼ãƒ—']}</td>
          <td class="px-4 py-3">${staff['é›‡ç”¨å½¢æ…‹']}</td>
          <td class="px-4 py-3">${staff['æœ‰åŠ¹'] ? 'âœ“' : ''}</td>
          <td class="px-4 py-3">
            <button onclick='editStaff(${JSON.stringify(staff).replace(/'/g, "&#39;")})' class="text-blue-600 hover:underline">
              ç·¨é›†
            </button>
          </td>
        </tr>`;
        tbody.innerHTML += row;
      });
    }

    // è·å“¡ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
    function showStaffForm() {
      document.getElementById('staffFormModal').classList.remove('hidden');
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
      document.getElementById('staff_id').value = 'STAFF_' + Date.now();
      document.getElementById('staff_name').value = '';
      document.getElementById('staff_role').value = '';
      document.getElementById('staff_group').value = '1';
      document.getElementById('staff_employment').value = 'å¸¸å‹¤';
      document.getElementById('staff_login_id').value = '';
      document.getElementById('staff_password').value = '';
      document.getElementById('staff_calendar_id').value = '';
      document.getElementById('staff_priority').value = 3;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ä¸€èˆ¬è·å“¡
      document.getElementById('staff_qualified').checked = false;
      document.getElementById('staff_care_required').checked = false;
      document.getElementById('staff_active').checked = true;
    }

    // è·å“¡ç·¨é›†
    function editStaff(staff) {
      document.getElementById('staffFormModal').classList.remove('hidden');
      document.getElementById('staff_id').value = staff['è·å“¡ID'];
      document.getElementById('staff_name').value = staff['æ°å'];
      document.getElementById('staff_role').value = staff['å½¹è·'];
      document.getElementById('staff_group').value = staff['ã‚°ãƒ«ãƒ¼ãƒ—'];
      document.getElementById('staff_employment').value = staff['é›‡ç”¨å½¢æ…‹'];
      document.getElementById('staff_login_id').value = staff['ãƒ­ã‚°ã‚¤ãƒ³ID'];
      document.getElementById('staff_password').value = staff['ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰'];
      document.getElementById('staff_calendar_id').value = staff['ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID'];
      document.getElementById('staff_priority').value = staff['å„ªå…ˆé †ä½'] || 3;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ3
      document.getElementById('staff_qualified').checked = staff['å–€ç—°å¸å¼•è³‡æ ¼è€…'];
      document.getElementById('staff_care_required').checked = staff['å‹¤å‹™é…æ…®'];
      document.getElementById('staff_active').checked = staff['æœ‰åŠ¹'];
    }

    // è·å“¡ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‰ã˜ã‚‹
    function closeStaffForm() {
      document.getElementById('staffFormModal').classList.add('hidden');
    }

    // è·å“¡ãƒ‡ãƒ¼ã‚¿ä¿å­˜
    function saveStaffData(event) {
      event.preventDefault();
      showLoading();

      const staffData = {
        'è·å“¡ID': document.getElementById('staff_id').value,
        'æ°å': document.getElementById('staff_name').value,
        'å½¹è·': document.getElementById('staff_role').value,
        'ã‚°ãƒ«ãƒ¼ãƒ—': document.getElementById('staff_group').value,
        'é›‡ç”¨å½¢æ…‹': document.getElementById('staff_employment').value,
        'ãƒ­ã‚°ã‚¤ãƒ³ID': document.getElementById('staff_login_id').value,
        'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰': document.getElementById('staff_password').value,
        'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID': document.getElementById('staff_calendar_id').value,
        'å„ªå…ˆé †ä½': parseInt(document.getElementById('staff_priority').value) || 3,
        'å–€ç—°å¸å¼•è³‡æ ¼è€…': document.getElementById('staff_qualified').checked,
        'å‹¤å‹™é…æ…®': document.getElementById('staff_care_required').checked,
        'æœ‰åŠ¹': document.getElementById('staff_active').checked
      };

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          closeStaffForm();
          if (result.success) {
            loadStaffList();
          } else {
            alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
          console.error(error);
        })
        .apiSaveStaff(staffData);
    }

    // ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ä¸€è¦§èª­ã¿è¾¼ã¿
    function loadShiftMasterList() {
      showLoading();

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result && result.success) {
            renderShiftMasterTable(result.data);
          } else {
            alert('ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result ? result.message : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
          console.error(error);
        })
        .apiGetAllShiftMaster();
    }

    // ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    function renderShiftMasterTable(shiftList) {
      const tbody = document.getElementById('shiftMasterTableBody');
      tbody.innerHTML = '';

      shiftList.forEach(shift => {
        const row = `<tr>
          <td class="px-4 py-3">${shift['ã‚·ãƒ•ãƒˆå']}</td>
          <td class="px-4 py-3">${shift['é–‹å§‹æ™‚é–“']}</td>
          <td class="px-4 py-3">${shift['çµ‚äº†æ™‚é–“']}</td>
          <td class="px-4 py-3">${shift['å‚™è€ƒ']}</td>
          <td class="px-4 py-3">
            <button onclick='editShiftMaster(${JSON.stringify(shift).replace(/'/g, "&#39;")})' class="text-blue-600 hover:underline mr-3">
              ç·¨é›†
            </button>
            <button onclick='deleteShiftMaster("${shift['ã‚·ãƒ•ãƒˆID']}", "${shift['ã‚·ãƒ•ãƒˆå']}")' class="text-red-600 hover:underline">
              å‰Šé™¤
            </button>
          </td>
        </tr>`;
        tbody.innerHTML += row;
      });
    }

    // ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºï¼ˆæ–°è¦ï¼‰
    function showShiftMasterForm() {
      document.getElementById('shiftMasterFormModal').classList.remove('hidden');
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
      document.getElementById('shift_id').value = 'SHIFT_' + Date.now();
      document.getElementById('shift_name').value = '';
      document.getElementById('shift_start_time').value = '';
      document.getElementById('shift_end_time').value = '';
      document.getElementById('shift_notes').value = '';
    }

    // ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºï¼ˆæ—¢å­˜ï¼‰
    function editShiftMaster(shift) {
      document.getElementById('shiftMasterFormModal').classList.remove('hidden');
      document.getElementById('shift_id').value = shift['ã‚·ãƒ•ãƒˆID'];
      document.getElementById('shift_name').value = shift['ã‚·ãƒ•ãƒˆå'];
      document.getElementById('shift_start_time').value = shift['é–‹å§‹æ™‚é–“'];
      document.getElementById('shift_end_time').value = shift['çµ‚äº†æ™‚é–“'];
      document.getElementById('shift_notes').value = shift['å‚™è€ƒ'];
    }

    // ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‰ã˜ã‚‹
    function closeShiftMasterForm() {
      document.getElementById('shiftMasterFormModal').classList.add('hidden');
    }

    // ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ä¿å­˜
    function saveShiftMasterData(event) {
      event.preventDefault();
      showLoading();

      const shiftData = {
        'ã‚·ãƒ•ãƒˆID': document.getElementById('shift_id').value,
        'ã‚·ãƒ•ãƒˆå': document.getElementById('shift_name').value,
        'é–‹å§‹æ™‚é–“': document.getElementById('shift_start_time').value,
        'çµ‚äº†æ™‚é–“': document.getElementById('shift_end_time').value,
        'å‚™è€ƒ': document.getElementById('shift_notes').value
      };

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          closeShiftMasterForm();
          if (result.success) {
            loadShiftMasterList();
          } else {
            alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
          console.error(error);
        })
        .apiSaveShiftMaster(shiftData);
    }

    // ã‚·ãƒ•ãƒˆãƒã‚¹ã‚¿å‰Šé™¤
    function deleteShiftMaster(shiftId, shiftName) {
      if (!confirm(`ã‚·ãƒ•ãƒˆã€Œ${shiftName}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
        return;
      }

      showLoading();

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            loadShiftMasterList();
          } else {
            alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
          console.error(error);
        })
        .apiDeleteShiftMaster(shiftId);
    }
  </script>

</body>
</html>
