# 新・シフト作成システム 導入手順書

**対象:** システム管理者
**所要時間:** 約30分
**難易度:** 中級

---

## 📋 目次

1. [前提条件](#前提条件)
2. [準備するもの](#準備するもの)
3. [導入手順](#導入手順)
   - [Phase 1: Google Drive準備](#phase-1-google-drive準備)
   - [Phase 2: GASプロジェクト設定](#phase-2-gasプロジェクト設定)
   - [Phase 3: Python環境準備](#phase-3-python環境準備)
   - [Phase 4: 動作確認](#phase-4-動作確認)
4. [トラブルシューティング](#トラブルシューティング)
5. [導入チェックリスト](#導入チェックリスト)

---

## 前提条件

### 必須アカウント
- [ ] Google Workspaceアカウント（管理者権限）
- [ ] Google Driveアクセス権限
- [ ] Google Colabアクセス権限

### 必要な知識
- [ ] Googleスプレッドシートの基本操作
- [ ] Google Driveのフォルダ・ファイル管理
- [ ] Google Apps Scriptの基本（コピー＆ペーストができればOK）
- [ ] Google Colabの基本操作

### 推奨環境
- ブラウザ: Chrome最新版
- ネットワーク: 安定したインターネット接続

---

## 準備するもの

### 1. テキストエディタ
メモ帳やテキストエディタを用意してください。以下の情報を記録します：

```
■ Driveフォルダ情報
- inputフォルダID:
- outputフォルダID:
- archiveフォルダID:

■ Webhook情報
- GAS Webアプリ URL:
- Webhookトークン:

■ その他
- スプレッドシートURL:
```

---

## 導入手順

## Phase 1: Google Drive準備

### Step 1-1: フォルダ作成

1. **Google Driveを開く**
   - https://drive.google.com/ にアクセス

2. **フォルダ構造を作成**
   ```
   右クリック → 「新しいフォルダ」
   ```

   以下の構造で作成：
   ```
   シフト管理システム/
   ├── input/
   ├── output/
   └── archive/
   ```

3. **フォルダIDを取得**

   各フォルダを開いて、URLからIDを取得：
   ```
   https://drive.google.com/drive/folders/1aBcDeFgHiJkLmNoPqRsTuVwXyZ
                                            ↑この部分がフォルダID
   ```

   取得したIDをメモ帳に記録：
   ```
   inputフォルダID: 1aBcDeFgHiJkLmNoPqRsTuVwXyZ
   outputフォルダID: 2BcDeFgHiJkLmNoPqRsTuVwXyZ
   archiveフォルダID: 3CdEfGhIjKlMnOpQrStUvWxYz
   ```

### Step 1-2: アクセス権限設定

1. **各フォルダの共有設定**
   ```
   フォルダを右クリック → 「共有」
   ```

2. **必要なユーザーを追加**
   - システム管理者
   - GASスクリプト実行アカウント
   - （必要に応じて）施設管理者

3. **権限レベル**
   - 管理者: 「編集者」
   - 閲覧のみ必要な場合: 「閲覧者」

---

## Phase 2: GASプロジェクト設定

### Step 2-1: スプレッドシート作成

1. **新規スプレッドシート作成**
   - Google Driveで「新規」→「Googleスプレッドシート」

2. **名前を変更**
   ```
   例: 「シフト管理システム v2.0」
   ```

3. **スプレッドシートURLを記録**
   ```
   https://docs.google.com/spreadsheets/d/1XxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxX/edit
   ```

### Step 2-2: GASコードのデプロイ

1. **Apps Scriptエディタを開く**
   ```
   スプレッドシート → 拡張機能 → Apps Script
   ```

2. **コードファイルを追加**

   左側のファイルツリーで「+」→「スクリプト」

   以下のファイルを順番に作成：
   ```
   01_Config.gs
   02_DataService.gs
   03_AuthService.gs
   04_ShiftService.gs
   05_CalendarService.gs
   06_Code.gs
   07_index.html
   08_CSVService.gs
   ```

3. **各ファイルのコードをコピー＆ペースト**

   GitHubリポジトリまたはローカルファイルから各コードをコピーして貼り付け

4. **保存**
   ```
   Ctrl + S（Windows）または Cmd + S（Mac）
   ```

### Step 2-3: 初期設定の実行

1. **スプレッドシートに戻る**

2. **ページをリロード**
   ```
   F5 キーまたはブラウザの更新ボタン
   ```

3. **カスタムメニューが表示されることを確認**
   ```
   メニューバーに「📅 シフト管理」が表示される
   ```

4. **初期設定を実行**
   ```
   📅 シフト管理 → ⚙️ 設定 → 🔧 初期設定
   ```

   - 承認ダイアログが表示されたら「続行」
   - 権限を付与

5. **シートが自動作成されることを確認**
   ```
   作成されるシート:
   - M_職員
   - M_シフト
   - T_シフト休み希望
   - T_確定シフト
   - M_設定
   ```

### Step 2-4: Drive設定

1. **Drive設定を実行**
   ```
   📅 シフト管理 → ⚙️ 設定 → 📁 Drive設定
   ```

2. **フォルダIDを入力**

   **ダイアログ 1/4: inputフォルダID**
   ```
   メモ帳から inputフォルダID をコピー＆ペースト
   ```

   **ダイアログ 2/4: outputフォルダID**
   ```
   メモ帳から outputフォルダID をコピー＆ペースト
   ```

   **ダイアログ 3/4: archiveフォルダID**
   ```
   メモ帳から archiveフォルダID をコピー＆ペースト
   ```

   **ダイアログ 4/4: Webhookトークン**
   ```
   任意の文字列を入力（推奨: 20文字以上のランダム文字列）
   例: shift-webhook-2025-abc123xyz

   ⚠️ このトークンをメモ帳に記録してください
   ```

3. **設定完了メッセージを確認**

### Step 2-5: Webアプリのデプロイ

1. **Apps Scriptエディタに戻る**

2. **デプロイを実行**
   ```
   右上の「デプロイ」→「新しいデプロイ」
   ```

3. **デプロイ設定**

   **種類を選択:**
   ```
   歯車アイコン（⚙️）→「ウェブアプリ」を選択
   ```

   **説明:**
   ```
   例: シフト管理システム v2.0
   ```

   **次のユーザーとして実行:**
   ```
   「自分」を選択
   ```

   **アクセスできるユーザー:**
   ```
   「全員」を選択
   ※組織内のみに制限する場合は「組織内のユーザー」
   ```

4. **デプロイを実行**
   ```
   「デプロイ」ボタンをクリック
   ```

5. **承認プロセス**

   初回デプロイ時に承認が必要：
   ```
   「アクセスを承認」→ アカウント選択 → 「許可」
   ```

6. **Webアプリ URLを取得**

   デプロイ完了後、URLが表示される：
   ```
   https://script.google.com/macros/s/AKfycby.../exec

   ⚠️ このURLをメモ帳に記録してください
   ```

### Step 2-6: 月間公休日数の設定

1. **M_設定シートを開く**

2. **設定を追加**

   | 設定ID | 設定値 |
   |--------|--------|
   | MONTHLY_HOLIDAYS_202501 | 9 |
   | MONTHLY_HOLIDAYS_202502 | 9 |
   | MONTHLY_HOLIDAYS_202503 | 9 |

   ※月ごとに設定が必要

---

## Phase 3: Python環境準備

### Step 3-1: Google Colabでノートブック作成

1. **Google Colabを開く**
   - https://colab.research.google.com/

2. **新しいノートブック作成**
   ```
   ファイル → ノートブックを新規作成
   ```

3. **名前を変更**
   ```
   例: 「シフト計算_v2.0」
   ```

### Step 3-2: サンプルコードのコピー

1. **`colab_integration_sample.py` を開く**

   GitHubリポジトリまたはローカルファイルから取得

2. **Colabのセルにコピー**

   全コードを1つのセルにコピー＆ペースト

### Step 3-3: 設定値の編集

コード内の以下の定数を編集：

```python
# GASのWebアプリURL（Step 2-5で取得）
GAS_WEBHOOK_URL = 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec'

# Webhookトークン（Step 2-4で設定した値）
WEBHOOK_TOKEN = 'shift-webhook-2025-abc123xyz'

# DriveフォルダID（Step 1-1で取得）
INPUT_FOLDER_ID = '1aBcDeFgHiJkLmNoPqRsTuVwXyZ'
OUTPUT_FOLDER_ID = '2BcDeFgHiJkLmNoPqRsTuVwXyZ'
```

### Step 3-4: Drive認証テスト

1. **認証セルを実行**

   以下のコードを新しいセルに貼り付けて実行：
   ```python
   from google.colab import auth
   auth.authenticate_user()
   print('認証成功！')
   ```

2. **Googleアカウントで認証**

   表示されるダイアログに従って認証

---

## Phase 4: 動作確認

### Step 4-1: 職員マスタ登録

1. **Webアプリを開く**
   ```
   📅 シフト管理 → 🌐 Webアプリを開く
   ```

2. **管理者ユーザーを登録**

   まず、M_職員シートに直接入力：

   | 職員ID | 氏名 | 役職 | グループ | ログインID | パスワード | 有効 |
   |--------|------|------|----------|------------|------------|------|
   | STAFF_001 | 管理者 | 管理者 | 1 | admin | admin123 | TRUE |

3. **ログインテスト**
   ```
   ID: admin
   PW: admin123
   ```

### Step 4-2: 休み希望のテスト

1. **テストデータ入力**

   Webアプリで休み希望を数件入力

2. **CSV出力テスト**
   ```
   📅 シフト管理 → 📤 CSV連携 → 📤 休み希望CSV出力
   ```

   対象年月: `2025/01`

3. **Drive確認**

   `input/` フォルダに `T_休み希望_202501.csv` が作成されることを確認

### Step 4-3: Python計算のテスト

1. **Colabでmain関数を実行**
   ```python
   main(2025, 1)
   ```

2. **実行結果を確認**
   ```
   ✅ すべての処理が完了しました！
   ```

3. **Drive確認**

   `output/` フォルダに `シフト結果_202501.csv` が作成されることを確認

### Step 4-4: CSV取込テスト

1. **ファイルIDを取得**

   `output/` フォルダの `シフト結果_202501.csv` を開き、URLからIDを取得

2. **CSV取込を実行**
   ```
   📅 シフト管理 → 📤 CSV連携 → 📥 シフト結果CSV取込
   ```

   ファイルIDを入力

3. **シフト作業用シートを確認**

   データが正しく反映されているか確認

### Step 4-5: ルールチェックテスト

1. **ルールチェック実行**
   ```
   📅 シフト管理 → ✅ ルールチェック
   ```

   対象年月: `2025/01`
   ルール: `ALL`

2. **違反箇所を確認**

   セルコメントで違反内容が表示される

### Step 4-6: カレンダー登録テスト

⚠️ **注意:** この手順は実際のカレンダーに反映されます。テスト用カレンダーで実施することを推奨。

1. **職員にカレンダーIDを設定**

   M_職員シートでカレンダーIDを入力

2. **シフト登録実行**
   ```
   📅 シフト管理 → 📝 シフト登録
   ```

   対象年月: `2025/01`
   グループ: `1`（テスト用）

3. **カレンダー確認**

   指定したカレンダーにイベントが登録されることを確認

---

## トラブルシューティング

### Q1: カスタムメニューが表示されない

**原因:** スクリプトが正しく読み込まれていない

**対処法:**
1. ページをリロード（F5）
2. Apps Scriptエディタで保存を確認
3. スクリプトの実行権限を確認

---

### Q2: CSV出力で「設定キーが見つかりません」エラー

**原因:** DriveフォルダIDが設定されていない

**対処法:**
1. M_設定シートで `DRIVE_FOLDER_INPUT` などが登録されているか確認
2. Drive設定を再実行

---

### Q3: Webhook通知が失敗する（401エラー）

**原因:** Webhookトークンが一致していない

**対処法:**
1. GAS側: M_設定シートまたはスクリプトプロパティで確認
2. Python側: `WEBHOOK_TOKEN` の値を確認
3. 両者を一致させる

---

### Q4: CSV取込で「形式エラー」

**原因:** CSVのヘッダーまたはデータ形式が不正

**対処法:**
1. CSVをダウンロードして確認
2. ヘッダーが以下と一致しているか確認：
   ```
   氏名,グループ,日付,シフト名,開始時間,終了時間
   ```
3. Python側のCSV出力処理を確認

---

### Q5: Drive認証が失敗する

**原因:** 権限が付与されていない

**対処法:**
1. GAS: Apps Scriptエディタで「実行」→「承認」
2. Python: `auth.authenticate_user()` を再実行
3. 組織のポリシー制限を確認

---

## 導入チェックリスト

### Phase 1: Drive準備
- [ ] inputフォルダ作成
- [ ] outputフォルダ作成
- [ ] archiveフォルダ作成
- [ ] 各フォルダIDを取得・記録
- [ ] アクセス権限設定

### Phase 2: GAS設定
- [ ] スプレッドシート作成
- [ ] GASコードを全ファイルコピー
- [ ] 初期設定実行（シート自動作成）
- [ ] Drive設定実行（フォルダID登録）
- [ ] Webアプリデプロイ
- [ ] Webアプリ URL取得・記録
- [ ] 月間公休日数設定

### Phase 3: Python準備
- [ ] Google Colabノートブック作成
- [ ] サンプルコード貼り付け
- [ ] 設定値編集（URL、トークン、フォルダID）
- [ ] Drive認証完了

### Phase 4: 動作確認
- [ ] 管理者ユーザー登録
- [ ] ログインテスト成功
- [ ] 休み希望入力テスト
- [ ] CSV出力テスト成功
- [ ] Python計算テスト成功
- [ ] CSV取込テスト成功
- [ ] ルールチェックテスト成功
- [ ] カレンダー登録テスト成功

### 最終確認
- [ ] すべてのURL・ID・トークンを安全に保管
- [ ] ユーザーマニュアル作成
- [ ] 職員への説明資料準備
- [ ] バックアッププラン策定

---

## 📞 サポート情報

**導入でお困りの場合:**
- GitHub Issues: [リポジトリURL]/issues
- ドキュメント参照: `MIGRATION_GUIDE.md`, `README.md`

**所要時間の目安:**
- Phase 1: 10分
- Phase 2: 15分
- Phase 3: 5分
- Phase 4: 10分

---

## 📝 次のステップ

導入が完了したら、以下のドキュメントを参照してください：

1. **運用マニュアル** - 日常的な運用手順
2. **MIGRATION_GUIDE.md** - 詳細な技術情報
3. **Python最適化アルゴリズム** - シフト計算ロジックのカスタマイズ

---

**最終更新:** 2025-11-28
**バージョン:** v2.0
