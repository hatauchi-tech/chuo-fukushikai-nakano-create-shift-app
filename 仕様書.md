# シフト管理自動化システム 仕様書 v3.0

**作成日**: 2026-02-23
**対象施設**: 中央福祉会 中野
**システム名**: シフト管理自動化システム

---

## 1. システム概要

### 1.1 目的
介護施設におけるシフト作成業務を自動化し、手作業による集計ミスやルール違反を防止する。

### 1.2 対象規模
| 項目 | 数値 |
|------|------|
| 職員数 | 61名 |
| グループ数 | 6 |
| 喀痰吸引資格者 | 14名 |
| 勤務配慮あり | 10名 |
| シフト種別 | 5種（早出/日勤/遅出/夜勤/休み） |

### 1.3 システム構成
| コンポーネント | 技術 | 役割 |
|----------------|------|------|
| Webアプリ | GAS Web App (SPA) + Tailwind CSS | UI/UX |
| バックエンドAPI | Google Apps Script | ビジネスロジック |
| シフト最適化 | Python OR-Tools CP-SAT Solver | 自動シフト生成 |
| データストア | Google Spreadsheet | マスタ・トランザクション管理 |
| ファイル連携 | Google Drive (CSV) | Python↔GAS間のデータ受渡 |
| 通知 | Webhook (HTTP POST) | 計算完了通知 |
| カレンダー | Google Calendar API | シフトの可視化 |

---

## 2. 機能仕様

### 2.1 認証機能

| 項目 | 仕様 |
|------|------|
| 認証方式 | ID/パスワード認証 |
| セッション管理 | GAS UserProperties (JSON) |
| セッション構造 | loginId, staffId, name, group, role, isAdmin |
| 権限 | 一般職員 / 管理者（役職=「管理者」で判定） |
| Googleアカウント分離 | Googleアカウント単位でセッションを分離 |

### 2.2 休み希望提出機能

| 項目 | 仕様 |
|------|------|
| 対象ユーザー | 全職員 |
| 入力方式 | カレンダーUI上でクリック選択 |
| 優先順位 | クリック順に第1希望、第2希望...を自動付番 |
| 上限 | 月間公休日数まで（M_設定で定義） |
| 締切制御 | 管理者がロック/アンロック可能 |
| 特記事項 | 各日に自由テキスト入力可能 |

### 2.3 シフト管理機能（管理者）

| 機能 | 仕様 |
|------|------|
| 提出締切設定 | 対象月のロック/アンロック |
| 3種CSV一括出力 | T_休み希望.csv / M_職員.csv / M_設定.csv をDrive input/に保存 |
| シフト結果取込 | output/フォルダからCSV取込（Webhook自動 or 手動） |
| 診断レポート表示 | Python診断結果JSON表示、氏名/グループでフィルター可能 |

### 2.4 シフト修正機能（管理者）

| 機能 | 仕様 |
|------|------|
| データ取得 | 初回のみサーバーから全データ取得 |
| フィルター方式 | クライアントサイド（サーバー通信なし） |
| フィルター項目 | グループ(複数) / ユニット(複数) / 雇用形態(複数) / 喀痰吸引 / 勤務配慮 |
| フィルターUI | チェックボックスグループ（即時反映） |
| 編集保持 | フィルター切替時も編集内容を保持 |
| 資格者表示 | 喀痰吸引資格者の行を黄色背景(#FFFDE7)で表示 |
| 統計表示 | 日別人数集計 + 個人別勤務日数/夜勤回数 |
| 確定方法 | 「確定」（データのみ）/ 「Googleカレンダー登録して確定」 |

### 2.5 職員マスタ管理（管理者）

| フィールド | 型 | 必須 | 備考 |
|-----------|------|------|------|
| 職員ID | Text | 自動生成 | STAFF_タイムスタンプ形式 |
| 氏名 | Text | YES | |
| 役職 | Text | YES | 「管理者」で管理者権限 |
| グループ | Enum(1-6) | YES | シフトグループ |
| ユニット | Text | NO | |
| 雇用形態 | Enum | YES | 常勤/パート |
| ログインID | Text | YES | 一意制約 |
| パスワード | Text | YES | |
| カレンダーID | Text | NO | Googleカレンダー連携用 |
| 喀痰吸引資格者 | Bool | YES | 法定配置チェック対象 |
| 勤務配慮 | Bool | YES | TRUE=夜勤免除 |
| 有効 | Bool | YES | FALSE=ログイン不可・シフト対象外 |

### 2.6 勤務指定機能（管理者）

| 項目 | 仕様 |
|------|------|
| 目的 | 自動シフト作成前に特定の職員・日付のシフトを固定 |
| 入力 | 職員 + 日付 + シフト種別 |
| 出力 | M_設定.csv に含まれてPythonに渡される |
| Python処理 | 固定シフトとして制約に組み込み |

### 2.7 マニュアル機能

| 項目 | 仕様 |
|------|------|
| アクセス | 全職員（ヘッダーのマニュアルボタン） |
| セクション | 全体の流れ / 職員向け / 管理者向け / シフト自動作成 / シフトルール / FAQ |
| セクション切替 | タブ式ナビゲーション |

---

## 3. シフト最適化仕様（Python）

### 3.1 入力データ

| CSV | 内容 |
|-----|------|
| M_職員_YYYYMM.csv | 職員ID/氏名/グループ/雇用形態/資格/配慮/有効 |
| T_休み希望_YYYYMM.csv | 職員ID/氏名/日付/優先順位/特記事項 |
| M_設定_YYYYMM.csv | 公休日数/シフト名/勤務指定 |

### 3.2 処理フロー

```
[1/6] CSV読込・パース
[2/6] 動的シフト名解決（M_設定から SHIFT_*_NAME 取得）
[3/6] 事前診断（preflight_check）
[4/6] グループ別最適化（失敗時は自動緩和リトライ）
[5/6] 施設横断検証 + CSV保存 + 診断レポート保存
[6/6] Webhook通知（完全成功時のみ）
```

### 3.3 制約条件

#### ハード制約（必ず守る）

| # | 制約 | 内容 |
|---|------|------|
| 1 | 公休数 | 暦日数 - 公休数 = 勤務日数 |
| 2 | 連勤制限 | 5連勤まで |
| 3 | 夜勤明け | 夜勤→休→休 |
| 4 | インターバル | 遅出→翌日早出禁止 |
| 5 | 勤務配慮 | 配慮ありは夜勤なし |
| 6 | 1日1シフト | 同日に複数シフト不可 |
| 7 | 第1休み希望 | 必ず休み |
| 8 | 事前勤務指定 | 指定通りに固定 |

#### ソフト制約（ペナルティで最適化）

| # | 制約 | ペナルティ |
|---|------|-----------|
| S1 | グループ別最低人数 | 50/人不足 |
| S2 | 第2希望以降の休み | 100（第2）〜10（下位） |
| S3 | 喀痰吸引資格者の日中配置 | 100/日 |
| S4 | 喀痰吸引資格者の夜勤配置 | 80/日 |

#### グループ別最低人数

| シフト | 平日 | 日曜 |
|--------|------|------|
| 早出 | 2名 | 2名 |
| 日勤 | 1名 | 0名 |
| 遅出 | 1名 | 1名 |
| 夜勤 | 1名 | 1名 |

### 3.4 施設横断検証（ポスト最適化）

グループは独立に最適化されるため、最適化後に施設全体で以下を検証:

| チェック | レベル | 内容 |
|----------|--------|------|
| 日中資格者 | 警告 | 全グループ合算で1名以上の喀痰吸引資格者が勤務しているか |
| 夜勤資格者 | 警告 | 全グループ合算で夜勤に1名以上の資格者がいるか |

### 3.5 夜勤の休日カウント

| シフト表 | 実態 | 公休カウント |
|----------|------|-------------|
| 21日: 夜勤 | 21日夕方〜22日早朝勤務 | 0 |
| 22日: 休み | 夜勤明け（22日早朝まで勤務） | 0 |
| 23日: 休み | 実質公休日 | 1 |

### 3.6 制約緩和モード

RELAXED_MODE=True 時に以下を緩和:

| 制約 | 通常 | 緩和 |
|------|------|------|
| 所定勤務日数 | == N | N ± 2 |
| 早出最低人数 | 2名 | 1名 |
| 日勤最低人数 | 1名 | 0名 |
| 喀痰吸引資格者（グループ内） | 必須 | スキップ |

### 3.7 出力データ

| ファイル | 条件 | 内容 |
|----------|------|------|
| シフト結果_YYYYMM.csv | 全グループ成功 | 確定シフトデータ |
| シフト結果_YYYYMM_partial.csv | 部分成功 | 成功グループのみ |
| 診断レポート_YYYYMM.json | 常に | 診断結果（エラー/警告/統計） |

---

## 4. API仕様

### 4.1 フロントエンド → バックエンド（google.script.run）

| API | 引数 | 戻り値 | 用途 |
|-----|------|--------|------|
| apiLogin | loginId, password | {success, session} | ログイン |
| apiLogout | - | {success} | ログアウト |
| apiCheckSession | - | {success, session} | セッション確認 |
| apiGetHolidayRequests | year, month | {success, data} | 休み希望取得 |
| apiSaveHolidayRequests | year, month, requests | {success} | 休み希望保存 |
| apiGetShiftDataFiltered | year, month, filters | {success, data} | フィルター付きシフト取得 |
| apiGetShiftFilterOptions | - | {success, data} | フィルター選択肢取得 |
| apiUpdateShiftCell | staffId, day, shiftName, year, month | {success} | セル単位更新 |
| apiConfirmShifts | year, month, staffIds | {success} | シフト確定 |
| apiConfirmShiftsAndRegisterCalendar | year, month, staffIds | {success} | 確定+カレンダー |
| apiRunDiagnostics | year, month | {success, data} | ルール診断 |
| apiExportAllCsv | year, month | {success} | 3種CSV出力 |
| apiSaveShiftAssignment | data | {success} | 勤務指定保存 |

### 4.2 Python → GAS（Webhook）

| メソッド | URL | 認証 | ペイロード |
|----------|-----|------|-----------|
| POST | デプロイURL | token (Bearer) | {action: "import_shift_csv", year, month, token} |

---

## 5. セキュリティ仕様

| 項目 | 仕様 |
|------|------|
| 認証 | アプリ独自のID/PW認証 |
| セッション | GAS UserProperties（Googleアカウント単位で分離） |
| XSS対策 | escapeHtml() / textContent使用 |
| Webhook認証 | Bearer Token（スクリプトプロパティ管理） |
| 既知のリスク | パスワード平文保存（M_職員シート） |

---

## 6. 非機能要件

| 項目 | 仕様 |
|------|------|
| 実行環境 | Google Workspace環境 |
| ブラウザ | Chrome最新版推奨 |
| GAS実行制限 | 6分/回（Webhook含む） |
| Python実行 | Google Colab（制限なし） |
| 同時アクセス | GAS UserPropertiesで衝突回避 |
| データバックアップ | スプレッドシート版管理で対応 |
